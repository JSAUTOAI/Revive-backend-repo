<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Schedule - Revive</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Poppins', sans-serif; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #0a0a0a; }
    ::-webkit-scrollbar-thumb { background: #262626; border-radius: 2px; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    /* Prevent zoom on iOS inputs */
    select, input { font-size: 16px !important; }
  </style>
</head>
<body class="bg-black text-neutral-300 min-h-screen">

<!-- ===== LOADING / ERROR ===== -->
<div id="loadingScreen" class="min-h-screen flex items-center justify-center">
  <div class="text-center">
    <div class="w-12 h-12 rounded-full bg-lime-400 flex items-center justify-center text-black font-bold text-xl mx-auto mb-4">R</div>
    <div class="text-neutral-500 text-sm">Loading schedule...</div>
  </div>
</div>

<div id="errorScreen" class="hidden min-h-screen flex items-center justify-center p-4">
  <div class="text-center">
    <div class="text-red-400 text-lg font-semibold mb-2">Schedule Not Found</div>
    <div class="text-neutral-500 text-sm">This link may be invalid. Please ask your manager for a new one.</div>
  </div>
</div>

<!-- ===== MAIN SCHEDULE ===== -->
<div id="scheduleApp" class="hidden">

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-black/95 backdrop-blur-xl border-b border-neutral-800">
    <div class="max-w-lg mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-full flex items-center justify-center text-black font-bold text-sm" id="memberAvatar">R</div>
          <div>
            <div class="text-white text-sm font-semibold" id="memberName"></div>
            <div class="text-neutral-500 text-[10px] uppercase tracking-wider">My Schedule</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="setView('today')" id="btn-today" class="view-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-lime-400 text-black">Today</button>
          <button onclick="setView('week')" id="btn-week" class="view-btn px-3 py-1.5 rounded-lg text-xs font-medium text-neutral-500 bg-neutral-900">Week</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Date Nav -->
  <div class="max-w-lg mx-auto px-4 py-3 flex items-center justify-between">
    <button onclick="navPrev()" class="text-neutral-500 hover:text-white p-2 -ml-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
    </button>
    <div class="text-white font-semibold text-sm text-center" id="dateTitle"></div>
    <button onclick="navNext()" class="text-neutral-500 hover:text-white p-2 -mr-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
    </button>
  </div>

  <!-- Job Stats -->
  <div class="max-w-lg mx-auto px-4 pb-3">
    <div class="grid grid-cols-3 gap-2">
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-3 text-center">
        <div class="text-[10px] text-neutral-500 uppercase">Jobs</div>
        <div class="text-lg font-bold text-white" id="statJobs">0</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-3 text-center">
        <div class="text-[10px] text-neutral-500 uppercase">Earned</div>
        <div class="text-lg font-bold text-lime-400" id="statEarned">£0</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-3 text-center">
        <div class="text-[10px] text-neutral-500 uppercase">Done</div>
        <div class="text-lg font-bold text-green-400" id="statDone">0</div>
      </div>
    </div>
  </div>

  <!-- Jobs List -->
  <div class="max-w-lg mx-auto px-4 pb-8">
    <div id="jobsList" class="space-y-3"></div>
    <div id="noJobs" class="hidden text-center py-16">
      <div class="text-neutral-600 text-4xl mb-3">&#9786;</div>
      <div class="text-neutral-500 text-sm">No jobs scheduled</div>
    </div>
  </div>

</div>

<!-- ===== JOB DETAIL MODAL ===== -->
<div id="actionSheet" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="if(event.target===this)closeAction()">
  <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
  <div class="relative bg-neutral-900 border border-neutral-800 rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto fade-in">

    <!-- Close button -->
    <button onclick="closeAction()" class="absolute top-3 right-3 z-10 w-8 h-8 flex items-center justify-center rounded-full bg-neutral-800 hover:bg-neutral-700 text-neutral-400 hover:text-white transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>

    <!-- Job Info Header -->
    <div class="p-5 pb-4 border-b border-neutral-800">
      <div class="flex items-start justify-between pr-8">
        <h3 class="text-white font-bold text-base leading-tight" id="action-customer"></h3>
        <span class="text-lime-400 font-bold text-lg shrink-0 ml-3" id="action-price"></span>
      </div>
      <div class="text-lime-400/80 text-sm font-medium mt-1" id="action-service"></div>
      <div class="flex flex-col gap-1.5 mt-3">
        <div class="flex items-center gap-2 text-xs text-neutral-400">
          <svg class="w-3.5 h-3.5 shrink-0 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          <span id="action-address"></span>
        </div>
        <div class="flex items-center gap-2 text-xs text-neutral-400">
          <svg class="w-3.5 h-3.5 shrink-0 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <span id="action-time"></span>
        </div>
        <div id="action-phone-row" class="flex items-center gap-2 text-xs text-neutral-400">
          <svg class="w-3.5 h-3.5 shrink-0 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
          <span id="action-phone"></span>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="px-5 py-3 border-b border-neutral-800 flex gap-2">
      <a id="action-call" href="#" class="flex-1 flex items-center justify-center gap-2 bg-green-900/40 hover:bg-green-900/70 text-green-400 py-2.5 rounded-xl text-xs font-medium transition-colors">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
        Call
      </a>
      <a id="action-maps" href="#" target="_blank" class="flex-1 flex items-center justify-center gap-2 bg-blue-900/40 hover:bg-blue-900/70 text-blue-400 py-2.5 rounded-xl text-xs font-medium transition-colors">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        Maps
      </a>
    </div>

    <div class="p-5 space-y-5">

      <!-- Status -->
      <div>
        <div class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Job Status</div>
        <div class="grid grid-cols-3 gap-2" id="action-statusBtns"></div>
      </div>

      <!-- Payment (shown when completed) -->
      <div id="action-paymentWrap" class="hidden">
        <div class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Payment</div>
        <div class="grid grid-cols-3 gap-2" id="action-payBtns"></div>
        <!-- Method row (shown for paid/partial) -->
        <div id="action-methodWrap" class="hidden mt-3">
          <div class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Method</div>
          <div class="grid grid-cols-3 gap-2" id="action-methodBtns"></div>
        </div>
        <!-- Partial amount (shown for partial only) -->
        <div id="action-partialWrap" class="hidden mt-3">
          <div class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Amount Paid</div>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500 text-sm font-medium">£</span>
            <input type="number" id="action-amount" step="0.01" min="0" placeholder="0.00" class="w-full bg-black border border-neutral-700 text-white text-sm pl-7 pr-3 py-2.5 rounded-xl focus:border-lime-400 focus:outline-none">
          </div>
        </div>
        <button onclick="saveMyPayment()" class="mt-3 w-full bg-lime-400 hover:bg-lime-300 text-black font-semibold py-3 rounded-xl text-sm transition-colors">Save Payment</button>
      </div>

      <!-- Notes -->
      <div>
        <div class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Notes</div>
        <textarea id="action-notes" rows="2" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2.5 rounded-xl resize-none focus:border-lime-400 focus:outline-none" placeholder="Add a note..."></textarea>
        <button onclick="saveMyNotes()" class="mt-2 w-full bg-neutral-800 hover:bg-neutral-700 text-white font-medium py-2.5 rounded-xl text-sm transition-colors">Save Notes</button>
      </div>

    </div>
  </div>
</div>

<!-- ===== TOAST ===== -->
<div id="toast" class="fixed top-4 left-4 right-4 z-[60] hidden fade-in max-w-lg mx-auto">
  <div class="bg-neutral-900 border border-neutral-700 rounded-xl px-4 py-3 shadow-xl flex items-center gap-3">
    <div id="toast-icon"></div>
    <div id="toast-msg" class="text-sm text-neutral-300"></div>
  </div>
</div>

<script>
// ============================
// STATE
// ============================
var memberId = null;
var memberInfo = null;
var jobs = [];
var currentDate = new Date();
var currentView = 'today'; // 'today' or 'week'
var activeJob = null;
var activePay = '';
var activeMethod = '';

var API_BASE = window.location.origin;

// ============================
// INIT
// ============================
function init() {
  // Get member ID from URL
  var params = new URLSearchParams(window.location.search);
  memberId = params.get('id');

  if (!memberId) {
    showError();
    return;
  }

  loadSchedule();
}

function showError() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('errorScreen').classList.remove('hidden');
}

function showApp() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('scheduleApp').classList.remove('hidden');
}

// ============================
// DATA LOADING
// ============================
async function loadSchedule() {
  try {
    var params = '';
    if (currentView === 'today') {
      params = '?date=' + toDateStr(currentDate);
    } else {
      var mon = getMonday(currentDate);
      var sun = new Date(mon);
      sun.setDate(mon.getDate() + 6);
      params = '?from_date=' + toDateStr(mon) + '&to_date=' + toDateStr(sun);
    }

    var res = await fetch(API_BASE + '/api/my-schedule/' + memberId + params);
    if (!res.ok) {
      if (res.status === 404) { showError(); return; }
      throw new Error('Failed');
    }

    var data = await res.json();
    if (!data.success) { showError(); return; }

    memberInfo = data.member;
    jobs = data.data;

    // Update header
    document.getElementById('memberName').textContent = memberInfo.name;
    document.getElementById('memberAvatar').textContent = memberInfo.name.charAt(0).toUpperCase();
    document.getElementById('memberAvatar').style.background = memberInfo.color || '#a3e635';

    showApp();
    updateDateTitle();
    renderJobs();
  } catch (e) {
    console.error('Load error:', e);
    showError();
  }
}

// ============================
// NAVIGATION
// ============================
function setView(v) {
  currentView = v;
  document.querySelectorAll('.view-btn').forEach(function(btn) {
    btn.className = 'view-btn px-3 py-1.5 rounded-lg text-xs font-medium ' +
      (btn.id === 'btn-' + v ? 'bg-lime-400 text-black' : 'text-neutral-500 bg-neutral-900');
  });
  if (v === 'today') currentDate = new Date();
  loadSchedule();
}

function navPrev() {
  if (currentView === 'today') {
    currentDate.setDate(currentDate.getDate() - 1);
  } else {
    currentDate.setDate(currentDate.getDate() - 7);
  }
  loadSchedule();
}

function navNext() {
  if (currentView === 'today') {
    currentDate.setDate(currentDate.getDate() + 1);
  } else {
    currentDate.setDate(currentDate.getDate() + 7);
  }
  loadSchedule();
}

function updateDateTitle() {
  var title = document.getElementById('dateTitle');
  if (currentView === 'today') {
    var todayStr = toDateStr(new Date());
    var dateStr = toDateStr(currentDate);
    if (dateStr === todayStr) {
      title.textContent = 'Today - ' + formatDateFull(currentDate);
    } else {
      title.textContent = formatDateFull(currentDate);
    }
  } else {
    var mon = getMonday(currentDate);
    var sun = new Date(mon);
    sun.setDate(mon.getDate() + 6);
    title.textContent = formatDateShort(mon) + ' - ' + formatDateShort(sun);
  }
}

// ============================
// RENDER JOBS
// ============================
function renderJobs() {
  var container = document.getElementById('jobsList');
  var empty = document.getElementById('noJobs');
  container.innerHTML = '';

  // Update stats
  var totalValue = 0, completed = 0;
  jobs.forEach(function(j) {
    totalValue += Number(j.job_value || 0);
    if (j.status === 'completed') completed++;
  });
  document.getElementById('statJobs').textContent = jobs.length;
  document.getElementById('statEarned').textContent = '\u00A3' + totalValue.toFixed(0);
  document.getElementById('statDone').textContent = completed + '/' + jobs.length;

  if (jobs.length === 0) {
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  // Group by date if week view
  if (currentView === 'week') {
    var grouped = {};
    jobs.forEach(function(j) {
      if (!grouped[j.scheduled_date]) grouped[j.scheduled_date] = [];
      grouped[j.scheduled_date].push(j);
    });

    Object.keys(grouped).sort().forEach(function(dateStr) {
      var dayLabel = document.createElement('div');
      dayLabel.className = 'text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mt-4 mb-1 flex items-center gap-2';
      var d = new Date(dateStr + 'T00:00:00');
      var isToday = dateStr === toDateStr(new Date());
      dayLabel.innerHTML = (isToday ? '<span class="w-1.5 h-1.5 rounded-full bg-lime-400"></span>' : '') + formatDateFull(d);
      container.appendChild(dayLabel);

      grouped[dateStr].sort(function(a, b) { return (a.time_slot || '').localeCompare(b.time_slot || ''); });
      grouped[dateStr].forEach(function(j) { container.appendChild(createJobCard(j)); });
    });
  } else {
    jobs.sort(function(a, b) { return (a.time_slot || '').localeCompare(b.time_slot || ''); });
    jobs.forEach(function(j) { container.appendChild(createJobCard(j)); });
  }
}

function createJobCard(j) {
  var card = document.createElement('div');
  card.onclick = function() { openAction(j); };

  var statusColors = {
    scheduled: 'border-l-blue-500',
    in_progress: 'border-l-yellow-500',
    completed: 'border-l-green-500',
    cancelled: 'border-l-red-500',
    not_available: 'border-l-orange-500'
  };
  var statusLabels = { scheduled: 'Scheduled', in_progress: 'In Progress', completed: 'Done', cancelled: 'Cancelled', not_available: 'No Access' };
  var statusBadgeColors = {
    scheduled: 'text-blue-300 bg-blue-900/60',
    in_progress: 'text-yellow-300 bg-yellow-900/60',
    completed: 'text-green-300 bg-green-900/60',
    cancelled: 'text-red-300 bg-red-900/60',
    not_available: 'text-orange-300 bg-orange-900/60'
  };
  var borderColor = statusColors[j.status] || statusColors.scheduled;
  var sl = statusLabels[j.status] || j.status;
  var sbc = statusBadgeColors[j.status] || statusBadgeColors.scheduled;

  card.className = 'bg-neutral-900 border border-neutral-800 border-l-[3px] ' + borderColor + ' rounded-xl cursor-pointer active:bg-neutral-800/80 transition-colors fade-in overflow-hidden';

  var payBadge = '';
  if (j.status === 'completed') {
    if (j.payment_status === 'paid') payBadge = '<span class="px-2 py-0.5 rounded-lg text-[10px] font-medium text-green-300 bg-green-900/60">Paid</span>';
    else if (j.payment_status === 'outstanding') payBadge = '<span class="px-2 py-0.5 rounded-lg text-[10px] font-medium text-red-300 bg-red-900/60">Owed</span>';
    else if (j.payment_status === 'partial') payBadge = '<span class="px-2 py-0.5 rounded-lg text-[10px] font-medium text-orange-300 bg-orange-900/60">Partial</span>';
  }

  card.innerHTML =
    '<div class="p-4">' +
      // Row 1: Customer name + price
      '<div class="flex items-start justify-between mb-1.5">' +
        '<div class="text-white font-semibold text-sm leading-tight">' + esc(j.customer_name) + '</div>' +
        '<span class="text-lime-400 font-bold text-sm shrink-0 ml-2">' + (j.job_value ? '\u00A3' + Number(j.job_value).toFixed(0) : '') + '</span>' +
      '</div>' +
      // Row 2: Service
      '<div class="text-lime-400/70 text-xs font-medium mb-2.5">' + esc(j.service) + '</div>' +
      // Row 3: Address
      '<div class="flex items-center gap-1.5 text-[11px] text-neutral-500 mb-1.5">' +
        '<svg class="w-3 h-3 shrink-0 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>' +
        esc(j.address || '') + ' ' + esc(j.postcode || '') +
      '</div>' +
      // Row 4: Time + duration
      '<div class="flex items-center gap-1.5 text-[11px] text-neutral-500 mb-3">' +
        '<svg class="w-3 h-3 shrink-0 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' +
        esc(j.time_slot || 'TBC') + (j.estimated_duration ? ' &middot; ~' + esc(j.estimated_duration) : '') +
      '</div>' +
      // Row 5: Status + payment badges
      '<div class="flex items-center gap-1.5">' +
        '<span class="px-2.5 py-1 rounded-lg text-[10px] font-semibold ' + sbc + '">' + sl + '</span>' +
        payBadge +
      '</div>' +
    '</div>' +
    // Notes preview (if any)
    (j.notes ? '<div class="border-t border-neutral-800/60 px-4 py-2.5"><div class="text-[11px] text-neutral-500 leading-snug truncate">' + esc(j.notes) + '</div></div>' : '');

  return card;
}

// ============================
// ACTION SHEET
// ============================
function openAction(job) {
  activeJob = job;
  activePay = job.payment_status || 'pending';
  activeMethod = job.payment_method || '';

  document.getElementById('actionSheet').classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  // Populate header info
  document.getElementById('action-customer').textContent = job.customer_name;
  document.getElementById('action-price').textContent = job.job_value ? '\u00A3' + Number(job.job_value).toFixed(0) : '';
  document.getElementById('action-service').textContent = job.service;
  document.getElementById('action-address').textContent = (job.address || '') + ' ' + (job.postcode || '');
  document.getElementById('action-time').textContent = (job.time_slot || 'TBC') + (job.estimated_duration ? ' \u00B7 ~' + job.estimated_duration : '');

  // Phone
  var phoneRow = document.getElementById('action-phone-row');
  if (job.customer_phone) {
    phoneRow.style.display = '';
    document.getElementById('action-phone').textContent = job.customer_phone;
  } else {
    phoneRow.style.display = 'none';
  }

  // Call button
  var callBtn = document.getElementById('action-call');
  if (job.customer_phone) {
    callBtn.href = 'tel:' + job.customer_phone;
    callBtn.style.display = '';
  } else {
    callBtn.style.display = 'none';
  }

  // Maps button
  var mapsBtn = document.getElementById('action-maps');
  var addr = encodeURIComponent((job.address || '') + ' ' + (job.postcode || ''));
  mapsBtn.href = 'https://www.google.com/maps/search/?api=1&query=' + addr;

  // Status buttons
  renderMyStatusBtns(job.status);

  // Payment
  renderMyPayment(job);

  // Notes
  document.getElementById('action-notes').value = job.notes || '';
}

function closeAction() {
  document.getElementById('actionSheet').classList.add('hidden');
  document.body.style.overflow = '';
  activeJob = null;
}

function renderMyStatusBtns(current) {
  var statuses = ['completed', 'cancelled', 'not_available'];
  var labels = { completed: 'Completed', cancelled: 'Cancelled', not_available: 'Not Available' };
  var colors = {
    completed: 'bg-green-900/60 text-green-300',
    cancelled: 'bg-red-900/60 text-red-300',
    not_available: 'bg-orange-900/60 text-orange-300'
  };
  var activeRing = {
    completed: 'ring-2 ring-green-400',
    cancelled: 'ring-2 ring-red-400',
    not_available: 'ring-2 ring-orange-400'
  };

  var container = document.getElementById('action-statusBtns');
  container.innerHTML = '';

  statuses.forEach(function(s) {
    var isActive = s === current;
    var btn = document.createElement('button');
    btn.className = 'py-2.5 rounded-xl text-sm font-medium transition-all ' + colors[s] + (isActive ? ' ' + activeRing[s] : ' opacity-60');
    btn.textContent = labels[s];
    btn.onclick = function() {
      if (!isActive) updateMyStatus(s);
    };
    container.appendChild(btn);
  });
}

async function updateMyStatus(newStatus) {
  if (!activeJob) return;
  try {
    var res = await fetch(API_BASE + '/api/my-schedule/' + memberId + '/jobs/' + activeJob.id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });
    var data = await res.json();
    if (data.success) {
      activeJob.status = newStatus;
      activeJob = data.data;
      renderMyStatusBtns(newStatus);
      renderMyPayment(activeJob);
      loadSchedule();
      showToast('Status updated', 'success');

      // Close modal for cancelled/not_available (no further action needed)
      if (newStatus === 'cancelled' || newStatus === 'not_available') {
        setTimeout(function() { closeAction(); }, 600);
      }
    }
  } catch (e) {
    showToast('Failed to update', 'error');
  }
}

// ============================
// PAYMENT
// ============================
function renderMyPayment(job) {
  var wrap = document.getElementById('action-paymentWrap');
  if (job.status !== 'completed') {
    wrap.classList.add('hidden');
    return;
  }
  wrap.classList.remove('hidden');

  var payStatuses = ['paid', 'outstanding', 'partial'];
  var payLabels = { paid: 'Paid', outstanding: 'Outstanding', partial: 'Partial' };
  var payColors = { paid: 'bg-green-900/60 text-green-300', outstanding: 'bg-red-900/60 text-red-300', partial: 'bg-orange-900/60 text-orange-300' };
  var payRing = { paid: 'ring-2 ring-green-400', outstanding: 'ring-2 ring-red-400', partial: 'ring-2 ring-orange-400' };

  var container = document.getElementById('action-payBtns');
  container.innerHTML = '';
  payStatuses.forEach(function(s) {
    var isActive = s === activePay;
    var btn = document.createElement('button');
    btn.className = 'py-2.5 rounded-xl text-sm font-medium transition-all ' + payColors[s] + (isActive ? ' ' + payRing[s] : ' opacity-60');
    btn.textContent = payLabels[s];
    btn.onclick = function() {
      activePay = s;
      // Reset method when switching payment status
      if (s === 'outstanding') activeMethod = '';
      renderPaymentDetails();
    };
    container.appendChild(btn);
  });

  renderPaymentDetails();
}

function renderPaymentDetails() {
  var methodWrap = document.getElementById('action-methodWrap');
  var partialWrap = document.getElementById('action-partialWrap');

  // Outstanding = no method needed, just show save button
  // Paid = show method selection
  // Partial = show method selection + amount input
  var needsMethod = (activePay === 'paid' || activePay === 'partial');

  if (needsMethod) {
    methodWrap.classList.remove('hidden');
    var methods = ['cash', 'transfer', 'card'];
    var methodContainer = document.getElementById('action-methodBtns');
    methodContainer.innerHTML = '';
    methods.forEach(function(m) {
      var isActive = m === activeMethod;
      var btn = document.createElement('button');
      btn.className = 'py-2.5 rounded-xl text-sm font-medium transition-all ' + (isActive ? 'bg-lime-400 text-black ring-2 ring-lime-300' : 'bg-neutral-800 text-neutral-300 opacity-60');
      btn.textContent = m.charAt(0).toUpperCase() + m.slice(1);
      btn.onclick = function() { activeMethod = m; renderPaymentDetails(); };
      methodContainer.appendChild(btn);
    });
  } else {
    methodWrap.classList.add('hidden');
  }

  if (activePay === 'partial') {
    partialWrap.classList.remove('hidden');
    document.getElementById('action-amount').value = activeJob.amount_paid || '';
  } else {
    partialWrap.classList.add('hidden');
  }
}

async function saveMyPayment() {
  if (!activeJob) return;

  // Validate: paid/partial need a method selected
  if ((activePay === 'paid' || activePay === 'partial') && !activeMethod) {
    showToast('Please select a payment method', 'error');
    return;
  }
  if (activePay === 'partial') {
    var amt = parseFloat(document.getElementById('action-amount').value);
    if (!amt || amt <= 0) {
      showToast('Please enter the amount paid', 'error');
      return;
    }
  }

  var body = {
    payment_status: activePay,
    payment_method: (activePay === 'outstanding') ? null : (activeMethod || null)
  };
  if (activePay === 'partial') {
    body.amount_paid = parseFloat(document.getElementById('action-amount').value) || 0;
  } else if (activePay === 'paid') {
    body.amount_paid = activeJob.job_value;
  }

  try {
    var res = await fetch(API_BASE + '/api/my-schedule/' + memberId + '/jobs/' + activeJob.id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    var data = await res.json();
    if (data.success) {
      activeJob = data.data;
      loadSchedule();
      showToast('Payment saved', 'success');
      closeAction();
    }
  } catch (e) {
    showToast('Failed to save payment', 'error');
  }
}

async function saveMyNotes() {
  if (!activeJob) return;
  var notes = document.getElementById('action-notes').value;
  try {
    var res = await fetch(API_BASE + '/api/my-schedule/' + memberId + '/jobs/' + activeJob.id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ notes: notes })
    });
    var data = await res.json();
    if (data.success) {
      activeJob.notes = notes;
      loadSchedule();
      showToast('Notes saved', 'success');
      closeAction();
    }
  } catch (e) {
    showToast('Failed to save notes', 'error');
  }
}

// ============================
// TOAST
// ============================
function showToast(msg, type) {
  var toast = document.getElementById('toast');
  var icon = document.getElementById('toast-icon');
  var msgEl = document.getElementById('toast-msg');

  if (type === 'success') {
    icon.innerHTML = '<svg class="w-4 h-4 text-lime-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
  } else {
    icon.innerHTML = '<svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
  }

  msgEl.textContent = msg;
  toast.classList.remove('hidden');

  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(function() { toast.classList.add('hidden'); }, 2500);
}

// ============================
// HELPERS
// ============================
function esc(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function toDateStr(d) {
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function getMonday(d) {
  var day = d.getDay();
  var diff = day === 0 ? -6 : 1 - day;
  var mon = new Date(d);
  mon.setDate(d.getDate() + diff);
  return mon;
}

function formatDateFull(d) {
  var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return days[d.getDay()] + ' ' + d.getDate() + ' ' + months[d.getMonth()];
}

function formatDateShort(d) {
  var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return d.getDate() + ' ' + months[d.getMonth()];
}

// ============================
// START
// ============================
init();
</script>

</body>
</html>
