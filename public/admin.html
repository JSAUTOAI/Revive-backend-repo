<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Revive Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    /* Flatpickr dark theme overrides */
    .flatpickr-calendar { background: #171717 !important; border: 1px solid #262626 !important; box-shadow: 0 20px 60px rgba(0,0,0,0.5) !important; font-family: 'Poppins', sans-serif !important; border-radius: 12px !important; }
    .flatpickr-calendar.inline { box-shadow: none !important; border: none !important; background: transparent !important; width: 100% !important; }
    .flatpickr-calendar.inline .flatpickr-months { background: transparent !important; }
    .flatpickr-calendar.inline .flatpickr-month { background: transparent !important; }
    .flatpickr-months .flatpickr-month { background: #171717 !important; color: #fff !important; }
    .flatpickr-current-month .flatpickr-monthDropdown-months { background: #171717 !important; color: #fff !important; }
    .flatpickr-current-month input.cur-year { color: #fff !important; }
    .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month { color: #a3e635 !important; fill: #a3e635 !important; }
    .flatpickr-months .flatpickr-prev-month:hover svg, .flatpickr-months .flatpickr-next-month:hover svg { fill: #fff !important; }
    span.flatpickr-weekday { color: #737373 !important; font-weight: 600 !important; }
    .flatpickr-day { color: #d4d4d4 !important; border-radius: 8px !important; }
    .flatpickr-day:hover { background: #262626 !important; border-color: #262626 !important; }
    .flatpickr-day.selected { background: #a3e635 !important; border-color: #a3e635 !important; color: #000 !important; font-weight: 600 !important; }
    .flatpickr-day.today { border-color: #a3e635 !important; }
    .flatpickr-day.today:hover { background: #a3e635 !important; color: #000 !important; }
    .flatpickr-day.prevMonthDay, .flatpickr-day.nextMonthDay { color: #404040 !important; }
    .flatpickr-day.flatpickr-disabled { color: #262626 !important; }
    .dayContainer { padding: 4px !important; }
    .flatpickr-innerContainer { padding-bottom: 4px !important; }
    * { font-family: 'Poppins', sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a0a; }
    ::-webkit-scrollbar-thumb { background: #262626; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #404040; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .pulse-dot { animation: pulse-dot 1.5s ease-in-out infinite; }
  </style>
</head>
<body class="bg-black text-neutral-300 min-h-screen">

<!-- ============ LOGIN SCREEN ============ -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-8 max-w-sm w-full fade-in">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 rounded-full bg-lime-400 flex items-center justify-center text-black font-bold text-lg">R</div>
      <div>
        <h1 class="text-white text-lg font-semibold tracking-tight">REVIVE Admin</h1>
        <p class="text-neutral-500 text-xs">Quote Management Dashboard</p>
      </div>
    </div>
    <input type="password" id="tokenInput" placeholder="Enter admin token"
      class="w-full bg-black border border-neutral-700 text-white px-4 py-3 rounded-lg text-sm focus:border-lime-400 focus:outline-none transition-colors"
      onkeydown="if(event.key==='Enter')login()">
    <button onclick="login()"
      class="w-full mt-4 bg-lime-400 hover:bg-lime-300 text-black font-semibold py-3 rounded-lg text-sm transition-colors">
      Access Dashboard
    </button>
    <div id="loginError" class="hidden mt-3 text-red-400 text-xs text-center"></div>
  </div>
</div>

<!-- ============ DASHBOARD ============ -->
<div id="dashboard" class="hidden">

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-black/90 backdrop-blur-xl border-b border-neutral-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-lime-400 flex items-center justify-center text-black font-bold text-sm">R</div>
        <h1 class="text-white text-sm font-semibold tracking-tight">REVIVE <span class="text-neutral-500 font-light">Admin</span></h1>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="exportCSV()" id="csvBtn" class="hidden sm:flex items-center gap-2 bg-neutral-900 border border-neutral-700 hover:border-lime-400 text-neutral-300 hover:text-white px-4 py-2 rounded-lg text-xs font-medium transition-colors">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          Export CSV
        </button>
        <button onclick="logout()" class="text-neutral-500 hover:text-white text-xs transition-colors">Logout</button>
      </div>
    </div>
    <!-- Tab Navigation -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 flex gap-1 pt-2">
      <button onclick="switchTab('quotes')" id="tab-quotes" class="tab-btn px-4 py-2 text-xs font-semibold rounded-t-lg transition-colors bg-neutral-900 text-lime-400 border border-neutral-800 border-b-0">Quotes</button>
      <button onclick="switchTab('schedule')" id="tab-schedule" class="tab-btn px-4 py-2 text-xs font-semibold rounded-t-lg transition-colors text-neutral-500 hover:text-neutral-300">Schedule</button>
      <button onclick="switchTab('team')" id="tab-team" class="tab-btn px-4 py-2 text-xs font-semibold rounded-t-lg transition-colors text-neutral-500 hover:text-neutral-300">Team</button>
      <button onclick="switchTab('customers')" id="tab-customers" class="tab-btn px-4 py-2 text-xs font-semibold rounded-t-lg transition-colors text-neutral-500 hover:text-neutral-300">Customers</button>
      <button onclick="switchTab('invoices')" id="tab-invoices" class="tab-btn px-4 py-2 text-xs font-semibold rounded-t-lg transition-colors text-neutral-500 hover:text-neutral-300">Invoices</button>
      <button onclick="switchTab('chats')" id="tab-chats" class="tab-btn px-4 py-2 text-xs font-semibold rounded-t-lg transition-colors text-neutral-500 hover:text-neutral-300">Chats</button>
      <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn px-4 py-2 text-xs font-semibold rounded-t-lg transition-colors text-neutral-500 hover:text-neutral-300">Settings</button>
    </div>
  </header>

  <!-- ===== QUOTES TAB ===== -->
  <div id="content-quotes" class="tab-content max-w-7xl mx-auto px-4 sm:px-6 py-6">

    <!-- Stats Bar -->
    <div id="statsBar" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3 mb-6">
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Total</div>
        <div class="text-xl font-bold text-white mt-1" id="stat-total">-</div>
      </div>
      <div class="bg-neutral-900 border border-red-900/40 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider flex items-center gap-1.5">
          <span class="w-1.5 h-1.5 rounded-full bg-red-400 pulse-dot"></span>Hot
        </div>
        <div class="text-xl font-bold text-red-400 mt-1" id="stat-hot">-</div>
      </div>
      <div class="bg-neutral-900 border border-orange-900/40 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider flex items-center gap-1.5">
          <span class="w-1.5 h-1.5 rounded-full bg-orange-400"></span>Warm
        </div>
        <div class="text-xl font-bold text-orange-400 mt-1" id="stat-warm">-</div>
      </div>
      <div class="bg-neutral-900 border border-blue-900/40 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider flex items-center gap-1.5">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>Cold
        </div>
        <div class="text-xl font-bold text-blue-400 mt-1" id="stat-cold">-</div>
      </div>
      <div class="bg-neutral-900 border border-lime-900/40 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Avg Estimate</div>
        <div class="text-xl font-bold text-lime-400 mt-1" id="stat-avg">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Accepted</div>
        <div class="text-xl font-bold text-white mt-1" id="stat-accepted">-</div>
      </div>
      <div class="bg-neutral-900 border border-orange-500/40 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider flex items-center gap-1.5">
          <svg class="w-3 h-3 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
          Attention
        </div>
        <div class="text-xl font-bold text-orange-400 mt-1" id="stat-attention">-</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap-3 mb-4">
      <select id="filter-status" onchange="applyFilters()" class="bg-neutral-900 border border-neutral-700 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        <option value="">All Leads</option>
        <option value="attention">Needs Attention</option>
        <option value="hot">Hot</option>
        <option value="warm">Warm</option>
        <option value="cold">Cold</option>
        <option value="unqualified">Unqualified</option>
      </select>
      <select id="filter-service" onchange="applyFilters()" class="bg-neutral-900 border border-neutral-700 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        <option value="">All Services</option>
        <option value="roof">Roof</option>
        <option value="driveway">Driveway</option>
        <option value="gutter">Gutter</option>
        <option value="softwash">Softwash</option>
        <option value="render">Render</option>
        <option value="window">Window</option>
        <option value="solar">Solar Panel</option>
      </select>
      <select id="filter-sort" onchange="applyFilters()" class="bg-neutral-900 border border-neutral-700 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        <option value="created_at:desc">Newest First</option>
        <option value="created_at:asc">Oldest First</option>
        <option value="lead_score:desc">Highest Score</option>
        <option value="estimated_value_max:desc">Highest Value</option>
      </select>
      <button onclick="exportCSV()" class="sm:hidden flex items-center gap-2 bg-neutral-900 border border-neutral-700 text-neutral-300 px-3 py-2 rounded-lg text-xs">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3"/></svg>
        CSV
      </button>
      <div class="ml-auto text-neutral-500 text-xs" id="resultCount"></div>
    </div>

    <!-- Loading -->
    <div id="tableLoading" class="hidden text-center py-12">
      <div class="inline-flex items-center gap-2 text-neutral-500 text-sm">
        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
        Loading quotes...
      </div>
    </div>

    <!-- Quotes Table (desktop) -->
    <div id="quotesTable" class="hidden sm:block bg-neutral-900 border border-neutral-800 rounded-xl overflow-hidden">
      <table class="w-full">
        <thead>
          <tr class="border-b border-neutral-800 text-left">
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider">Lead</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider">Customer</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider hidden lg:table-cell">Services</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider">Estimate</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider hidden md:table-cell">Score</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider">Status</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider hidden md:table-cell">Date</th>
          </tr>
        </thead>
        <tbody id="quotesTableBody"></tbody>
      </table>
    </div>

    <!-- Quotes Cards (mobile) -->
    <div id="quotesCards" class="sm:hidden space-y-3"></div>

    <!-- Empty state -->
    <div id="emptyState" class="hidden text-center py-16">
      <div class="text-neutral-600 text-sm">No quotes found</div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="hidden flex items-center justify-between mt-4">
      <button onclick="prevPage()" id="prevBtn" class="flex items-center gap-1 bg-neutral-900 border border-neutral-700 text-neutral-400 hover:text-white px-4 py-2 rounded-lg text-xs transition-colors disabled:opacity-30 disabled:cursor-not-allowed">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        Previous
      </button>
      <span class="text-neutral-500 text-xs" id="pageInfo"></span>
      <button onclick="nextPage()" id="nextBtn" class="flex items-center gap-1 bg-neutral-900 border border-neutral-700 text-neutral-400 hover:text-white px-4 py-2 rounded-lg text-xs transition-colors disabled:opacity-30 disabled:cursor-not-allowed">
        Next
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>

  <!-- ===== SCHEDULE TAB ===== -->
  <div id="content-schedule" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 py-6">

    <!-- Schedule Header -->
    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div class="flex items-center gap-3">
        <button onclick="schedNavPrev()" class="bg-neutral-900 border border-neutral-700 hover:border-lime-400 text-neutral-400 hover:text-white w-8 h-8 rounded-lg flex items-center justify-center transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <h2 class="text-white font-semibold text-sm min-w-[200px] text-center" id="schedTitle"></h2>
        <button onclick="schedNavNext()" class="bg-neutral-900 border border-neutral-700 hover:border-lime-400 text-neutral-400 hover:text-white w-8 h-8 rounded-lg flex items-center justify-center transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </button>
        <button onclick="schedGoToday()" class="bg-neutral-900 border border-neutral-700 text-neutral-400 hover:text-white px-3 py-1.5 rounded-lg text-xs transition-colors">Today</button>
      </div>
      <div class="flex items-center gap-2">
        <select id="sched-filter-team" onchange="loadSchedule()" class="bg-neutral-900 border border-neutral-700 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
          <option value="">All Team</option>
        </select>
        <button onclick="toggleSchedView()" id="schedViewBtn" class="bg-neutral-900 border border-neutral-700 hover:border-lime-400 text-neutral-400 hover:text-white px-3 py-2 rounded-lg text-xs transition-colors">Week View</button>
        <button onclick="openAddJobModal()" class="bg-lime-400 hover:bg-lime-300 text-black font-semibold px-4 py-2 rounded-lg text-xs transition-colors">+ Add Job</button>
      </div>
    </div>

    <!-- Day View -->
    <div id="schedDayView" class="space-y-2">
      <div id="schedDayJobs" class="space-y-2"></div>
      <div id="schedDayEmpty" class="hidden text-center py-12 text-neutral-600 text-sm">No jobs scheduled for this day</div>
    </div>

    <!-- Week View -->
    <div id="schedWeekView" class="hidden">
      <div class="grid grid-cols-7 gap-1 mb-1" id="weekHeaders"></div>
      <div class="grid grid-cols-7 gap-1 min-h-[400px]" id="weekGrid"></div>
    </div>

    <!-- Day/Week Totals -->
    <div class="mt-4 bg-neutral-900 border border-neutral-800 rounded-xl p-4 flex flex-wrap items-center gap-6 text-xs">
      <div><span class="text-neutral-500">Jobs: </span><span class="text-white font-semibold" id="schedTotalJobs">0</span></div>
      <div><span class="text-neutral-500">Revenue: </span><span class="text-lime-400 font-semibold" id="schedTotalRevenue">£0</span></div>
      <div><span class="text-neutral-500">Paid: </span><span class="text-green-400 font-semibold" id="schedTotalPaid">0</span></div>
      <div><span class="text-neutral-500">Outstanding: </span><span class="text-red-400 font-semibold" id="schedTotalOutstanding">0</span></div>
    </div>

    <!-- Recurring Jobs Section -->
    <div class="mt-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-white font-semibold text-sm">Recurring Jobs</h3>
        <button onclick="openAddJobModal(true)" class="bg-neutral-900 border border-neutral-700 hover:border-lime-400 text-neutral-400 hover:text-white px-3 py-2 rounded-lg text-xs transition-colors">+ Add Recurring</button>
      </div>
      <div id="recurringList" class="space-y-2"></div>
      <div id="recurringEmpty" class="hidden text-center py-8 text-neutral-600 text-sm">No recurring jobs set up</div>
    </div>
  </div>

  <!-- ===== TEAM TAB ===== -->
  <div id="content-team" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 py-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-white font-semibold text-sm">Team Members</h2>
      <button onclick="openAddTeamModal()" class="bg-lime-400 hover:bg-lime-300 text-black font-semibold px-4 py-2 rounded-lg text-xs transition-colors">+ Add Member</button>
    </div>
    <div id="teamList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    <div id="teamEmpty" class="hidden text-center py-16 text-neutral-600 text-sm">No team members added yet</div>
  </div>

  <!-- ===== CUSTOMERS TAB ===== -->
  <div id="content-customers" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 py-6">

    <!-- Stats -->
    <div id="custStatsBar" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Customers</div>
        <div class="text-xl font-bold text-white mt-1" id="cust-stat-total">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Active (6mo)</div>
        <div class="text-xl font-bold text-lime-400 mt-1" id="cust-stat-active">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Total Revenue</div>
        <div class="text-xl font-bold text-lime-400 mt-1" id="cust-stat-revenue">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Avg Spend</div>
        <div class="text-xl font-bold text-white mt-1" id="cust-stat-avg">-</div>
      </div>
    </div>

    <!-- Business Analytics -->
    <details id="analyticsSection" class="mb-6">
      <summary class="bg-neutral-900 border border-neutral-800 rounded-xl px-4 py-3 text-xs font-semibold text-neutral-400 cursor-pointer hover:text-white transition-colors">Business Analytics</summary>
      <div class="mt-3 space-y-4">

        <!-- Pipeline Snapshot -->
        <div>
          <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-2 px-1">Pipeline Snapshot</div>
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
            <div class="bg-neutral-900 border border-red-900/40 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Awaiting Action</div>
              <div class="text-xl font-bold text-red-400 mt-1" id="analytics-pipeline-new">-</div>
            </div>
            <div class="bg-neutral-900 border border-orange-900/40 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Hot Uncontacted</div>
              <div class="text-xl font-bold text-orange-400 mt-1" id="analytics-pipeline-hot">-</div>
            </div>
            <div class="bg-neutral-900 border border-amber-900/40 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Accepted, Not Booked</div>
              <div class="text-xl font-bold text-amber-400 mt-1" id="analytics-pipeline-accepted">-</div>
            </div>
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Jobs This Week</div>
              <div class="text-xl font-bold text-lime-400 mt-1" id="analytics-pipeline-week">-</div>
            </div>
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Jobs This Month</div>
              <div class="text-xl font-bold text-white mt-1" id="analytics-pipeline-month">-</div>
            </div>
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Pipeline Value</div>
              <div class="text-xl font-bold text-lime-400 mt-1" id="analytics-pipeline-value">-</div>
            </div>
          </div>
        </div>

        <!-- Conversion Funnel -->
        <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
          <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-3">Conversion Funnel</div>
          <div id="analytics-funnel" class="space-y-2">
            <div class="text-neutral-600 text-xs">Loading...</div>
          </div>
        </div>

        <!-- Conversion Rates -->
        <div>
          <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-2 px-1">Conversion Rates</div>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Quote &gt; Accept</div>
              <div class="text-xl font-bold text-lime-400 mt-1" id="analytics-q2a-rate">-</div>
              <div class="text-[10px] text-neutral-600 mt-1" id="analytics-q2a-detail"></div>
            </div>
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Accept &gt; Job</div>
              <div class="text-xl font-bold text-lime-400 mt-1" id="analytics-a2j-rate">-</div>
              <div class="text-[10px] text-neutral-600 mt-1" id="analytics-a2j-detail"></div>
            </div>
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Avg Time to Accept</div>
              <div class="text-xl font-bold text-white mt-1" id="analytics-avg-time">-</div>
            </div>
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Follow-Up Success</div>
              <div class="text-xl font-bold text-lime-400 mt-1" id="analytics-followup-rate">-</div>
              <div class="text-[10px] text-neutral-600 mt-1" id="analytics-followup-detail"></div>
            </div>
          </div>
        </div>

        <!-- Response Speed -->
        <div>
          <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-2 px-1">Response Speed</div>
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Avg Time to First Contact</div>
              <div class="text-xl font-bold text-white mt-1" id="analytics-response-first-contact">-</div>
              <div class="text-[10px] text-neutral-600 mt-1">From quote submission to first admin action</div>
            </div>
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Avg Time to Estimate</div>
              <div class="text-xl font-bold text-lime-400 mt-1" id="analytics-response-estimate">-</div>
              <div class="text-[10px] text-neutral-600 mt-1">Auto-estimation speed (should be &lt;1 min)</div>
            </div>
          </div>
        </div>

        <!-- Service Insights -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
          <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
            <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-3">Most Requested Services</div>
            <div id="analytics-service-request-bars" class="space-y-2">
              <div class="text-neutral-600 text-xs">Loading...</div>
            </div>
          </div>
          <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
            <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-3">Revenue by Service</div>
            <div id="analytics-revenue-bars" class="space-y-2">
              <div class="text-neutral-600 text-xs">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Service Conversion Table -->
        <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
          <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-3">Service Conversion Rates</div>
          <div id="analytics-service-conversion" class="overflow-x-auto">
            <div class="text-neutral-600 text-xs">Loading...</div>
          </div>
        </div>

        <!-- Customer Behaviour -->
        <div>
          <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-2 px-1">Customer Behaviour</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-3">Preferred Contact</div>
              <div id="analytics-contact-breakdown" class="space-y-2">
                <div class="text-neutral-600 text-xs">Loading...</div>
              </div>
            </div>
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-3">Peak Quote Times</div>
              <div id="analytics-peak-times" class="space-y-1">
                <div class="text-neutral-600 text-xs">Loading...</div>
              </div>
            </div>
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
              <div class="text-neutral-500 text-[10px] uppercase tracking-wider mb-3">Top Postcodes</div>
              <div id="analytics-postcodes" class="space-y-2">
                <div class="text-neutral-600 text-xs">Loading...</div>
              </div>
              <div class="mt-3 pt-2 border-t border-neutral-800">
                <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Repeat Customer Rate</div>
                <div class="text-lg font-bold text-lime-400 mt-1" id="analytics-repeat-rate">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Future Enhancement Note -->
        <div class="bg-neutral-900/50 border border-dashed border-neutral-800 rounded-xl p-3">
          <div class="text-neutral-600 text-[10px]">
            Coming soon: Email open/click tracking, quote page view tracking, and channel attribution analytics.
          </div>
        </div>

      </div>
    </details>

    <!-- Search + Filters -->
    <div class="flex flex-col sm:flex-row gap-3 mb-6">
      <div class="flex-1 relative">
        <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        <input type="text" id="custSearch" placeholder="Search by name, email, phone, postcode..." class="w-full bg-neutral-900 border border-neutral-800 text-white text-sm pl-10 pr-3 py-2.5 rounded-lg focus:border-lime-400 focus:outline-none" oninput="debouncedCustSearch()">
      </div>
      <select id="custSort" onchange="loadCustomers()" class="bg-neutral-900 border border-neutral-800 text-neutral-300 text-sm px-3 py-2.5 rounded-lg focus:border-lime-400 focus:outline-none">
        <option value="created_at">Newest First</option>
        <option value="total_spent">Highest Spend</option>
        <option value="last_job_date">Last Job</option>
        <option value="name">Name A-Z</option>
      </select>
      <button onclick="openBulkFollowUpModal()" class="bg-neutral-900 border border-neutral-700 hover:border-lime-400 text-neutral-300 hover:text-white px-4 py-2.5 rounded-lg text-xs font-medium transition-colors whitespace-nowrap">Send Bulk Email</button>
      <button onclick="openAddCustomerModal()" class="bg-lime-400 hover:bg-lime-300 text-black px-4 py-2.5 rounded-lg text-xs font-semibold transition-colors whitespace-nowrap">+ Add Customer</button>
      <button onclick="openImportCsvModal()" class="bg-neutral-900 border border-neutral-700 hover:border-lime-400 text-neutral-300 hover:text-white px-4 py-2.5 rounded-lg text-xs font-medium transition-colors whitespace-nowrap">Import CSV</button>
    </div>

    <!-- Customer List -->
    <div id="custList" class="space-y-3"></div>
    <div id="custEmpty" class="hidden text-center py-16 text-neutral-600 text-sm">No customers found</div>

    <!-- Pagination -->
    <div id="custPagination" class="hidden flex items-center justify-between mt-6">
      <div class="text-xs text-neutral-500" id="custPaginationInfo"></div>
      <div class="flex gap-2">
        <button onclick="custPrevPage()" id="custPrevBtn" class="bg-neutral-900 border border-neutral-800 text-neutral-400 hover:text-white px-3 py-1.5 rounded-lg text-xs">Prev</button>
        <button onclick="custNextPage()" id="custNextBtn" class="bg-neutral-900 border border-neutral-800 text-neutral-400 hover:text-white px-3 py-1.5 rounded-lg text-xs">Next</button>
      </div>
    </div>
  </div>

  <!-- ===== INVOICES TAB ===== -->
  <div id="content-invoices" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 py-6">

    <!-- Stats -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Total</div>
        <div class="text-xl font-bold text-white mt-1" id="inv-stat-total">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Draft</div>
        <div class="text-xl font-bold text-neutral-400 mt-1" id="inv-stat-draft">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Sent</div>
        <div class="text-xl font-bold text-orange-400 mt-1" id="inv-stat-sent">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Paid</div>
        <div class="text-xl font-bold text-green-400 mt-1" id="inv-stat-paid">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Outstanding</div>
        <div class="text-xl font-bold text-red-400 mt-1" id="inv-stat-outstanding">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Total Invoiced</div>
        <div class="text-xl font-bold text-lime-400 mt-1" id="inv-stat-invoiced">-</div>
      </div>
    </div>

    <!-- Filter -->
    <div class="flex items-center gap-3 mb-4">
      <select id="inv-filter-status" onchange="loadInvoices()" class="bg-neutral-900 border border-neutral-800 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        <option value="">All Invoices</option>
        <option value="draft">Draft</option>
        <option value="sent">Sent</option>
        <option value="paid">Paid</option>
        <option value="overdue">Overdue</option>
      </select>
    </div>

    <!-- Invoice List -->
    <div id="invoiceList" class="space-y-2"></div>
    <div id="invoiceEmpty" class="hidden text-center text-neutral-600 text-sm py-12">No invoices yet. Generate an invoice from a completed job.</div>
  </div>

  <!-- ===== CHATS TAB ===== -->
  <div id="content-chats" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 py-6">
    <!-- Stats -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Total Chats</div>
        <div class="text-xl font-bold text-white mt-1" id="chat-stat-total">-</div>
      </div>
      <div class="bg-neutral-900 border border-lime-900/40 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Leads Captured</div>
        <div class="text-xl font-bold text-lime-400 mt-1" id="chat-stat-leads">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Today</div>
        <div class="text-xl font-bold text-white mt-1" id="chat-stat-today">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Conversion</div>
        <div class="text-xl font-bold text-lime-400 mt-1" id="chat-stat-conversion">-</div>
      </div>
    </div>

    <!-- Filter -->
    <div class="flex items-center gap-3 mb-4">
      <select id="chat-filter" onchange="loadChats()" class="bg-neutral-900 border border-neutral-800 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        <option value="">All Conversations</option>
        <option value="leads">Leads Only</option>
      </select>
      <div class="ml-auto text-neutral-500 text-xs" id="chatResultCount"></div>
    </div>

    <!-- Chat List -->
    <div id="chatList" class="space-y-2"></div>
    <div id="chatEmpty" class="hidden text-center text-neutral-600 text-sm py-12">No chat conversations yet.</div>
  </div>

  <!-- ===== SETTINGS TAB ===== -->
  <div id="content-settings" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 py-6">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-white text-lg font-semibold">Pricing & Estimation Settings</h2>
        <p class="text-neutral-500 text-xs mt-1">Adjust pricing parameters, modifiers, and lead scoring. Changes take effect on new estimates immediately.</p>
      </div>
      <div class="flex items-center gap-2">
        <span id="settings-source-badge" class="text-[10px] uppercase tracking-wider px-2 py-1 rounded-full border"></span>
        <button onclick="resetPricingSettings()" class="bg-neutral-900 border border-neutral-700 hover:border-red-400 text-neutral-400 hover:text-red-400 px-3 py-2 rounded-lg text-xs font-medium transition-colors">Reset to Defaults</button>
        <button onclick="savePricingSettings()" class="bg-lime-400 hover:bg-lime-300 text-black font-semibold px-4 py-2 rounded-lg text-xs transition-colors">Save All Changes</button>
      </div>
    </div>

    <!-- Section 1: Service Pricing -->
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl mb-4">
      <div class="px-5 py-4 border-b border-neutral-800 flex items-center justify-between cursor-pointer" onclick="toggleSettingsSection('servicePricing')">
        <h3 class="text-white text-sm font-semibold">Service Price Ranges</h3>
        <svg id="chevron-servicePricing" class="w-4 h-4 text-neutral-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </div>
      <div id="section-servicePricing" class="p-5">
        <p class="text-neutral-500 text-xs mb-4">Set minimum and maximum price ranges for each service at each property size. All prices in £.</p>
        <div class="overflow-x-auto">
          <table class="w-full text-xs">
            <thead>
              <tr class="text-neutral-500 text-[10px] uppercase tracking-wider">
                <th class="text-left pb-3 pr-3">Service</th>
                <th class="pb-3 px-1 text-center" colspan="2">Small</th>
                <th class="pb-3 px-1 text-center" colspan="2">Medium</th>
                <th class="pb-3 px-1 text-center" colspan="2">Large</th>
              </tr>
              <tr class="text-neutral-600 text-[9px]">
                <th></th>
                <th class="pb-2 px-1">Min</th><th class="pb-2 px-1">Max</th>
                <th class="pb-2 px-1">Min</th><th class="pb-2 px-1">Max</th>
                <th class="pb-2 px-1">Min</th><th class="pb-2 px-1">Max</th>
              </tr>
            </thead>
            <tbody id="pricing-table-body">
            </tbody>
          </table>
        </div>
        <div class="flex items-center gap-3 mt-4 pt-4 border-t border-neutral-800">
          <input type="text" id="new-service-name" placeholder="e.g. Patio Cleaning, Fence Wash..." class="flex-1 bg-black border border-neutral-700 text-white text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" onkeydown="if(event.key==='Enter')addCustomService()">
          <button onclick="addCustomService()" class="bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 hover:border-lime-400 text-neutral-300 hover:text-white px-4 py-2 rounded-lg text-xs font-medium transition-colors whitespace-nowrap">+ Add Service</button>
        </div>
        <div id="add-service-error" class="hidden text-red-400 text-xs mt-2"></div>
      </div>
    </div>

    <!-- Section 2: Pricing Modifiers -->
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl mb-4">
      <div class="px-5 py-4 border-b border-neutral-800 flex items-center justify-between cursor-pointer" onclick="toggleSettingsSection('modifiers')">
        <h3 class="text-white text-sm font-semibold">Pricing Modifiers</h3>
        <svg id="chevron-modifiers" class="w-4 h-4 text-neutral-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </div>
      <div id="section-modifiers" class="p-5">
        <p class="text-neutral-500 text-xs mb-4">Percentage surcharges applied to estimates based on property conditions. Enter as percentage (e.g. 20 for 20% surcharge).</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="modifiers-grid">
        </div>
      </div>
    </div>

    <!-- Section 3: Multi-Service Discount -->
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl mb-4">
      <div class="px-5 py-4 border-b border-neutral-800 flex items-center justify-between cursor-pointer" onclick="toggleSettingsSection('multiDiscount')">
        <h3 class="text-white text-sm font-semibold">Multi-Service Discount</h3>
        <svg id="chevron-multiDiscount" class="w-4 h-4 text-neutral-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </div>
      <div id="section-multiDiscount" class="p-5">
        <p class="text-neutral-500 text-xs mb-4">Discount applied when a customer books multiple services at once.</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Services Required</label>
            <input type="number" id="settings-msd-threshold" min="2" max="10" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Discount %</label>
            <input type="number" id="settings-msd-discount" min="1" max="50" step="1" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
          </div>
        </div>
      </div>
    </div>

    <!-- Section 4: Lead Scoring & Qualification -->
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl mb-4">
      <div class="px-5 py-4 border-b border-neutral-800 flex items-center justify-between cursor-pointer" onclick="toggleSettingsSection('leadScoring')">
        <h3 class="text-white text-sm font-semibold">Lead Scoring & Qualification</h3>
        <span class="text-[10px] text-neutral-600 mr-2">Advanced</span>
        <svg id="chevron-leadScoring" class="w-4 h-4 text-neutral-500 transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </div>
      <div id="section-leadScoring" class="p-5 hidden">
        <p class="text-neutral-500 text-xs mb-4">Configure how leads are scored and classified. Higher scores = hotter leads.</p>

        <h4 class="text-neutral-400 text-xs font-semibold mb-3 uppercase tracking-wider">Scoring Weights (points)</h4>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 mb-6" id="lead-scoring-grid">
        </div>

        <h4 class="text-neutral-400 text-xs font-semibold mb-3 uppercase tracking-wider">Qualification Thresholds (score needed)</h4>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6" id="qualification-grid">
        </div>

        <h4 class="text-neutral-400 text-xs font-semibold mb-3 uppercase tracking-wider">Conversion Likelihood (0-1)</h4>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" id="conversion-grid">
        </div>
      </div>
    </div>

    <!-- Test Estimate Preview -->
    <div class="bg-neutral-900 border border-lime-900/30 rounded-xl mb-4">
      <div class="px-5 py-4 border-b border-neutral-800">
        <h3 class="text-white text-sm font-semibold">Test Estimate Preview</h3>
        <p class="text-neutral-500 text-xs mt-1">See what estimate your current settings would produce.</p>
      </div>
      <div class="p-5">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Service</label>
            <select id="test-service" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
            </select>
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Property Size</label>
            <select id="test-size" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Modifiers</label>
            <div class="flex flex-wrap gap-2 mt-2">
              <label class="flex items-center gap-1 text-neutral-400 text-xs cursor-pointer"><input type="checkbox" id="test-mod-first" class="accent-lime-400"> First time</label>
              <label class="flex items-center gap-1 text-neutral-400 text-xs cursor-pointer"><input type="checkbox" id="test-mod-soiled" class="accent-lime-400"> Soiled</label>
              <label class="flex items-center gap-1 text-neutral-400 text-xs cursor-pointer"><input type="checkbox" id="test-mod-access" class="accent-lime-400"> Difficult access</label>
              <label class="flex items-center gap-1 text-neutral-400 text-xs cursor-pointer"><input type="checkbox" id="test-mod-height" class="accent-lime-400"> Height work</label>
              <label class="flex items-center gap-1 text-neutral-400 text-xs cursor-pointer"><input type="checkbox" id="test-mod-urgent" class="accent-lime-400"> Urgent</label>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button onclick="runTestEstimate()" class="bg-lime-400 hover:bg-lime-300 text-black font-semibold px-4 py-2 rounded-lg text-xs transition-colors">Calculate Preview</button>
          <div id="test-estimate-result" class="text-white text-sm font-semibold"></div>
        </div>
      </div>
    </div>

    <!-- Change History -->
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl">
      <div class="px-5 py-4 border-b border-neutral-800 flex items-center justify-between cursor-pointer" onclick="toggleSettingsSection('history')">
        <h3 class="text-white text-sm font-semibold">Change History</h3>
        <svg id="chevron-history" class="w-4 h-4 text-neutral-500 transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </div>
      <div id="section-history" class="p-5 hidden">
        <div id="pricing-history-list" class="space-y-2">
          <p class="text-neutral-600 text-xs text-center py-4">No changes recorded yet.</p>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- ============ CHAT DETAIL MODAL ============ -->
<div id="chatModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-8 overflow-y-auto" onclick="if(event.target===this)closeChatModal()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-lg w-full fade-in my-4">
    <div class="flex items-center justify-between px-6 py-4 border-b border-neutral-800">
      <div>
        <h2 class="text-white font-semibold text-sm" id="chatModal-title">Conversation</h2>
        <p class="text-neutral-500 text-xs mt-1" id="chatModal-meta"></p>
      </div>
      <button onclick="closeChatModal()" class="text-neutral-500 hover:text-white">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div id="chatModal-messages" class="p-4 max-h-96 overflow-y-auto space-y-3"></div>
    <div id="chatModal-lead" class="hidden px-6 py-3 border-t border-neutral-800 bg-neutral-950/50">
      <div class="flex items-center gap-2 text-xs">
        <span class="w-2 h-2 rounded-full bg-lime-400"></span>
        <span class="text-lime-400 font-semibold">Lead Captured</span>
      </div>
      <div class="text-neutral-400 text-xs mt-1" id="chatModal-leadInfo"></div>
    </div>
  </div>
</div>

<!-- ============ QUOTE DETAIL MODAL ============ -->
<div id="quoteModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-8 overflow-y-auto" onclick="if(event.target===this)closeModal()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-3xl w-full fade-in my-4">

    <!-- Modal Header with Quick Actions -->
    <div class="sticky top-0 bg-neutral-900 border-b border-neutral-800 px-6 py-4 rounded-t-2xl flex items-center justify-between z-10">
      <div class="flex items-center gap-3">
        <div id="modal-qual-badge" class="w-3 h-3 rounded-full"></div>
        <h2 class="text-white font-semibold text-sm" id="modal-name"></h2>
        <!-- Quick Actions -->
        <div class="flex items-center gap-1 ml-2" id="modal-quick-actions">
          <a id="qa-phone" href="#" title="Call customer" class="p-1.5 rounded-lg bg-neutral-800 hover:bg-neutral-700 text-neutral-400 hover:text-green-400 transition-colors">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
          </a>
          <a id="qa-whatsapp" href="#" target="_blank" title="WhatsApp customer" class="p-1.5 rounded-lg bg-neutral-800 hover:bg-neutral-700 text-neutral-400 hover:text-green-400 transition-colors">
            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.625.846 5.059 2.284 7.034L.789 23.492a.5.5 0 00.611.611l4.458-1.495A11.96 11.96 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-2.4 0-4.637-.84-6.396-2.244l-.39-.312-2.673.896.896-2.673-.312-.39A9.96 9.96 0 012 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"/></svg>
          </a>
          <a id="qa-email" href="#" title="Email customer" class="p-1.5 rounded-lg bg-neutral-800 hover:bg-neutral-700 text-neutral-400 hover:text-blue-400 transition-colors">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          </a>
        </div>
      </div>
      <button onclick="closeModal()" class="text-neutral-500 hover:text-white transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>

    <div class="p-6 space-y-6">

      <!-- Section 1: Customer Info + Preferences (read-only) -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div>
          <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Customer</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-neutral-500">Name</span><span class="text-white" id="modal-fullname"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Email</span><a class="text-lime-400 hover:underline" id="modal-email"></a></div>
            <div class="flex justify-between"><span class="text-neutral-500">Phone</span><a class="text-lime-400 hover:underline" id="modal-phone"></a></div>
            <div class="flex justify-between"><span class="text-neutral-500">Address</span><span class="text-white" id="modal-address"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Postcode</span><span class="text-white" id="modal-postcode"></span></div>
          </div>
        </div>
        <div>
          <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Preferences</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-neutral-500">Contact via</span><span class="text-white" id="modal-contact"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Best time</span><span class="text-white" id="modal-time"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Reminders</span><span class="text-white" id="modal-reminders"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Accepted</span><span id="modal-accepted"></span></div>
          </div>
        </div>
      </div>

      <!-- Section 2: Estimate & Pricing (editable) -->
      <div class="bg-black border border-neutral-800 rounded-xl p-4">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-3">
          <div id="modal-services" class="flex flex-wrap gap-1.5"></div>
          <div class="text-right">
            <div class="text-[10px] text-neutral-500 uppercase">Auto Estimate</div>
            <div class="text-2xl font-bold text-lime-400" id="modal-estimate"></div>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-4 text-xs mb-4">
          <div><span class="text-neutral-500">Score </span><span class="text-white font-semibold" id="modal-score"></span></div>
          <div><span class="text-neutral-500">Confidence </span><span class="text-white" id="modal-confidence"></span></div>
          <div><span class="text-neutral-500">Qualification </span><span id="modal-qualification"></span></div>
        </div>
        <!-- Editable pricing -->
        <div class="border-t border-neutral-800 pt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Final Price (£)</label>
            <input type="number" id="modal-final-price" placeholder="Set after discussion"
              class="w-full mt-1 bg-neutral-900 border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none"
              onchange="patchQuote('final_value', this.value ? parseFloat(this.value) : null)">
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Est. Min (£)</label>
            <input type="number" id="modal-est-min" placeholder="Auto"
              class="w-full mt-1 bg-neutral-900 border border-neutral-700 text-neutral-400 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none"
              onchange="patchQuote('estimated_value_min', this.value ? parseFloat(this.value) : null)">
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Est. Max (£)</label>
            <input type="number" id="modal-est-max" placeholder="Auto"
              class="w-full mt-1 bg-neutral-900 border border-neutral-700 text-neutral-400 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none"
              onchange="patchQuote('estimated_value_max', this.value ? parseFloat(this.value) : null)">
          </div>
        </div>
      </div>

      <!-- Section 3: Lead Management (editable) -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Priority</h3>
          <div class="flex gap-2" id="priorityButtons"></div>
        </div>
        <div>
          <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Assigned To</h3>
          <select id="modal-assigned-to"
            class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none"
            onchange="patchQuote('assigned_to', this.value || null)">
            <option value="">Unassigned</option>
          </select>
        </div>
      </div>

      <!-- Section 4: Status -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Status</h3>
        <div class="flex flex-wrap gap-2" id="statusButtons"></div>
      </div>

      <!-- Section 5: Availability Calendar -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Availability</h3>
          <div class="flex items-center gap-2">
            <span class="text-[10px] text-neutral-600">Capacity:</span>
            <input type="number" id="modal-capacity" min="1" max="20" value="4"
              class="w-12 bg-black border border-neutral-700 text-neutral-400 text-[11px] px-2 py-1 rounded text-center focus:border-lime-400 focus:outline-none"
              onchange="localStorage.setItem('dailyCapacity', this.value); refreshAvailabilityCalendar()">
            <span class="text-[10px] text-neutral-600">jobs/day</span>
          </div>
        </div>
        <div class="bg-black border border-neutral-800 rounded-xl p-4">
          <div id="modal-calendar-container"></div>
          <div id="modal-calendar-dayinfo" class="hidden mt-3 pt-3 border-t border-neutral-800">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs text-neutral-400" id="modal-calendar-daylabel"></span>
              <span class="text-lime-400 text-[11px] font-semibold" id="modal-book-date-badge">
                <svg class="w-3 h-3 inline -mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                Selected
              </span>
            </div>
            <div id="modal-calendar-dayjobs" class="space-y-1 text-xs max-h-24 overflow-y-auto"></div>
          </div>
        </div>
        <div class="flex items-center gap-3 mt-2 text-[10px] text-neutral-600">
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span> Open</span>
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500 inline-block"></span> Filling</span>
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span> Full</span>
        </div>
      </div>

      <!-- Booking Bar -->
      <div class="bg-neutral-900/50 border border-neutral-800 rounded-xl p-4 space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Time</label>
            <select id="modal-book-time" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
              <option value="07:00">07:00</option>
              <option value="07:30">07:30</option>
              <option value="08:00">08:00</option>
              <option value="08:30">08:30</option>
              <option value="09:00" selected>09:00</option>
              <option value="09:30">09:30</option>
              <option value="10:00">10:00</option>
              <option value="10:30">10:30</option>
              <option value="11:00">11:00</option>
              <option value="11:30">11:30</option>
              <option value="12:00">12:00</option>
              <option value="12:30">12:30</option>
              <option value="13:00">13:00</option>
              <option value="13:30">13:30</option>
              <option value="14:00">14:00</option>
              <option value="14:30">14:30</option>
              <option value="15:00">15:00</option>
              <option value="15:30">15:30</option>
              <option value="16:00">16:00</option>
              <option value="16:30">16:30</option>
              <option value="17:00">17:00</option>
              <option value="17:30">17:30</option>
              <option value="18:00">18:00</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Duration</label>
            <select id="modal-book-duration" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
              <option value="">Not set</option>
              <option value="1 hour">1 hour</option>
              <option value="2 hours">2 hours</option>
              <option value="2-3 hours">2-3 hours</option>
              <option value="3-4 hours">3-4 hours</option>
              <option value="Half day">Half day</option>
              <option value="Full day">Full day</option>
            </select>
          </div>
        </div>
        <button onclick="bookThisJob()" class="w-full bg-lime-400 hover:bg-lime-300 text-black font-semibold py-3 rounded-xl text-sm transition-colors flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          Book This Job
        </button>
      </div>

      <!-- Section 6: Activity Log -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Activity Log</h3>
        <div class="flex gap-2 mb-3">
          <input type="text" id="modal-activity-input" placeholder="Log a note... (e.g. Called customer, discussed pricing)"
            class="flex-1 bg-black border border-neutral-700 text-white text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none"
            onkeydown="if(event.key==='Enter')addManualActivity()">
          <button onclick="addManualActivity()" class="bg-neutral-800 hover:bg-neutral-700 text-neutral-300 text-xs px-3 py-2 rounded-lg transition-colors">Log</button>
        </div>
        <div id="modal-activity-feed" class="space-y-2 max-h-48 overflow-y-auto text-xs">
          <div class="text-neutral-600 text-center py-4">Loading activity...</div>
        </div>
      </div>

      <!-- Section 7: Admin Notes -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Admin Notes</h3>
        <textarea id="modal-notes" rows="3"
          class="w-full bg-black border border-neutral-700 text-white text-sm px-4 py-3 rounded-lg resize-none focus:border-lime-400 focus:outline-none transition-colors"
          placeholder="Add notes..."></textarea>
        <button onclick="saveNotes()" class="mt-2 bg-lime-400 hover:bg-lime-300 text-black text-xs font-semibold px-4 py-2 rounded-lg transition-colors">
          Save Notes
        </button>
      </div>

      <!-- Section 8: Attachments -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Attachments</h3>
        <div id="modal-attachments-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-2 mb-3"></div>
        <div id="modal-upload-zone" class="border-2 border-dashed border-neutral-700 rounded-xl p-4 text-center hover:border-neutral-500 transition-colors cursor-pointer"
          onclick="document.getElementById('modal-file-input').click()"
          ondragover="event.preventDefault(); this.classList.add('border-lime-400')"
          ondragleave="this.classList.remove('border-lime-400')"
          ondrop="event.preventDefault(); this.classList.remove('border-lime-400'); handleAttachmentDrop(event)">
          <svg class="w-6 h-6 mx-auto text-neutral-600 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          <div class="text-xs text-neutral-500">Drop files or click to upload</div>
          <div class="text-[10px] text-neutral-600 mt-1">JPG, PNG, WebP, PDF (max 10MB)</div>
        </div>
        <input type="file" id="modal-file-input" class="hidden" accept="image/jpeg,image/png,image/webp,application/pdf" multiple onchange="handleAttachmentUpload(this.files)">
        <div id="modal-upload-progress" class="hidden mt-2 text-xs text-neutral-400 text-center"></div>
      </div>

      <!-- Section 9: Timeline -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Timeline</h3>
        <div class="space-y-2 text-xs" id="modal-timeline"></div>
      </div>

      <!-- Section 10: Form Answers -->
      <details class="bg-black border border-neutral-800 rounded-xl">
        <summary class="px-4 py-3 text-xs font-semibold text-neutral-400 cursor-pointer hover:text-white transition-colors">View Full Form Data</summary>
        <pre id="modal-answers" class="px-4 pb-4 text-[11px] text-neutral-500 overflow-x-auto whitespace-pre-wrap"></pre>
      </details>
    </div>
  </div>
</div>

<!-- ============ ADD JOB MODAL ============ -->
<div id="jobModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-8 overflow-y-auto" onclick="if(event.target===this)closeJobModal()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-lg w-full fade-in my-4">
    <div class="border-b border-neutral-800 px-6 py-4 rounded-t-2xl flex items-center justify-between">
      <h2 class="text-white font-semibold text-sm" id="jobModalTitle">Add Job</h2>
      <button onclick="closeJobModal()" class="text-neutral-500 hover:text-white transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>

    <!-- Modal Tabs -->
    <div class="flex border-b border-neutral-800">
      <button onclick="switchJobTab('manual')" id="jobTab-manual" class="flex-1 px-4 py-3 text-xs font-semibold text-lime-400 border-b-2 border-lime-400">Manual</button>
      <button onclick="switchJobTab('fromQuote')" id="jobTab-fromQuote" class="flex-1 px-4 py-3 text-xs font-semibold text-neutral-500 border-b-2 border-transparent hover:text-neutral-300">From Quote</button>
    </div>

    <!-- Manual Tab -->
    <div id="jobContent-manual" class="p-6 space-y-4">
      <!-- Customer Search -->
      <div class="relative">
        <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Search Existing Customer</label>
        <input type="text" id="job-cust-search" placeholder="Type name, email, phone..." class="w-full mt-1 bg-neutral-800 border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" oninput="debouncedJobCustSearch()" autocomplete="off">
        <div id="job-cust-results" class="hidden absolute left-0 right-0 top-full mt-1 bg-neutral-800 border border-neutral-700 rounded-lg max-h-48 overflow-y-auto z-20"></div>
        <input type="hidden" id="job-customer-id" value="">
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div class="col-span-2">
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Customer Name *</label>
          <input type="text" id="job-name" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Phone</label>
          <input type="text" id="job-phone" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Email</label>
          <input type="email" id="job-email" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        </div>
        <div class="col-span-2">
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Address *</label>
          <input type="text" id="job-address" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Postcode *</label>
          <input type="text" id="job-postcode" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Service *</label>
          <select id="job-service" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
            <option value="">Select service</option>
            <option value="Roof Cleaning">Roof Cleaning</option>
            <option value="Driveway Cleaning">Driveway Cleaning</option>
            <option value="Gutter Cleaning">Gutter Cleaning</option>
            <option value="Softwash">Softwash</option>
            <option value="Render Cleaning">Render Cleaning</option>
            <option value="Window Cleaning">Window Cleaning</option>
            <option value="Solar Panel Cleaning">Solar Panel Cleaning</option>
            <option value="Patio Cleaning">Patio Cleaning</option>
            <option value="Decking Cleaning">Decking Cleaning</option>
            <option value="Grass Cutting">Grass Cutting</option>
            <option value="Fence Cleaning">Fence Cleaning</option>
            <option value="Conservatory Cleaning">Conservatory Cleaning</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Date *</label>
          <input type="text" id="job-date" placeholder="Select date" readonly class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none cursor-pointer">
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Time</label>
          <select id="job-timeslot" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
            <option value="07:00">07:00</option>
            <option value="07:30">07:30</option>
            <option value="08:00">08:00</option>
            <option value="08:30">08:30</option>
            <option value="09:00" selected>09:00</option>
            <option value="09:30">09:30</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
          </select>
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Assigned To</label>
          <select id="job-assigned" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
            <option value="">Unassigned</option>
          </select>
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Duration</label>
          <select id="job-duration" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
            <option value="">Not set</option>
            <option value="30 mins">30 mins</option>
            <option value="1 hour">1 hour</option>
            <option value="1.5 hours">1.5 hours</option>
            <option value="2 hours">2 hours</option>
            <option value="2-3 hours">2-3 hours</option>
            <option value="3-4 hours">3-4 hours</option>
            <option value="Half day">Half day</option>
            <option value="Full day">Full day</option>
          </select>
        </div>
        <div>
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Value (£)</label>
          <input type="number" id="job-value" step="0.01" min="0" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="0.00">
        </div>
        <div class="col-span-2">
          <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Notes</label>
          <textarea id="job-notes" rows="2" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg resize-none focus:border-lime-400 focus:outline-none" placeholder="Optional notes..."></textarea>
        </div>
        <!-- Recurring toggle -->
        <div class="col-span-2" id="recurringToggleWrap">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="job-recurring-toggle" onchange="toggleRecurringFields()" class="w-4 h-4 rounded bg-black border-neutral-600 text-lime-400 focus:ring-lime-400 focus:ring-offset-0">
            <span class="text-xs text-neutral-400">Make this a recurring job</span>
          </label>
        </div>
        <div id="recurringFields" class="col-span-2 hidden grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Repeat Every</label>
            <select id="job-repeat" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
              <option value="weekly">Weekly</option>
              <option value="fortnightly">Fortnightly</option>
              <option value="3_weeks">Every 3 weeks</option>
              <option value="4_weeks">Every 4 weeks</option>
              <option value="6_weeks">Every 6 weeks</option>
              <option value="8_weeks">Every 8 weeks</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">End Date (optional)</label>
            <input type="text" id="job-enddate" placeholder="No end date" readonly class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none cursor-pointer">
          </div>
        </div>
      </div>
      <button onclick="submitJob()" class="w-full bg-lime-400 hover:bg-lime-300 text-black font-semibold py-3 rounded-lg text-sm transition-colors">Create Job</button>
    </div>

    <!-- From Quote Tab -->
    <div id="jobContent-fromQuote" class="hidden p-6 space-y-4">
      <div class="text-xs text-neutral-500 mb-2">Select an accepted/booked quote to create a job from:</div>
      <div id="quotePickerLoading" class="text-center py-4 text-neutral-500 text-xs">Loading quotes...</div>
      <div id="quotePickerList" class="space-y-2 max-h-60 overflow-y-auto"></div>
      <div id="quotePickerEmpty" class="hidden text-center py-4 text-neutral-600 text-xs">No accepted/booked quotes found</div>
      <div id="quotePickerSelected" class="hidden space-y-3">
        <div class="bg-black border border-lime-400/30 rounded-xl p-3 text-xs">
          <div class="text-lime-400 font-semibold mb-1" id="qp-name"></div>
          <div class="text-neutral-400" id="qp-details"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Date *</label>
            <input type="text" id="qp-date" placeholder="Select date" readonly class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none cursor-pointer">
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Time</label>
            <select id="qp-timeslot" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
              <option value="07:00">07:00</option>
              <option value="07:30">07:30</option>
              <option value="08:00">08:00</option>
              <option value="08:30">08:30</option>
              <option value="09:00" selected>09:00</option>
              <option value="09:30">09:30</option>
              <option value="10:00">10:00</option>
              <option value="10:30">10:30</option>
              <option value="11:00">11:00</option>
              <option value="11:30">11:30</option>
              <option value="12:00">12:00</option>
              <option value="12:30">12:30</option>
              <option value="13:00">13:00</option>
              <option value="13:30">13:30</option>
              <option value="14:00">14:00</option>
              <option value="14:30">14:30</option>
              <option value="15:00">15:00</option>
              <option value="15:30">15:30</option>
              <option value="16:00">16:00</option>
              <option value="16:30">16:30</option>
              <option value="17:00">17:00</option>
              <option value="17:30">17:30</option>
              <option value="18:00">18:00</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Assigned To</label>
            <select id="qp-assigned" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
              <option value="">Unassigned</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Duration</label>
            <select id="qp-duration" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
              <option value="">Not set</option>
              <option value="1 hour">1 hour</option>
              <option value="2 hours">2 hours</option>
              <option value="2-3 hours">2-3 hours</option>
              <option value="3-4 hours">3-4 hours</option>
              <option value="Half day">Half day</option>
              <option value="Full day">Full day</option>
            </select>
          </div>
        </div>
        <button onclick="submitJobFromQuote()" class="w-full bg-lime-400 hover:bg-lime-300 text-black font-semibold py-3 rounded-lg text-sm transition-colors">Create Job from Quote</button>
      </div>
    </div>
  </div>
</div>

<!-- ============ JOB DETAIL MODAL ============ -->
<div id="jobDetailModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-8 overflow-y-auto" onclick="if(event.target===this)closeJobDetail()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-lg w-full fade-in my-4">
    <div class="border-b border-neutral-800 px-6 py-4 rounded-t-2xl flex items-center justify-between">
      <h2 class="text-white font-semibold text-sm" id="jd-title">Job Details</h2>
      <button onclick="closeJobDetail()" class="text-neutral-500 hover:text-white transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6 space-y-5">
      <!-- Customer Info (read-only) -->
      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span class="text-neutral-500">Customer</span><span class="text-white" id="jd-name"></span></div>
        <div class="flex justify-between"><span class="text-neutral-500">Phone</span><a class="text-lime-400 hover:underline" id="jd-phone"></a></div>
        <div class="flex justify-between"><span class="text-neutral-500">Address</span><span class="text-white" id="jd-address"></span></div>
        <div class="flex justify-between"><span class="text-neutral-500">Service</span><span class="text-white" id="jd-service"></span></div>
      </div>

      <!-- Scheduling (editable) -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Scheduling</h3>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-600 font-semibold">Date</label>
            <input type="text" id="jd-date" readonly class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none cursor-pointer">
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-600 font-semibold">Time</label>
            <select id="jd-time" onchange="patchJob('time_slot', this.value)" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
              <option value="07:00">07:00</option>
              <option value="07:30">07:30</option>
              <option value="08:00">08:00</option>
              <option value="08:30">08:30</option>
              <option value="09:00">09:00</option>
              <option value="09:30">09:30</option>
              <option value="10:00">10:00</option>
              <option value="10:30">10:30</option>
              <option value="11:00">11:00</option>
              <option value="11:30">11:30</option>
              <option value="12:00">12:00</option>
              <option value="12:30">12:30</option>
              <option value="13:00">13:00</option>
              <option value="13:30">13:30</option>
              <option value="14:00">14:00</option>
              <option value="14:30">14:30</option>
              <option value="15:00">15:00</option>
              <option value="15:30">15:30</option>
              <option value="16:00">16:00</option>
              <option value="16:30">16:30</option>
              <option value="17:00">17:00</option>
              <option value="17:30">17:30</option>
              <option value="18:00">18:00</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-600 font-semibold">Assigned To</label>
            <select id="jd-assigned" onchange="patchJob('assigned_to', this.value || null)" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
              <option value="">Unassigned</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] uppercase tracking-wider text-neutral-600 font-semibold">Duration</label>
            <select id="jd-duration" onchange="patchJob('estimated_duration', this.value || null)" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
              <option value="">Not set</option>
              <option value="30 mins">30 mins</option>
              <option value="1 hour">1 hour</option>
              <option value="1.5 hours">1.5 hours</option>
              <option value="2 hours">2 hours</option>
              <option value="2-3 hours">2-3 hours</option>
              <option value="3-4 hours">3-4 hours</option>
              <option value="Half day">Half day</option>
              <option value="Full day">Full day</option>
            </select>
          </div>
          <div class="col-span-2">
            <label class="text-[10px] uppercase tracking-wider text-neutral-600 font-semibold">Value (£)</label>
            <input type="number" id="jd-value" step="0.01" min="0" placeholder="0.00" onchange="patchJob('job_value', parseFloat(this.value) || 0)" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
          </div>
        </div>
      </div>

      <!-- Notify Customer (opt-in) -->
      <div id="jd-notifySection" class="hidden">
        <button onclick="notifyCustomerReschedule()" id="jd-notifyBtn" class="w-full flex items-center justify-center gap-2 bg-neutral-800 hover:bg-neutral-700 text-neutral-300 hover:text-white border border-neutral-700 py-2.5 rounded-lg text-xs font-medium transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          Notify Customer of Schedule Change
        </button>
        <div id="jd-notifyStatus" class="hidden text-center text-[10px] text-neutral-500 mt-1"></div>
      </div>

      <!-- Status -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Status</h3>
        <div class="flex flex-wrap gap-2" id="jd-statusButtons"></div>
      </div>

      <!-- Payment (shown when completed) -->
      <div id="jd-paymentSection" class="hidden">
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Payment</h3>
        <div class="flex flex-wrap gap-2 mb-3" id="jd-paymentButtons"></div>
        <div id="jd-methodSection" class="hidden">
          <div class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Method</div>
          <div class="flex flex-wrap gap-2 mb-3" id="jd-methodButtons"></div>
          <div id="jd-amountSection" class="hidden">
            <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Amount Paid (£)</label>
            <input type="number" id="jd-amountPaid" step="0.01" min="0" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
          </div>
          <button onclick="savePayment()" class="mt-3 bg-lime-400 hover:bg-lime-300 text-black text-xs font-semibold px-4 py-2 rounded-lg transition-colors">Save Payment</button>
        </div>
      </div>

      <!-- Invoice (shown when completed) -->
      <div id="jd-invoiceSection" class="hidden">
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Invoice</h3>
        <div id="jd-invoiceContent"></div>
      </div>

      <!-- Notes -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Notes</h3>
        <textarea id="jd-notes" rows="2" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg resize-none focus:border-lime-400 focus:outline-none" placeholder="Job notes..."></textarea>
        <button onclick="saveJobNotes()" class="mt-2 bg-neutral-800 hover:bg-neutral-700 text-white text-xs font-medium px-4 py-2 rounded-lg transition-colors">Save Notes</button>
      </div>

      <!-- Actions -->
      <div class="flex gap-2 pt-2 border-t border-neutral-800">
        <button onclick="deleteCurrentJob()" class="text-red-400 hover:text-red-300 text-xs transition-colors">Delete Job</button>
      </div>
    </div>
  </div>
</div>

<!-- ============ ADD TEAM MEMBER MODAL ============ -->
<div id="teamModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="if(event.target===this)closeTeamModal()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-sm w-full fade-in p-6 space-y-4">
    <h2 class="text-white font-semibold text-sm">Add Team Member</h2>
    <div>
      <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Name *</label>
      <input type="text" id="team-name" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="e.g. Dan">
    </div>
    <div>
      <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Colour</label>
      <div class="flex gap-2 mt-1">
        <button onclick="pickTeamColor('#a3e635')" class="w-8 h-8 rounded-full bg-lime-400 border-2 border-transparent hover:border-white team-color-btn" data-color="#a3e635"></button>
        <button onclick="pickTeamColor('#60a5fa')" class="w-8 h-8 rounded-full bg-blue-400 border-2 border-transparent hover:border-white team-color-btn" data-color="#60a5fa"></button>
        <button onclick="pickTeamColor('#f97316')" class="w-8 h-8 rounded-full bg-orange-400 border-2 border-transparent hover:border-white team-color-btn" data-color="#f97316"></button>
        <button onclick="pickTeamColor('#f43f5e')" class="w-8 h-8 rounded-full bg-rose-500 border-2 border-transparent hover:border-white team-color-btn" data-color="#f43f5e"></button>
        <button onclick="pickTeamColor('#a78bfa')" class="w-8 h-8 rounded-full bg-violet-400 border-2 border-transparent hover:border-white team-color-btn" data-color="#a78bfa"></button>
        <button onclick="pickTeamColor('#fbbf24')" class="w-8 h-8 rounded-full bg-amber-400 border-2 border-transparent hover:border-white team-color-btn" data-color="#fbbf24"></button>
      </div>
    </div>
    <button onclick="submitTeamMember()" class="w-full bg-lime-400 hover:bg-lime-300 text-black font-semibold py-3 rounded-lg text-sm transition-colors">Add Member</button>
  </div>
</div>

<!-- ============ CUSTOMER PROFILE MODAL ============ -->
<div id="custProfileModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-8 overflow-y-auto" onclick="if(event.target===this)closeCustProfile()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-2xl w-full fade-in my-4">
    <div class="sticky top-0 bg-neutral-900 border-b border-neutral-800 px-6 py-4 rounded-t-2xl flex items-center justify-between z-10">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-lime-400 flex items-center justify-center text-black font-bold text-sm" id="cp-avatar"></div>
        <div>
          <h2 class="text-white font-semibold text-sm" id="cp-name"></h2>
          <div class="text-neutral-500 text-[10px]" id="cp-since"></div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-lime-400 font-bold text-lg" id="cp-total-spent"></span>
        <button onclick="closeCustProfile()" class="text-neutral-500 hover:text-white transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
    </div>

    <div class="p-6 space-y-6">
      <!-- Contact Details -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Contact</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-neutral-500">Email</span><a class="text-lime-400 hover:underline" id="cp-email"></a></div>
            <div class="flex justify-between"><span class="text-neutral-500">Phone</span><a class="text-lime-400 hover:underline" id="cp-phone"></a></div>
            <div class="flex justify-between"><span class="text-neutral-500">Address</span><span class="text-white" id="cp-address"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Postcode</span><span class="text-white" id="cp-postcode"></span></div>
          </div>
        </div>
        <div>
          <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Stats</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-neutral-500">Total Jobs</span><span class="text-white" id="cp-total-jobs"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Last Job</span><span class="text-white" id="cp-last-job"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Last Follow-Up</span><span class="text-white" id="cp-last-followup"></span></div>
          </div>
        </div>
      </div>

      <!-- Tags -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Tags</h3>
        <div class="flex flex-wrap gap-2" id="cp-tags"></div>
        <div class="flex gap-2 mt-2">
          <input type="text" id="cp-new-tag" placeholder="Add tag..." class="bg-black border border-neutral-700 text-white text-xs px-3 py-1.5 rounded-lg focus:border-lime-400 focus:outline-none" onkeydown="if(event.key==='Enter')addCustTag()">
          <button onclick="addCustTag()" class="bg-neutral-800 hover:bg-neutral-700 text-neutral-300 text-xs px-3 py-1.5 rounded-lg">Add</button>
        </div>
      </div>

      <!-- Job History -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Job History</h3>
        <div id="cp-jobs" class="space-y-2 max-h-60 overflow-y-auto"></div>
        <div id="cp-no-jobs" class="hidden text-neutral-600 text-xs">No jobs yet</div>
      </div>

      <!-- Invoice History -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Invoices</h3>
        <div id="cp-invoices" class="space-y-2 max-h-40 overflow-y-auto"></div>
        <div id="cp-no-invoices" class="hidden text-neutral-600 text-xs">No invoices yet</div>
      </div>

      <!-- Quote History -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Quote History</h3>
        <div id="cp-quotes" class="space-y-2 max-h-40 overflow-y-auto"></div>
        <div id="cp-no-quotes" class="hidden text-neutral-600 text-xs">No quotes yet</div>
      </div>

      <!-- Notes -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Notes</h3>
        <textarea id="cp-notes" rows="3" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2.5 rounded-xl resize-none focus:border-lime-400 focus:outline-none" placeholder="Add notes about this customer..."></textarea>
        <button onclick="saveCustNotes()" class="mt-2 bg-neutral-800 hover:bg-neutral-700 text-white font-medium py-2 px-4 rounded-lg text-xs transition-colors">Save Notes</button>
      </div>

      <!-- Actions -->
      <div class="flex flex-wrap gap-2 pt-2 border-t border-neutral-800">
        <button onclick="addJobFromCustomer()" class="bg-lime-400 hover:bg-lime-300 text-black font-semibold px-4 py-2 rounded-lg text-xs transition-colors">+ Add Job</button>
        <button onclick="openFollowUpModal()" class="bg-neutral-800 hover:bg-neutral-700 text-white font-medium px-4 py-2 rounded-lg text-xs transition-colors">Send Follow-Up Email</button>
        <button onclick="toggleEditCustomer()" class="bg-neutral-800 hover:bg-neutral-700 text-white font-medium px-4 py-2 rounded-lg text-xs transition-colors">Edit Details</button>
      </div>

      <!-- Edit Details (hidden by default) -->
      <div id="cp-edit-section" class="hidden border-t border-neutral-800 pt-4 space-y-3">
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Edit Contact Details</h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="col-span-2"><input type="text" id="cp-edit-name" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="Name"></div>
          <div><input type="email" id="cp-edit-email" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="Email"></div>
          <div><input type="text" id="cp-edit-phone" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="Phone"></div>
          <div class="col-span-2"><input type="text" id="cp-edit-address" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="Address"></div>
          <div><input type="text" id="cp-edit-postcode" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="Postcode"></div>
        </div>
        <div class="flex gap-2">
          <button onclick="saveEditCustomer()" class="bg-lime-400 hover:bg-lime-300 text-black font-semibold px-4 py-2 rounded-lg text-xs transition-colors">Save Changes</button>
          <button onclick="toggleEditCustomer()" class="bg-neutral-800 hover:bg-neutral-700 text-white font-medium px-4 py-2 rounded-lg text-xs transition-colors">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============ FOLLOW-UP EMAIL MODAL ============ -->
<div id="followUpModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[55] flex items-center justify-center p-4" onclick="if(event.target===this)closeFollowUp()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-lg w-full fade-in">
    <div class="border-b border-neutral-800 px-6 py-4 flex items-center justify-between">
      <h2 class="text-white font-semibold text-sm">Send Follow-Up Email</h2>
      <button onclick="closeFollowUp()" class="text-neutral-500 hover:text-white transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6 space-y-4">
      <div class="text-xs text-neutral-500">Sending to: <span class="text-lime-400" id="fu-recipient"></span></div>
      <div>
        <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Template</label>
        <select id="fu-template" onchange="applyTemplate()" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
          <option value="">Choose a template...</option>
          <optgroup label="Follow-Up">
            <option value="seasonal">Seasonal Reminder</option>
            <option value="discount">10% Discount Offer</option>
            <option value="yearly">Yearly Upkeep</option>
            <option value="checkin">General Check-In</option>
          </optgroup>
          <optgroup label="Feedback &amp; Re-engagement">
            <option value="feedback_experience">How was the experience?</option>
            <option value="feedback_price">Was it the price?</option>
            <option value="feedback_general">What could we do better?</option>
            <option value="reengagement_pricing">We've improved our pricing</option>
          </optgroup>
        </select>
      </div>
      <div>
        <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Subject</label>
        <input type="text" id="fu-subject" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="Email subject line">
      </div>
      <div>
        <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Message</label>
        <textarea id="fu-body" rows="6" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2.5 rounded-xl resize-none focus:border-lime-400 focus:outline-none" placeholder="Write your message..."></textarea>
        <div class="text-[10px] text-neutral-600 mt-1">Use {name} to insert customer name</div>
      </div>
      <button onclick="sendFollowUpFromModal()" class="w-full bg-lime-400 hover:bg-lime-300 text-black font-semibold py-3 rounded-lg text-sm transition-colors">Send Email</button>
    </div>
  </div>
</div>

<!-- ============ ADD CUSTOMER MODAL ============ -->
<div id="addCustomerModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[55] flex items-center justify-center p-4" onclick="if(event.target===this)closeAddCustomerModal()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-lg w-full fade-in">
    <div class="border-b border-neutral-800 px-6 py-4 flex items-center justify-between">
      <h2 class="text-white font-semibold text-sm">Add Customer</h2>
      <button onclick="closeAddCustomerModal()" class="text-neutral-500 hover:text-white transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6 space-y-4">
      <div>
        <label class="block text-neutral-400 text-xs mb-1">Name <span class="text-red-400">*</span></label>
        <input type="text" id="ac-name" class="w-full bg-neutral-800 border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="John Smith">
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-neutral-400 text-xs mb-1">Email</label>
          <input type="email" id="ac-email" class="w-full bg-neutral-800 border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="john@example.com">
        </div>
        <div>
          <label class="block text-neutral-400 text-xs mb-1">Phone</label>
          <input type="tel" id="ac-phone" class="w-full bg-neutral-800 border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="07700 900123">
        </div>
      </div>
      <div>
        <label class="block text-neutral-400 text-xs mb-1">Address</label>
        <input type="text" id="ac-address" class="w-full bg-neutral-800 border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="12 High Street, Manchester">
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-neutral-400 text-xs mb-1">Postcode</label>
          <input type="text" id="ac-postcode" class="w-full bg-neutral-800 border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="M1 2AB">
        </div>
        <div>
          <label class="block text-neutral-400 text-xs mb-1">Tags</label>
          <input type="text" id="ac-tags" class="w-full bg-neutral-800 border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="e.g. regular, commercial">
        </div>
      </div>
      <div>
        <label class="block text-neutral-400 text-xs mb-1">Admin Notes</label>
        <textarea id="ac-notes" rows="2" class="w-full bg-neutral-800 border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none resize-none" placeholder="Optional notes..."></textarea>
      </div>
      <div id="ac-error" class="hidden text-red-400 text-xs"></div>
      <div class="flex gap-3 justify-end pt-2">
        <button onclick="closeAddCustomerModal()" class="bg-neutral-800 hover:bg-neutral-700 text-neutral-300 px-4 py-2 rounded-lg text-xs transition-colors">Cancel</button>
        <button onclick="saveNewCustomer()" id="ac-save-btn" class="bg-lime-400 hover:bg-lime-300 text-black px-5 py-2 rounded-lg text-xs font-semibold transition-colors">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- ============ IMPORT CSV MODAL ============ -->
<div id="importCsvModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-8 overflow-y-auto" onclick="if(event.target===this)closeImportCsvModal()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-3xl w-full fade-in my-4">
    <div class="sticky top-0 bg-neutral-900 border-b border-neutral-800 px-6 py-4 rounded-t-2xl flex items-center justify-between z-10">
      <h2 class="text-white font-semibold text-sm">Import Customers from CSV</h2>
      <button onclick="closeImportCsvModal()" class="text-neutral-500 hover:text-white transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6 space-y-5">

      <!-- Step 1: File Upload -->
      <div id="csv-step-upload">
        <div class="border-2 border-dashed border-neutral-700 rounded-xl p-8 text-center hover:border-lime-400/50 transition-colors cursor-pointer" onclick="document.getElementById('csv-file-input').click()">
          <svg class="w-10 h-10 text-neutral-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
          <p class="text-neutral-400 text-sm mb-1">Click to select a CSV file</p>
          <p class="text-neutral-600 text-xs">Supports .csv files with headers like Name, Email, Phone, Address, Postcode</p>
        </div>
        <input type="file" id="csv-file-input" accept=".csv" class="hidden" onchange="handleCsvFile(this)">
      </div>

      <!-- Step 2: Column Mapping -->
      <div id="csv-step-mapping" class="hidden">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-neutral-400 text-xs font-semibold uppercase tracking-wider">Column Mapping</h3>
          <span class="text-neutral-600 text-xs" id="csv-row-count"></span>
        </div>
        <p class="text-neutral-500 text-xs mb-3">Map your CSV columns to customer fields. We've auto-detected what we can.</p>
        <div id="csv-mapping-table" class="space-y-2 mb-4"></div>

        <!-- Preview -->
        <h3 class="text-neutral-400 text-xs font-semibold uppercase tracking-wider mb-2 mt-5">Preview (first 5 rows)</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-xs" id="csv-preview-table">
            <thead id="csv-preview-head"></thead>
            <tbody id="csv-preview-body"></tbody>
          </table>
        </div>

        <div class="flex gap-3 justify-end pt-4">
          <button onclick="resetCsvImport()" class="bg-neutral-800 hover:bg-neutral-700 text-neutral-300 px-4 py-2 rounded-lg text-xs transition-colors">Back</button>
          <button onclick="executeCsvImport()" id="csv-import-btn" class="bg-lime-400 hover:bg-lime-300 text-black px-5 py-2 rounded-lg text-xs font-semibold transition-colors">Import Customers</button>
        </div>
      </div>

      <!-- Step 3: Results -->
      <div id="csv-step-results" class="hidden">
        <div class="grid grid-cols-3 gap-3 mb-4">
          <div class="bg-neutral-800 rounded-xl p-4 text-center">
            <div class="text-lime-400 text-2xl font-bold" id="csv-result-imported">0</div>
            <div class="text-neutral-500 text-[10px] uppercase tracking-wider mt-1">Imported</div>
          </div>
          <div class="bg-neutral-800 rounded-xl p-4 text-center">
            <div class="text-amber-400 text-2xl font-bold" id="csv-result-skipped">0</div>
            <div class="text-neutral-500 text-[10px] uppercase tracking-wider mt-1">Duplicates Skipped</div>
          </div>
          <div class="bg-neutral-800 rounded-xl p-4 text-center">
            <div class="text-red-400 text-2xl font-bold" id="csv-result-errors">0</div>
            <div class="text-neutral-500 text-[10px] uppercase tracking-wider mt-1">Errors</div>
          </div>
        </div>
        <div id="csv-result-details" class="space-y-1 max-h-48 overflow-y-auto"></div>
        <div class="flex gap-3 justify-end pt-4">
          <button onclick="closeImportCsvModal(); loadCustomers();" class="bg-lime-400 hover:bg-lime-300 text-black px-5 py-2 rounded-lg text-xs font-semibold transition-colors">Done</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ============ BULK FOLLOW-UP MODAL ============ -->
<div id="bulkFollowUpModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[55] flex items-center justify-center p-4" onclick="if(event.target===this)closeBulkFollowUp()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-lg w-full fade-in">
    <div class="border-b border-neutral-800 px-6 py-4 flex items-center justify-between">
      <h2 class="text-white font-semibold text-sm">Send Bulk Follow-Up</h2>
      <button onclick="closeBulkFollowUp()" class="text-neutral-500 hover:text-white transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6 space-y-4">
      <div>
        <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Filter Customers</label>
        <select id="bulk-filter" onchange="previewBulkRecipients()" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
          <optgroup label="By Job History">
            <option value="all">All Customers</option>
            <option value="3months">Last job 3+ months ago</option>
            <option value="6months">Last job 6+ months ago</option>
            <option value="12months">Last job 12+ months ago</option>
            <option value="never">Never had a job</option>
          </optgroup>
          <optgroup label="By Quote Status">
            <option value="accepted_no_job">Accepted quote, no job yet</option>
            <option value="quoted_no_response">Quote sent, no response</option>
            <option value="never_quoted">Never quoted</option>
          </optgroup>
        </select>
      </div>
      <div class="bg-neutral-800/50 rounded-lg px-3 py-2 text-xs text-neutral-400">
        This will email <span class="text-lime-400 font-bold" id="bulk-count">0</span> customers
      </div>
      <div>
        <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Template</label>
        <select id="bulk-template" onchange="applyBulkTemplate()" class="w-full mt-1 bg-black border border-neutral-700 text-neutral-300 text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
          <option value="">Choose a template...</option>
          <optgroup label="Follow-Up">
            <option value="seasonal">Seasonal Reminder</option>
            <option value="discount">10% Discount Offer</option>
            <option value="yearly">Yearly Upkeep</option>
            <option value="checkin">General Check-In</option>
          </optgroup>
          <optgroup label="Feedback &amp; Re-engagement">
            <option value="feedback_experience">How was the experience?</option>
            <option value="feedback_price">Was it the price?</option>
            <option value="feedback_general">What could we do better?</option>
            <option value="reengagement_pricing">We've improved our pricing</option>
          </optgroup>
        </select>
      </div>
      <div>
        <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Subject</label>
        <input type="text" id="bulk-subject" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
      </div>
      <div>
        <label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">Message</label>
        <textarea id="bulk-body" rows="5" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2.5 rounded-xl resize-none focus:border-lime-400 focus:outline-none"></textarea>
        <div class="text-[10px] text-neutral-600 mt-1">Use {name} to personalise for each customer</div>
      </div>
      <button onclick="sendBulkFollowUp()" id="bulk-send-btn" class="w-full bg-lime-400 hover:bg-lime-300 text-black font-semibold py-3 rounded-lg text-sm transition-colors">Send to All</button>
    </div>
  </div>
</div>

<!-- ============ TOAST ============ -->
<!-- ============ INVOICE PREVIEW/EDIT MODAL ============ -->
<div id="invoiceModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-8 overflow-y-auto" onclick="if(event.target===this)closeInvoiceModal()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-2xl w-full fade-in my-4">
    <div class="sticky top-0 bg-neutral-900 border-b border-neutral-800 px-6 py-4 rounded-t-2xl flex items-center justify-between z-10">
      <div>
        <h2 class="text-white font-semibold text-sm" id="inv-modal-title">Invoice</h2>
        <div class="text-neutral-500 text-[10px] mt-0.5" id="inv-modal-date"></div>
      </div>
      <button onclick="closeInvoiceModal()" class="text-neutral-500 hover:text-white transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6 space-y-5">
      <!-- Customer Info (read-only) -->
      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span class="text-neutral-500">Customer</span><span class="text-white" id="inv-modal-customer"></span></div>
        <div class="flex justify-between"><span class="text-neutral-500">Address</span><span class="text-white" id="inv-modal-address"></span></div>
        <div class="flex justify-between"><span class="text-neutral-500">Service</span><span class="text-white" id="inv-modal-service"></span></div>
      </div>

      <!-- Line Items -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Line Items</h3>
        <div id="inv-modal-items" class="space-y-2"></div>
        <button onclick="addInvoiceLineItem()" class="mt-2 text-lime-400 hover:text-lime-300 text-xs font-medium transition-colors">+ Add Line Item</button>
      </div>

      <!-- VAT -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">VAT Rate</h3>
        <div class="flex gap-2">
          <button onclick="setInvoiceVat(0)" class="inv-vat-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-lime-400 text-black ring-2 ring-lime-300" data-rate="0">0%</button>
          <button onclick="setInvoiceVat(5)" class="inv-vat-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-neutral-800 text-neutral-300 hover:bg-neutral-700" data-rate="5">5%</button>
          <button onclick="setInvoiceVat(20)" class="inv-vat-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-neutral-800 text-neutral-300 hover:bg-neutral-700" data-rate="20">20%</button>
        </div>
      </div>

      <!-- Totals -->
      <div class="bg-black/30 rounded-xl p-4 space-y-2">
        <div class="flex justify-between text-sm"><span class="text-neutral-500">Subtotal</span><span class="text-white" id="inv-modal-subtotal">£0.00</span></div>
        <div id="inv-modal-vat-row" class="hidden flex justify-between text-sm"><span class="text-neutral-500" id="inv-modal-vat-label">VAT (0%)</span><span class="text-white" id="inv-modal-vat-amount">£0.00</span></div>
        <div class="flex justify-between text-lg font-bold border-t border-neutral-700 pt-2"><span class="text-white">Total</span><span class="text-lime-400" id="inv-modal-total">£0.00</span></div>
      </div>

      <!-- Payment Terms -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Payment Terms</h3>
        <input type="text" id="inv-modal-terms" value="Due on receipt" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
      </div>

      <!-- Notes -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-2">Notes</h3>
        <textarea id="inv-modal-notes" rows="2" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg resize-none focus:border-lime-400 focus:outline-none" placeholder="Optional notes for the customer..."></textarea>
      </div>

      <!-- Actions -->
      <div class="flex gap-2 pt-2 border-t border-neutral-800">
        <button onclick="saveInvoiceDraft()" class="bg-neutral-800 hover:bg-neutral-700 text-white font-medium px-4 py-2.5 rounded-lg text-xs transition-colors">Save Draft</button>
        <button onclick="sendInvoiceFromModal()" class="bg-lime-400 hover:bg-lime-300 text-black font-semibold px-4 py-2.5 rounded-lg text-xs transition-colors flex-1">Send to Customer</button>
        <button id="inv-modal-view-btn" onclick="viewInvoicePublic()" class="hidden bg-neutral-800 hover:bg-neutral-700 text-white font-medium px-4 py-2.5 rounded-lg text-xs transition-colors">View</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="fixed top-4 right-4 z-[60] hidden fade-in">
  <div class="bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-3 shadow-xl flex items-center gap-3 max-w-sm">
    <div id="toast-icon"></div>
    <div id="toast-msg" class="text-sm text-neutral-300"></div>
  </div>
</div>

<script>
// ============================
// STATE
// ============================
var state = {
  token: null,
  quotes: [],
  currentQuote: null,
  pagination: { total: 0, limit: 50, offset: 0, hasMore: false }
};

var API_BASE = window.location.origin;

// ============================
// AUTH
// ============================
function checkAuth() {
  var saved = localStorage.getItem('revive_admin_token');
  if (saved) {
    state.token = saved;
    validateToken();
  }
}

async function login() {
  var input = document.getElementById('tokenInput');
  var token = input.value.trim();
  if (!token) return;

  try {
    var res = await apiRequest('/admin/quotes?limit=1', { token: token });
    if (res.success) {
      state.token = token;
      localStorage.setItem('revive_admin_token', token);
      showDashboard();
    }
  } catch (e) {
    var err = document.getElementById('loginError');
    err.textContent = 'Invalid token. Please try again.';
    err.classList.remove('hidden');
    input.value = '';
    input.focus();
  }
}

async function validateToken() {
  try {
    var res = await apiRequest('/admin/quotes?limit=1');
    if (res.success) showDashboard();
    else throw new Error();
  } catch (e) {
    localStorage.removeItem('revive_admin_token');
    state.token = null;
  }
}

function logout() {
  localStorage.removeItem('revive_admin_token');
  state.token = null;
  location.reload();
}

function showDashboard() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  loadStats();
  loadQuotes();
  loadTeamForDropdowns();
}

// ============================
// API
// ============================
async function apiRequest(endpoint, opts) {
  opts = opts || {};
  var token = opts.token || state.token;
  var res = await fetch(API_BASE + endpoint, {
    method: opts.method || 'GET',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json'
    },
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });

  if (res.status === 401) {
    logout();
    throw new Error('Unauthorized');
  }

  if (!res.ok) throw new Error('Request failed');
  return res.json();
}

// ============================
// STATS
// ============================
function getAlertType(q) {
  var now = new Date();
  var created = new Date(q.created_at);
  var daysSinceCreated = (now - created) / (1000 * 60 * 60 * 24);

  // Accepted but not booked
  if (q.customer_accepted_estimate && q.status !== 'booked' && q.status !== 'completed') return 'accepted_not_booked';
  // Hot lead uncontacted
  if (q.lead_score >= 80 && q.status === 'new') return 'hot_uncontacted';
  // Aging lead (new for 3+ days)
  if (q.status === 'new' && daysSinceCreated > 3) return 'aging';

  return null;
}

async function loadStats() {
  try {
    var res = await apiRequest('/admin/quotes?limit=200&sort=created_at&order=desc');
    if (!res.success) return;

    var quotes = res.data;
    var hot = 0, warm = 0, cold = 0, totalEst = 0, estCount = 0, accepted = 0, attention = 0;

    quotes.forEach(function(q) {
      if (q.qualification_status === 'hot') hot++;
      else if (q.qualification_status === 'warm') warm++;
      else if (q.qualification_status === 'cold') cold++;

      if (q.estimated_value_min && q.estimated_value_max) {
        totalEst += (q.estimated_value_min + q.estimated_value_max) / 2;
        estCount++;
      }
      if (q.customer_accepted_estimate) accepted++;
      if (getAlertType(q)) attention++;
    });

    var total = res.pagination.total;
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-hot').textContent = hot;
    document.getElementById('stat-warm').textContent = warm;
    document.getElementById('stat-cold').textContent = cold;
    document.getElementById('stat-avg').textContent = estCount > 0 ? '\u00A3' + Math.round(totalEst / estCount) : '-';
    document.getElementById('stat-accepted').textContent = accepted;
    document.getElementById('stat-attention').textContent = attention;
  } catch (e) {
    console.error('Failed to load stats:', e);
  }
}

// ============================
// QUOTES TABLE
// ============================
async function loadQuotes() {
  var loading = document.getElementById('tableLoading');
  var table = document.getElementById('quotesTable');
  var cards = document.getElementById('quotesCards');
  var empty = document.getElementById('emptyState');
  var pag = document.getElementById('pagination');

  loading.classList.remove('hidden');
  table.classList.add('hidden');
  cards.classList.add('hidden');
  empty.classList.add('hidden');
  pag.classList.add('hidden');

  try {
    var statusFilter = document.getElementById('filter-status').value;
    var serviceFilter = document.getElementById('filter-service').value;
    var sortVal = document.getElementById('filter-sort').value.split(':');

    var isAttentionFilter = statusFilter === 'attention';
    var params = '?limit=' + (isAttentionFilter ? '200' : state.pagination.limit) + '&offset=' + (isAttentionFilter ? '0' : state.pagination.offset);
    params += '&sort=' + sortVal[0] + '&order=' + sortVal[1];
    if (statusFilter && !isAttentionFilter) params += '&status=' + statusFilter;
    if (serviceFilter) params += '&service=' + serviceFilter;

    var res = await apiRequest('/admin/quotes' + params);
    loading.classList.add('hidden');

    if (!res.success || res.data.length === 0) {
      empty.classList.remove('hidden');
      document.getElementById('resultCount').textContent = '0 results';
      return;
    }

    var displayData = res.data;
    if (isAttentionFilter) {
      displayData = res.data.filter(function(q) { return getAlertType(q) !== null; });
      if (displayData.length === 0) {
        empty.classList.remove('hidden');
        document.getElementById('resultCount').textContent = '0 results';
        return;
      }
    }

    state.quotes = displayData;
    state.pagination = res.pagination;

    renderTable(displayData);
    renderCards(displayData);

    table.classList.remove('hidden');
    cards.classList.remove('hidden');

    document.getElementById('resultCount').textContent = (isAttentionFilter ? displayData.length + ' need attention' : res.pagination.total + ' total');

    // Pagination (hide for attention filter since it's client-side filtered)
    if (!isAttentionFilter && res.pagination.total > res.pagination.limit) {
      pag.classList.remove('hidden');
      pag.classList.add('flex');
      var page = Math.floor(state.pagination.offset / state.pagination.limit) + 1;
      var totalPages = Math.ceil(res.pagination.total / res.pagination.limit);
      document.getElementById('pageInfo').textContent = 'Page ' + page + ' of ' + totalPages;
      document.getElementById('prevBtn').disabled = state.pagination.offset === 0;
      document.getElementById('nextBtn').disabled = !res.pagination.hasMore;
    }

  } catch (e) {
    loading.classList.add('hidden');
    empty.classList.remove('hidden');
    console.error('Failed to load quotes:', e);
  }
}

function renderTable(quotes) {
  var tbody = document.getElementById('quotesTableBody');
  tbody.innerHTML = '';

  quotes.forEach(function(q) {
    var tr = document.createElement('tr');
    tr.className = 'border-b border-neutral-800/50 hover:bg-neutral-800/30 cursor-pointer transition-colors ' + getRowBorder(q.qualification_status);
    tr.onclick = function() { openModal(q.id); };

    var services = Array.isArray(q.services) ? q.services.map(capitalize).join(', ') : '';
    var estimate = formatEstimate(q.estimated_value_min, q.estimated_value_max);

    var alert = getAlertType(q);
    var alertIcon = alert ? '<svg class="w-3.5 h-3.5 text-orange-400 inline ml-1" title="Needs attention" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>' : '';

    tr.innerHTML =
      '<td class="px-4 py-3">' + qualBadge(q.qualification_status) + '</td>' +
      '<td class="px-4 py-3"><div class="text-sm text-white font-medium">' + esc(q.name) + alertIcon + '</div><div class="text-[11px] text-neutral-500">' + esc(q.email) + '</div></td>' +
      '<td class="px-4 py-3 hidden lg:table-cell"><div class="text-xs text-neutral-400">' + esc(services) + '</div></td>' +
      '<td class="px-4 py-3"><div class="text-sm font-semibold text-lime-400">' + estimate + '</div></td>' +
      '<td class="px-4 py-3 hidden md:table-cell">' + scoreBadge(q.lead_score) + '</td>' +
      '<td class="px-4 py-3">' + statusBadge(q.status) + '</td>' +
      '<td class="px-4 py-3 hidden md:table-cell"><div class="text-xs text-neutral-500">' + formatDate(q.created_at) + '</div></td>';

    tbody.appendChild(tr);
  });
}

function renderCards(quotes) {
  var container = document.getElementById('quotesCards');
  container.innerHTML = '';

  quotes.forEach(function(q) {
    var services = Array.isArray(q.services) ? q.services.map(capitalize).join(', ') : '';
    var estimate = formatEstimate(q.estimated_value_min, q.estimated_value_max);

    var div = document.createElement('div');
    div.className = 'bg-neutral-900 border border-neutral-800 rounded-xl p-4 cursor-pointer hover:border-neutral-700 transition-colors ' + getCardBorder(q.qualification_status);
    div.onclick = function() { openModal(q.id); };

    var cardAlert = getAlertType(q);
    var cardAlertIcon = cardAlert ? '<svg class="w-3.5 h-3.5 text-orange-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>' : '';

    div.innerHTML =
      '<div class="flex items-center justify-between mb-2">' +
        '<div class="flex items-center gap-2">' + qualBadge(q.qualification_status) + '<span class="text-sm text-white font-medium">' + esc(q.name) + '</span>' + cardAlertIcon + '</div>' +
        statusBadge(q.status) +
      '</div>' +
      '<div class="text-xs text-neutral-500 mb-2">' + esc(services) + '</div>' +
      '<div class="flex items-center justify-between">' +
        '<span class="text-sm font-semibold text-lime-400">' + estimate + '</span>' +
        '<span class="text-xs text-neutral-500">' + formatDate(q.created_at) + '</span>' +
      '</div>';

    container.appendChild(div);
  });
}

// ============================
// PAGINATION
// ============================
function applyFilters() {
  state.pagination.offset = 0;
  loadQuotes();
}

function prevPage() {
  state.pagination.offset = Math.max(0, state.pagination.offset - state.pagination.limit);
  loadQuotes();
}

function nextPage() {
  state.pagination.offset += state.pagination.limit;
  loadQuotes();
}

// ============================
// QUOTE DETAIL MODAL
// ============================
var quoteCalendarInstance = null;
var quoteAvailabilityData = {};
var quoteSelectedDate = null;

async function openModal(id) {
  document.getElementById('quoteModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  try {
    var res = await apiRequest('/admin/quotes/' + id);
    if (!res.success) { closeModal(); return; }

    var q = res.data;
    state.currentQuote = q;

    // Header
    document.getElementById('modal-name').textContent = q.name;
    document.getElementById('modal-qual-badge').className = 'w-3 h-3 rounded-full ' + qualColor(q.qualification_status);

    // Quick Actions
    var phone = q.phone || '';
    var cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
    if (cleanPhone.startsWith('0')) cleanPhone = '+44' + cleanPhone.substring(1);
    if (!cleanPhone.startsWith('+')) cleanPhone = '+44' + cleanPhone;

    document.getElementById('qa-phone').href = phone ? 'tel:' + phone : '#';
    document.getElementById('qa-whatsapp').href = phone ? 'https://wa.me/' + cleanPhone.replace('+', '') + '?text=' + encodeURIComponent('Hi ' + (q.name || '') + ', it\'s Revive Exterior Cleaning. ') : '#';
    document.getElementById('qa-email').href = q.email ? 'mailto:' + q.email + '?subject=' + encodeURIComponent('Your Revive Cleaning Quote') : '#';

    // Customer
    document.getElementById('modal-fullname').textContent = q.name || '-';
    var emailEl = document.getElementById('modal-email');
    emailEl.textContent = q.email || '-';
    emailEl.href = q.email ? 'mailto:' + q.email : '#';
    var phoneEl = document.getElementById('modal-phone');
    phoneEl.textContent = q.phone || '-';
    phoneEl.href = q.phone ? 'tel:' + q.phone : '#';
    document.getElementById('modal-address').textContent = q.address_line1 || '-';
    document.getElementById('modal-postcode').textContent = q.postcode || '-';

    // Preferences
    document.getElementById('modal-contact').textContent = capitalize(q.preferred_contact || '-');
    document.getElementById('modal-time').textContent = capitalize(q.best_time || '-');
    document.getElementById('modal-reminders').textContent = q.reminders_ok ? 'Yes' : 'No';
    var acceptedEl = document.getElementById('modal-accepted');
    if (q.customer_accepted_estimate) {
      acceptedEl.innerHTML = '<span class="text-lime-400 font-semibold">Yes</span>';
    } else {
      acceptedEl.innerHTML = '<span class="text-neutral-500">No</span>';
    }

    // Services
    var servicesDiv = document.getElementById('modal-services');
    servicesDiv.innerHTML = '';
    if (Array.isArray(q.services)) {
      q.services.forEach(function(s) {
        servicesDiv.innerHTML += '<span class="bg-neutral-800 text-neutral-300 px-2 py-0.5 rounded text-[11px]">' + esc(capitalize(s)) + '</span>';
      });
    }

    // Estimate (read-only auto estimate)
    document.getElementById('modal-estimate').textContent = formatEstimate(q.estimated_value_min, q.estimated_value_max);
    document.getElementById('modal-score').textContent = q.lead_score || '-';
    document.getElementById('modal-confidence').textContent = capitalize(q.estimation_confidence || '-');
    var qualEl = document.getElementById('modal-qualification');
    qualEl.innerHTML = qualBadge(q.qualification_status);

    // Editable pricing fields
    document.getElementById('modal-final-price').value = q.final_value || '';
    document.getElementById('modal-est-min').value = q.estimated_value_min || '';
    document.getElementById('modal-est-max').value = q.estimated_value_max || '';

    // Priority buttons
    renderPriorityButtons(q.internal_priority);

    // Assigned To dropdown
    populateQuoteAssignedDropdown(q.assigned_to);

    // Status buttons
    renderStatusButtons(q.status);

    // Notes
    document.getElementById('modal-notes').value = q.admin_notes || '';

    // Capacity from localStorage
    var savedCapacity = localStorage.getItem('dailyCapacity');
    if (savedCapacity) document.getElementById('modal-capacity').value = savedCapacity;

    // Initialize availability calendar
    initQuoteCalendar();

    // Load activity log
    loadActivityLog(q.id);

    // Load attachments
    loadAttachments(q.id);

    // Timeline
    renderTimeline(q);

    // Answers
    document.getElementById('modal-answers').textContent = q.answers ? JSON.stringify(q.answers, null, 2) : 'No form data';

  } catch (e) {
    console.error('Failed to load quote:', e);
    closeModal();
    showToast('Failed to load quote details', 'error');
  }
}

function closeModal() {
  if (quoteCalendarInstance) {
    quoteCalendarInstance.destroy();
    quoteCalendarInstance = null;
  }
  document.getElementById('quoteModal').classList.add('hidden');
  document.body.style.overflow = '';
  state.currentQuote = null;
  quoteAvailabilityData = {};
  quoteSelectedDate = null;
}

function renderStatusButtons(currentStatus) {
  var statuses = ['new', 'contacted', 'quoted', 'booked', 'completed', 'cancelled'];
  var colors = {
    'new': 'bg-neutral-700 hover:bg-neutral-600',
    'contacted': 'bg-blue-900 hover:bg-blue-800',
    'quoted': 'bg-orange-900 hover:bg-orange-800',
    'booked': 'bg-lime-900 hover:bg-lime-800',
    'completed': 'bg-green-900 hover:bg-green-800',
    'cancelled': 'bg-red-900 hover:bg-red-800'
  };
  var activeColors = {
    'new': 'bg-neutral-600 ring-2 ring-neutral-400',
    'contacted': 'bg-blue-700 ring-2 ring-blue-400',
    'quoted': 'bg-orange-700 ring-2 ring-orange-400',
    'booked': 'bg-lime-700 ring-2 ring-lime-400',
    'completed': 'bg-green-700 ring-2 ring-green-400',
    'cancelled': 'bg-red-700 ring-2 ring-red-400'
  };

  var container = document.getElementById('statusButtons');
  container.innerHTML = '';

  statuses.forEach(function(s) {
    var isActive = s === currentStatus;
    var btn = document.createElement('button');
    btn.className = 'px-3 py-1.5 rounded-lg text-xs text-white font-medium transition-all ' + (isActive ? activeColors[s] : colors[s]);
    btn.textContent = capitalize(s);
    if (!isActive) {
      btn.onclick = function() { updateStatus(s); };
    }
    container.appendChild(btn);
  });
}

async function updateStatus(newStatus) {
  if (!state.currentQuote) return;
  try {
    var res = await apiRequest('/admin/quotes/' + state.currentQuote.id, {
      method: 'PATCH',
      body: { status: newStatus }
    });
    if (res.success) {
      state.currentQuote.status = newStatus;
      renderStatusButtons(newStatus);
      loadQuotes();
      loadActivityLog(state.currentQuote.id);
      showToast('Status updated to ' + capitalize(newStatus), 'success');
    }
  } catch (e) {
    showToast('Failed to update status', 'error');
  }
}

async function saveNotes() {
  if (!state.currentQuote) return;
  var notes = document.getElementById('modal-notes').value;
  try {
    var res = await apiRequest('/admin/quotes/' + state.currentQuote.id, {
      method: 'PATCH',
      body: { admin_notes: notes }
    });
    if (res.success) {
      showToast('Notes saved', 'success');
      loadActivityLog(state.currentQuote.id);
    }
  } catch (e) {
    showToast('Failed to save notes', 'error');
  }
}

// ============================
// PATCH QUOTE (generic)
// ============================
async function patchQuote(field, value) {
  if (!state.currentQuote) return;
  try {
    var body = {};
    body[field] = value;
    var res = await apiRequest('/admin/quotes/' + state.currentQuote.id, {
      method: 'PATCH',
      body: body
    });
    if (res.success) {
      state.currentQuote[field] = value;
      // Refresh estimate display if pricing changed
      if (field === 'estimated_value_min' || field === 'estimated_value_max') {
        document.getElementById('modal-estimate').textContent = formatEstimate(
          state.currentQuote.estimated_value_min,
          state.currentQuote.estimated_value_max
        );
      }
      loadQuotes();
      loadActivityLog(state.currentQuote.id);
      showToast(capitalize(field.replace(/_/g, ' ')) + ' updated', 'success');
    }
  } catch (e) {
    showToast('Failed to update ' + field, 'error');
  }
}

// ============================
// PRIORITY BUTTONS
// ============================
function renderPriorityButtons(current) {
  var priorities = [
    { value: 'high', label: 'High', color: 'bg-red-900 hover:bg-red-800', active: 'bg-red-700 ring-2 ring-red-400' },
    { value: 'medium', label: 'Medium', color: 'bg-orange-900 hover:bg-orange-800', active: 'bg-orange-700 ring-2 ring-orange-400' },
    { value: 'low', label: 'Low', color: 'bg-neutral-700 hover:bg-neutral-600', active: 'bg-neutral-600 ring-2 ring-neutral-400' }
  ];

  var container = document.getElementById('priorityButtons');
  container.innerHTML = '';

  priorities.forEach(function(p) {
    var isActive = p.value === current;
    var btn = document.createElement('button');
    btn.className = 'px-3 py-1.5 rounded-lg text-xs text-white font-medium transition-all ' + (isActive ? p.active : p.color);
    btn.textContent = p.label;
    if (!isActive) {
      btn.onclick = function() {
        patchQuote('internal_priority', p.value);
        renderPriorityButtons(p.value);
      };
    }
    container.appendChild(btn);
  });
}

// ============================
// ASSIGNED TO (quote modal)
// ============================
function populateQuoteAssignedDropdown(currentValue) {
  var sel = document.getElementById('modal-assigned-to');
  sel.innerHTML = '<option value="">Unassigned</option>';
  (schedState.team || []).forEach(function(t) {
    var opt = document.createElement('option');
    opt.value = t.name;
    opt.textContent = t.name;
    if (t.name === currentValue) opt.selected = true;
    sel.appendChild(opt);
  });
}

// ============================
// AVAILABILITY CALENDAR
// ============================
async function initQuoteCalendar() {
  if (quoteCalendarInstance) {
    quoteCalendarInstance.destroy();
    quoteCalendarInstance = null;
  }

  // Fetch availability data
  var today = new Date();
  var fromDate = today.toISOString().split('T')[0];
  var toDate = new Date(today.getTime() + 42 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

  try {
    var res = await apiRequest('/admin/jobs/availability?from_date=' + fromDate + '&to_date=' + toDate);
    if (res.success) {
      quoteAvailabilityData = res.dates || {};
    }
  } catch (e) {
    console.error('Failed to load availability:', e);
  }

  var capacity = parseInt(document.getElementById('modal-capacity').value) || 4;

  quoteCalendarInstance = flatpickr(document.getElementById('modal-calendar-container'), {
    inline: true,
    minDate: 'today',
    dateFormat: 'Y-m-d',
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      var dateStr = dayElem.dateObj.toISOString().split('T')[0];
      var jobCount = quoteAvailabilityData[dateStr] || 0;

      if (jobCount > 0) {
        var dot = document.createElement('span');
        dot.style.cssText = 'width:5px;height:5px;border-radius:50%;position:absolute;bottom:2px;left:50%;transform:translateX(-50%);';

        if (jobCount >= capacity) {
          dot.style.background = '#ef4444'; // red
        } else if (jobCount >= capacity / 2) {
          dot.style.background = '#f97316'; // orange
        } else {
          dot.style.background = '#22c55e'; // green
        }

        dayElem.style.position = 'relative';
        dayElem.appendChild(dot);
      }
    },
    onChange: function(selectedDates, dateStr) {
      quoteSelectedDate = dateStr;
      showDayInfo(dateStr);
    }
  });
}

function refreshAvailabilityCalendar() {
  if (state.currentQuote) initQuoteCalendar();
}

async function showDayInfo(dateStr) {
  var dayInfo = document.getElementById('modal-calendar-dayinfo');
  var dayLabel = document.getElementById('modal-calendar-daylabel');
  var dayJobs = document.getElementById('modal-calendar-dayjobs');

  dayInfo.classList.remove('hidden');

  var d = new Date(dateStr + 'T12:00:00');
  var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  dayLabel.textContent = days[d.getDay()] + ' ' + d.getDate() + '/' + (d.getMonth()+1) + '/' + d.getFullYear();

  var jobCount = quoteAvailabilityData[dateStr] || 0;
  var capacity = parseInt(document.getElementById('modal-capacity').value) || 4;

  if (jobCount === 0) {
    dayJobs.innerHTML = '<div class="text-green-400">No jobs scheduled - wide open</div>';
  } else {
    dayJobs.innerHTML = '<div class="text-neutral-400">' + jobCount + ' job' + (jobCount !== 1 ? 's' : '') + ' scheduled (capacity: ' + capacity + ')</div>';
  }

  document.getElementById('modal-book-date-badge').textContent = 'Selected: ' + dateStr;
}

// ============================
// BOOK THIS JOB (direct from quote modal)
// ============================
async function bookThisJob() {
  if (!state.currentQuote) return;
  var q = state.currentQuote;

  // Use selected calendar date, or default to today
  var bookDate = quoteSelectedDate;
  if (!bookDate) {
    var today = new Date();
    bookDate = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
  }

  var timeSlot = document.getElementById('modal-book-time').value;
  var duration = document.getElementById('modal-book-duration').value || null;
  var assignedTo = document.getElementById('modal-assigned-to').value || null;
  var services = Array.isArray(q.services) ? q.services.map(capitalize).join(', ') : 'Service';

  var body = {
    quote_id: q.id,
    customer_name: q.name,
    customer_phone: q.phone || null,
    customer_email: q.email || null,
    address: q.address_line1 || '',
    postcode: q.postcode || '',
    service: services,
    scheduled_date: bookDate,
    time_slot: timeSlot,
    assigned_to: assignedTo,
    estimated_duration: duration,
    job_value: q.final_value || q.estimated_value_max || q.estimated_value_min || null
  };

  // Disable button while processing
  var btn = document.querySelector('[onclick="bookThisJob()"]');
  if (btn) { btn.disabled = true; btn.textContent = 'Booking...'; }

  try {
    var res = await apiRequest('/admin/jobs', { method: 'POST', body: body });
    if (res.success) {
      // Update quote status to booked
      await patchQuote('status', 'booked');
      // Close modal and navigate to schedule showing the booked date
      closeModal();
      switchTab('schedule');
      schedState.currentDate = new Date(bookDate + 'T12:00:00');
      loadSchedule();
      showToast('Job booked for ' + bookDate + ' at ' + timeSlot, 'success');
    } else {
      showToast('Failed: ' + (res.error || 'Unknown error'), 'error');
    }
  } catch (e) {
    console.error('Book job error:', e);
    showToast('Failed to create job: ' + e.message, 'error');
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg> Book This Job';
    }
  }
}

function selectQuoteForJob(q) {
  // Simulate selecting this quote in the picker
  schedState.selectedQuote = q;
  document.getElementById('quotePickerList').classList.add('hidden');
  document.getElementById('quotePickerLoading').classList.add('hidden');
  var selectedDiv = document.getElementById('quotePickerSelected');
  selectedDiv.classList.remove('hidden');
  document.getElementById('qp-name').textContent = q.name + ' - ' + (Array.isArray(q.services) ? q.services.map(capitalize).join(', ') : 'Service');
  document.getElementById('qp-details').textContent = [q.address_line1, q.postcode].filter(Boolean).join(', ') + (q.final_value ? ' | £' + q.final_value : (q.estimated_value_max ? ' | Est. £' + q.estimated_value_min + '-£' + q.estimated_value_max : ''));
}

// ============================
// ACTIVITY LOG
// ============================
async function loadActivityLog(quoteId) {
  var feed = document.getElementById('modal-activity-feed');
  try {
    var res = await apiRequest('/admin/quotes/' + quoteId + '/activity');
    if (!res.success) {
      feed.innerHTML = '<div class="text-neutral-600 text-center py-2">Failed to load activity</div>';
      return;
    }

    var activities = res.data || [];
    if (activities.length === 0) {
      feed.innerHTML = '<div class="text-neutral-600 text-center py-2">No activity yet</div>';
      return;
    }

    feed.innerHTML = '';
    activities.forEach(function(a) {
      var icon = activityIcon(a.action_type);
      var timeAgo = relativeTime(a.created_at);
      feed.innerHTML +=
        '<div class="flex items-start gap-2 py-1.5 border-b border-neutral-800/50 last:border-0">' +
          '<span class="flex-shrink-0 mt-0.5">' + icon + '</span>' +
          '<span class="text-neutral-300 flex-1">' + esc(a.description) + '</span>' +
          '<span class="text-neutral-600 flex-shrink-0 whitespace-nowrap">' + timeAgo + '</span>' +
        '</div>';
    });
  } catch (e) {
    feed.innerHTML = '<div class="text-neutral-600 text-center py-2">Failed to load activity</div>';
  }
}

async function addManualActivity() {
  if (!state.currentQuote) return;
  var input = document.getElementById('modal-activity-input');
  var description = input.value.trim();
  if (!description) return;

  try {
    var res = await apiRequest('/admin/quotes/' + state.currentQuote.id + '/activity', {
      method: 'POST',
      body: { action_type: 'manual', description: description }
    });
    if (res.success) {
      input.value = '';
      loadActivityLog(state.currentQuote.id);
      showToast('Activity logged', 'success');
    }
  } catch (e) {
    showToast('Failed to log activity', 'error');
  }
}

function activityIcon(type) {
  var icons = {
    'status_change': '<svg class="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>',
    'price_update': '<svg class="w-3.5 h-3.5 text-lime-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
    'note': '<svg class="w-3.5 h-3.5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>',
    'manual': '<svg class="w-3.5 h-3.5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>',
    'priority_change': '<svg class="w-3.5 h-3.5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/></svg>',
    'assignment': '<svg class="w-3.5 h-3.5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>',
    'attachment': '<svg class="w-3.5 h-3.5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>',
    'email_sent': '<svg class="w-3.5 h-3.5 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>',
    'whatsapp_sent': '<svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>'
  };
  return icons[type] || '<svg class="w-3.5 h-3.5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" stroke-width="2"/></svg>';
}

function relativeTime(dateStr) {
  var now = new Date();
  var date = new Date(dateStr);
  var diff = Math.floor((now - date) / 1000);

  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
  return date.toLocaleDateString();
}

// ============================
// ATTACHMENTS
// ============================
async function loadAttachments(quoteId) {
  var grid = document.getElementById('modal-attachments-grid');
  grid.innerHTML = '';

  try {
    var res = await apiRequest('/admin/quotes/' + quoteId + '/attachments');
    if (!res.success || !res.data || res.data.length === 0) return;

    res.data.forEach(function(file) {
      var isImage = /\.(jpg|jpeg|png|webp)$/i.test(file.name);
      var card = document.createElement('div');
      card.className = 'relative group bg-neutral-800 rounded-lg overflow-hidden aspect-square';

      if (isImage) {
        card.innerHTML =
          '<img src="' + esc(file.url) + '" class="w-full h-full object-cover cursor-pointer" onclick="window.open(\'' + esc(file.url) + '\', \'_blank\')" alt="' + esc(file.name) + '">' +
          '<button onclick="deleteAttachment(\'' + esc(file.name) + '\')" class="absolute top-1 right-1 bg-black/70 text-red-400 hover:text-red-300 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">' +
            '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>' +
          '</button>';
      } else {
        card.innerHTML =
          '<div class="flex items-center justify-center h-full cursor-pointer" onclick="window.open(\'' + esc(file.url) + '\', \'_blank\')">' +
            '<div class="text-center"><svg class="w-8 h-8 mx-auto text-neutral-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg><div class="text-[10px] text-neutral-500 truncate px-1">' + esc(file.name.split('-').pop()) + '</div></div>' +
          '</div>' +
          '<button onclick="deleteAttachment(\'' + esc(file.name) + '\')" class="absolute top-1 right-1 bg-black/70 text-red-400 hover:text-red-300 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">' +
            '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>' +
          '</button>';
      }
      grid.appendChild(card);
    });
  } catch (e) {
    console.error('Failed to load attachments:', e);
  }
}

async function handleAttachmentUpload(files) {
  if (!state.currentQuote || !files || files.length === 0) return;
  var progress = document.getElementById('modal-upload-progress');
  progress.classList.remove('hidden');

  for (var i = 0; i < files.length; i++) {
    var file = files[i];
    if (file.size > 10 * 1024 * 1024) {
      showToast(file.name + ' is too large (max 10MB)', 'error');
      continue;
    }

    progress.textContent = 'Uploading ' + (i + 1) + '/' + files.length + '...';

    try {
      var base64 = await fileToBase64(file);
      var res = await apiRequest('/admin/quotes/' + state.currentQuote.id + '/attachments', {
        method: 'POST',
        body: {
          filename: file.name,
          contentType: file.type,
          data: base64
        }
      });
      if (!res.success) {
        showToast('Failed to upload ' + file.name, 'error');
      }
    } catch (e) {
      showToast('Failed to upload ' + file.name, 'error');
    }
  }

  progress.classList.add('hidden');
  document.getElementById('modal-file-input').value = '';
  loadAttachments(state.currentQuote.id);
  loadActivityLog(state.currentQuote.id);
  showToast('Upload complete', 'success');
}

function handleAttachmentDrop(event) {
  var files = event.dataTransfer.files;
  handleAttachmentUpload(files);
}

function fileToBase64(file) {
  return new Promise(function(resolve, reject) {
    var reader = new FileReader();
    reader.onload = function() {
      // Remove data:mime;base64, prefix
      var base64 = reader.result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function deleteAttachment(filename) {
  if (!state.currentQuote) return;
  if (!confirm('Delete this attachment?')) return;

  try {
    var res = await apiRequest('/admin/quotes/' + state.currentQuote.id + '/attachments/' + encodeURIComponent(filename), {
      method: 'DELETE'
    });
    if (res.success) {
      loadAttachments(state.currentQuote.id);
      showToast('Attachment deleted', 'success');
    }
  } catch (e) {
    showToast('Failed to delete attachment', 'error');
  }
}

function renderTimeline(q) {
  var container = document.getElementById('modal-timeline');
  var events = [];

  if (q.created_at) events.push({ label: 'Quote submitted', time: q.created_at, color: 'bg-neutral-600' });
  if (q.confirmation_email_sent_at) events.push({ label: 'Confirmation email sent', time: q.confirmation_email_sent_at, color: 'bg-blue-500' });
  if (q.estimated_at) events.push({ label: 'Estimate calculated', time: q.estimated_at, color: 'bg-lime-500' });
  if (q.estimate_email_sent_at) events.push({ label: 'Estimate email sent', time: q.estimate_email_sent_at, color: 'bg-blue-500' });
  if (q.customer_accepted_at) events.push({ label: 'Customer accepted estimate', time: q.customer_accepted_at, color: 'bg-green-500' });
  if (q.last_contact_at) events.push({ label: 'Last contact', time: q.last_contact_at, color: 'bg-orange-500' });

  events.sort(function(a, b) { return new Date(a.time) - new Date(b.time); });

  container.innerHTML = '';
  if (events.length === 0) {
    container.innerHTML = '<div class="text-neutral-600">No timeline events</div>';
    return;
  }

  events.forEach(function(ev) {
    container.innerHTML +=
      '<div class="flex items-center gap-3">' +
        '<div class="w-2 h-2 rounded-full ' + ev.color + ' flex-shrink-0"></div>' +
        '<span class="text-neutral-400">' + esc(ev.label) + '</span>' +
        '<span class="text-neutral-600 ml-auto">' + formatDateTime(ev.time) + '</span>' +
      '</div>';
  });
}

// ============================
// EXPORT
// ============================
async function exportCSV() {
  try {
    var params = '';
    var statusFilter = document.getElementById('filter-status').value;
    var serviceFilter = document.getElementById('filter-service').value;
    if (statusFilter) params += (params ? '&' : '?') + 'status=' + statusFilter;
    if (serviceFilter) params += (params ? '&' : '?') + 'service=' + serviceFilter;

    var res = await fetch(API_BASE + '/admin/export' + params, {
      headers: { 'Authorization': 'Bearer ' + state.token }
    });

    if (!res.ok) {
      var errData = await res.json().catch(function() { return {}; });
      showToast(errData.error || 'Export failed', 'error');
      return;
    }

    var blob = await res.blob();
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'revive-quotes-' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    showToast('CSV exported', 'success');
  } catch (e) {
    showToast('Export failed', 'error');
  }
}

// ============================
// TOAST
// ============================
function showToast(msg, type) {
  var toast = document.getElementById('toast');
  var icon = document.getElementById('toast-icon');
  var msgEl = document.getElementById('toast-msg');

  if (type === 'success') {
    icon.innerHTML = '<svg class="w-4 h-4 text-lime-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
  } else {
    icon.innerHTML = '<svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
  }

  msgEl.textContent = msg;
  toast.classList.remove('hidden');

  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(function() {
    toast.classList.add('hidden');
  }, 3000);
}

// ============================
// HELPERS
// ============================
function esc(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function capitalize(str) {
  if (!str) return '';
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function formatEstimate(min, max) {
  if (!min && !max) return '-';
  return '\u00A3' + Math.round(min || 0) + '-\u00A3' + Math.round(max || 0);
}

function formatDate(ts) {
  if (!ts) return '-';
  var d = new Date(ts);
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

function formatDateTime(ts) {
  if (!ts) return '-';
  var d = new Date(ts);
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + ' ' + d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
}

function qualColor(status) {
  var map = { hot: 'bg-red-400', warm: 'bg-orange-400', cold: 'bg-blue-400', unqualified: 'bg-neutral-600' };
  return map[status] || 'bg-neutral-600';
}

function qualBadge(status) {
  var colors = { hot: 'text-red-400 bg-red-400/10', warm: 'text-orange-400 bg-orange-400/10', cold: 'text-blue-400 bg-blue-400/10', unqualified: 'text-neutral-400 bg-neutral-400/10' };
  var c = colors[status] || colors.unqualified;
  var label = capitalize(status || 'unqualified');
  return '<span class="px-2 py-0.5 rounded text-[10px] font-semibold ' + c + '">' + label + '</span>';
}

function statusBadge(status) {
  var colors = {
    'new': 'text-neutral-300 bg-neutral-700',
    'contacted': 'text-blue-300 bg-blue-900/60',
    'quoted': 'text-orange-300 bg-orange-900/60',
    'booked': 'text-lime-300 bg-lime-900/60',
    'completed': 'text-green-300 bg-green-900/60',
    'cancelled': 'text-red-300 bg-red-900/60'
  };
  var c = colors[status] || colors['new'];
  return '<span class="px-2 py-0.5 rounded text-[10px] font-medium ' + c + '">' + capitalize(status || 'new') + '</span>';
}

function scoreBadge(score) {
  if (!score && score !== 0) return '<span class="text-xs text-neutral-600">-</span>';
  var color = 'text-neutral-400';
  if (score >= 75) color = 'text-red-400';
  else if (score >= 50) color = 'text-orange-400';
  else if (score >= 30) color = 'text-blue-400';
  return '<span class="text-sm font-bold ' + color + '">' + score + '</span>';
}

function getRowBorder(status) {
  var map = { hot: 'border-l-2 border-l-red-500', warm: 'border-l-2 border-l-orange-500', cold: 'border-l-2 border-l-blue-500' };
  return map[status] || '';
}

function getCardBorder(status) {
  var map = { hot: 'border-l-2 border-l-red-500', warm: 'border-l-2 border-l-orange-500', cold: 'border-l-2 border-l-blue-500' };
  return map[status] || '';
}

// ============================
// TAB NAVIGATION
// ============================
var currentTab = 'quotes';

function switchTab(tab) {
  currentTab = tab;
  // Hide all tab content
  document.querySelectorAll('.tab-content').forEach(function(el) { el.classList.add('hidden'); });
  // Reset all tab buttons
  document.querySelectorAll('.tab-btn').forEach(function(el) {
    el.className = 'tab-btn px-4 py-2 text-xs font-semibold rounded-t-lg transition-colors text-neutral-500 hover:text-neutral-300';
  });
  // Show selected tab
  document.getElementById('content-' + tab).classList.remove('hidden');
  document.getElementById('tab-' + tab).className = 'tab-btn px-4 py-2 text-xs font-semibold rounded-t-lg transition-colors bg-neutral-900 text-lime-400 border border-neutral-800 border-b-0';

  // Show/hide CSV button (only on quotes tab)
  var csvBtn = document.getElementById('csvBtn');
  if (csvBtn) csvBtn.style.display = tab === 'quotes' ? '' : 'none';

  // Load tab data
  if (tab === 'schedule') { loadTeamForDropdowns(); loadSchedule(); loadRecurring(); }
  if (tab === 'team') loadTeam();
  if (tab === 'customers') { loadCustomers(); loadCustStats(); loadAnalytics(); }
  if (tab === 'invoices') loadInvoices();
  if (tab === 'chats') loadChats();
  if (tab === 'settings') loadSettings();
}

// ============================
// SCHEDULE STATE
// ============================
var schedState = {
  view: 'day', // 'day' or 'week'
  currentDate: new Date(),
  jobs: [],
  team: [],
  currentJob: null,
  selectedQuote: null,
  selectedTeamColor: '#a3e635'
};

// ============================
// SCHEDULE NAVIGATION
// ============================
function schedNavPrev() {
  if (schedState.view === 'day') {
    schedState.currentDate.setDate(schedState.currentDate.getDate() - 1);
  } else {
    schedState.currentDate.setDate(schedState.currentDate.getDate() - 7);
  }
  loadSchedule();
}

function schedNavNext() {
  if (schedState.view === 'day') {
    schedState.currentDate.setDate(schedState.currentDate.getDate() + 1);
  } else {
    schedState.currentDate.setDate(schedState.currentDate.getDate() + 7);
  }
  loadSchedule();
}

function schedGoToday() {
  schedState.currentDate = new Date();
  loadSchedule();
}

function toggleSchedView() {
  schedState.view = schedState.view === 'day' ? 'week' : 'day';
  document.getElementById('schedViewBtn').textContent = schedState.view === 'day' ? 'Week View' : 'Day View';
  loadSchedule();
}

function formatSchedDate(d) {
  var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return days[d.getDay()] + ' ' + d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
}

function toDateStr(d) {
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function getMonday(d) {
  var day = d.getDay();
  var diff = day === 0 ? -6 : 1 - day;
  var mon = new Date(d);
  mon.setDate(d.getDate() + diff);
  return mon;
}

// ============================
// LOAD SCHEDULE
// ============================
async function loadSchedule() {
  var teamFilter = document.getElementById('sched-filter-team').value;

  if (schedState.view === 'day') {
    document.getElementById('schedDayView').classList.remove('hidden');
    document.getElementById('schedWeekView').classList.add('hidden');
    document.getElementById('schedTitle').textContent = formatSchedDate(schedState.currentDate);

    var dateStr = toDateStr(schedState.currentDate);
    try {
      var params = '?date=' + dateStr;
      if (teamFilter) params += '&assigned_to=' + encodeURIComponent(teamFilter);
      var res = await apiRequest('/admin/jobs' + params);
      if (res.success) {
        schedState.jobs = res.data;
        renderDayView(res.data);
      }
    } catch (e) {
      console.error('Failed to load day jobs:', e);
    }
  } else {
    document.getElementById('schedDayView').classList.add('hidden');
    document.getElementById('schedWeekView').classList.remove('hidden');

    var mon = getMonday(schedState.currentDate);
    var sun = new Date(mon);
    sun.setDate(mon.getDate() + 6);
    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    document.getElementById('schedTitle').textContent = 'Week of ' + mon.getDate() + ' ' + months[mon.getMonth()] + ' ' + mon.getFullYear();

    try {
      var params2 = '?assigned_to=' + encodeURIComponent(teamFilter || '');
      var res2 = await apiRequest('/admin/jobs/week/' + toDateStr(mon) + params2);
      if (res2.success) {
        schedState.jobs = res2.data;
        renderWeekView(res2.data, mon);
      }
    } catch (e) {
      console.error('Failed to load week jobs:', e);
    }
  }
}

// ============================
// RENDER DAY VIEW
// ============================
function renderDayView(jobs) {
  // Sort jobs by time_slot (e.g. "07:00", "09:30", "14:00")
  jobs.sort(function(a, b) {
    var ta = a.time_slot || '99:99';
    var tb = b.time_slot || '99:99';
    return ta.localeCompare(tb);
  });

  renderJobCards('schedDayJobs', jobs);
  document.getElementById('schedDayEmpty').classList.toggle('hidden', jobs.length > 0);

  updateScheduleTotals(jobs);
}

function renderJobCards(containerId, jobs) {
  var container = document.getElementById(containerId);
  container.innerHTML = '';

  jobs.forEach(function(j) {
    var card = document.createElement('div');
    card.className = 'bg-neutral-900 border border-neutral-800 rounded-xl p-4 cursor-pointer hover:border-neutral-700 transition-colors relative';
    card.onclick = function() { openJobDetail(j.id); };

    var teamMember = schedState.team.find(function(t) { return t.name === j.assigned_to; });
    var dotColor = teamMember ? teamMember.color : '#737373';
    var payBadge = getPaymentBadge(j);
    var statusColor = getJobStatusColor(j.status);

    var timeDisplay = j.time_slot || '';

    // WhatsApp link for phone
    var whatsappLink = '';
    if (j.customer_phone) {
      var waNum = j.customer_phone.replace(/[\s\-\(\)]/g, '');
      if (waNum.startsWith('0')) waNum = '44' + waNum.substring(1);
      else if (waNum.startsWith('+')) waNum = waNum.substring(1);
      whatsappLink = '<a href="https://wa.me/' + waNum + '" target="_blank" onclick="event.stopPropagation()" class="text-green-400 hover:text-green-300 ml-1" title="WhatsApp"><svg class="w-3.5 h-3.5 inline" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm0 18a8 8 0 01-4.243-1.212l-.258-.153-2.844.846.846-2.844-.153-.258A8 8 0 1112 20z"/></svg></a>';
    }

    card.innerHTML =
      '<div class="flex items-center justify-between mb-2">' +
        '<div class="flex items-center gap-2">' +
          '<span class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background:' + dotColor + '"></span>' +
          '<span class="text-white font-bold text-xs bg-neutral-800 px-2 py-0.5 rounded">' + esc(timeDisplay) + '</span>' +
          '<span class="text-sm text-white font-medium">' + esc(j.customer_name) + '</span>' +
          '<span class="text-xs text-neutral-600">' + esc(j.postcode) + '</span>' +
          whatsappLink +
        '</div>' +
        '<div class="flex items-center gap-2">' +
          '<span class="text-sm font-semibold text-lime-400">' + (j.job_value ? '\u00A3' + Number(j.job_value).toFixed(0) : '') + '</span>' +
          '<button onclick="event.stopPropagation(); toggleQuickReassign(this, \'' + j.id + '\')" class="text-neutral-600 hover:text-lime-400 transition-colors p-1 rounded hover:bg-neutral-800" title="Quick reassign">' +
            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>' +
          '</button>' +
        '</div>' +
      '</div>' +
      '<div class="flex items-center justify-between">' +
        '<div class="text-xs text-neutral-500">' +
          esc(j.service) +
          (j.assigned_to ? ' | ' + esc(j.assigned_to) : '') +
          (j.estimated_duration ? ' | ~' + esc(j.estimated_duration) : '') +
          (j.recurring_job_id ? ' | Recurring' : '') +
        '</div>' +
        '<div class="flex items-center gap-2">' +
          '<span class="px-2 py-0.5 rounded text-[10px] font-medium ' + statusColor + '">' + capitalize(j.status) + '</span>' +
          payBadge +
        '</div>' +
      '</div>';

    container.appendChild(card);
  });
}

// Quick reassign dropdown on job cards
function toggleQuickReassign(btn, jobId) {
  // Close any existing dropdown
  var existing = document.querySelector('.quick-reassign-dropdown');
  if (existing) { existing.remove(); return; }

  var dropdown = document.createElement('div');
  dropdown.className = 'quick-reassign-dropdown absolute right-2 top-10 bg-neutral-800 border border-neutral-700 rounded-lg shadow-xl z-30 py-1 min-w-[140px] fade-in';

  var job = schedState.jobs.find(function(j) { return j.id === jobId; });

  // Unassigned option
  var unOpt = document.createElement('button');
  unOpt.className = 'w-full text-left px-3 py-2 text-xs text-neutral-400 hover:bg-neutral-700 hover:text-white transition-colors' + (!job.assigned_to ? ' text-lime-400 font-semibold' : '');
  unOpt.textContent = 'Unassigned';
  unOpt.onclick = function(e) { e.stopPropagation(); quickReassign(jobId, null); dropdown.remove(); };
  dropdown.appendChild(unOpt);

  (schedState.team || []).forEach(function(t) {
    if (!t.is_active) return;
    var opt = document.createElement('button');
    var isActive = t.name === (job && job.assigned_to);
    opt.className = 'w-full text-left px-3 py-2 text-xs hover:bg-neutral-700 transition-colors flex items-center gap-2' + (isActive ? ' text-lime-400 font-semibold' : ' text-neutral-300 hover:text-white');
    opt.innerHTML = '<span class="w-2 h-2 rounded-full flex-shrink-0" style="background:' + t.color + '"></span>' + esc(t.name);
    opt.onclick = function(e) { e.stopPropagation(); quickReassign(jobId, t.name); dropdown.remove(); };
    dropdown.appendChild(opt);
  });

  btn.closest('.relative').appendChild(dropdown);

  // Close on click outside
  setTimeout(function() {
    document.addEventListener('click', function closeDropdown(e) {
      if (!dropdown.contains(e.target)) { dropdown.remove(); document.removeEventListener('click', closeDropdown); }
    });
  }, 10);
}

async function quickReassign(jobId, teamName) {
  try {
    var res = await apiRequest('/admin/jobs/' + jobId, { method: 'PATCH', body: { assigned_to: teamName } });
    if (res.success) {
      loadSchedule();
      showToast(teamName ? 'Reassigned to ' + teamName : 'Unassigned', 'success');
    }
  } catch (e) {
    showToast('Failed to reassign', 'error');
  }
}

function getPaymentBadge(j) {
  if (j.status !== 'completed') return '<span class="px-2 py-0.5 rounded text-[10px] font-medium text-neutral-500 bg-neutral-800">Pending</span>';
  if (j.payment_status === 'paid') return '<span class="px-2 py-0.5 rounded text-[10px] font-medium text-green-300 bg-green-900/60">' + (j.payment_method ? capitalize(j.payment_method) + ' Paid' : 'Paid') + '</span>';
  if (j.payment_status === 'outstanding') return '<span class="px-2 py-0.5 rounded text-[10px] font-medium text-red-300 bg-red-900/60">Outstanding</span>';
  if (j.payment_status === 'partial') return '<span class="px-2 py-0.5 rounded text-[10px] font-medium text-orange-300 bg-orange-900/60">Partial</span>';
  return '<span class="px-2 py-0.5 rounded text-[10px] font-medium text-neutral-500 bg-neutral-800">Pending</span>';
}

function getJobStatusColor(status) {
  var map = {
    scheduled: 'text-blue-300 bg-blue-900/60',
    in_progress: 'text-yellow-300 bg-yellow-900/60',
    completed: 'text-green-300 bg-green-900/60',
    cancelled: 'text-red-300 bg-red-900/60',
    not_available: 'text-orange-300 bg-orange-900/60'
  };
  return map[status] || 'text-neutral-300 bg-neutral-700';
}

// ============================
// RENDER WEEK VIEW
// ============================
function renderWeekView(jobs, monday) {
  var headers = document.getElementById('weekHeaders');
  var grid = document.getElementById('weekGrid');
  var dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  var todayStr = toDateStr(new Date());

  headers.innerHTML = '';
  grid.innerHTML = '';

  for (var i = 0; i < 7; i++) {
    var d = new Date(monday);
    d.setDate(monday.getDate() + i);
    var dateStr = toDateStr(d);
    var isToday = dateStr === todayStr;

    // Header
    var hdr = document.createElement('div');
    hdr.className = 'text-center py-2 text-xs font-semibold rounded-t-lg ' + (isToday ? 'bg-lime-400/10 text-lime-400' : 'text-neutral-500');
    hdr.innerHTML = dayNames[i] + '<br><span class="text-sm ' + (isToday ? 'text-lime-400' : 'text-white') + '">' + d.getDate() + '</span>';
    headers.appendChild(hdr);

    // Day column (droppable target)
    var col = document.createElement('div');
    col.className = 'bg-neutral-900 border border-neutral-800 rounded-b-lg p-1.5 space-y-1 min-h-[120px] transition-colors ' + (isToday ? 'border-lime-400/30' : '');
    col.dataset.date = dateStr;
    col.onclick = (function(ds) { return function() { schedState.currentDate = new Date(ds + 'T00:00:00'); schedState.view = 'day'; document.getElementById('schedViewBtn').textContent = 'Week View'; loadSchedule(); }; })(dateStr);

    // Drag-and-drop: allow drop on day columns
    col.addEventListener('dragover', function(e) { e.preventDefault(); this.style.borderColor = '#a3e635'; this.style.background = 'rgba(163, 230, 53, 0.05)'; });
    col.addEventListener('dragleave', function(e) { this.style.borderColor = ''; this.style.background = ''; });
    col.addEventListener('drop', (function(targetDate) { return function(e) {
      e.preventDefault();
      this.style.borderColor = ''; this.style.background = '';
      var jobId = e.dataTransfer.getData('text/plain');
      if (jobId) dragDropReschedule(jobId, targetDate);
    }; })(dateStr));

    var dayJobs = jobs.filter(function(j) { return j.scheduled_date === dateStr; });
    dayJobs.forEach(function(j) {
      var teamMember = schedState.team.find(function(t) { return t.name === j.assigned_to; });
      var dotColor = teamMember ? teamMember.color : '#737373';
      var mini = document.createElement('div');
      mini.className = 'bg-black/50 rounded-lg p-2 text-[11px] cursor-pointer hover:bg-neutral-800 transition-colors';
      mini.draggable = true;
      mini.dataset.jobId = j.id;
      mini.onclick = function(e) { e.stopPropagation(); openJobDetail(j.id); };

      // Drag-and-drop: make mini cards draggable
      mini.addEventListener('dragstart', (function(job) { return function(e) {
        e.stopPropagation();
        e.dataTransfer.setData('text/plain', job.id);
        e.dataTransfer.effectAllowed = 'move';
        this.style.opacity = '0.4';
      }; })(j));
      mini.addEventListener('dragend', function() { this.style.opacity = '1'; });

      mini.innerHTML =
        '<div class="flex items-center gap-1 mb-0.5">' +
          '<span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background:' + dotColor + '"></span>' +
          '<span class="text-neutral-400 font-semibold">' + esc(j.time_slot || '') + '</span>' +
        '</div>' +
        '<div class="text-white font-medium truncate">' + esc(j.customer_name.split(' ').pop()) + '</div>' +
        '<div class="text-neutral-500 truncate">' + esc(j.service.split(' ')[0]) + '</div>' +
        (j.job_value ? '<div class="text-lime-400 font-semibold">\u00A3' + Number(j.job_value).toFixed(0) + '</div>' : '') +
        (j.assigned_to ? '<div class="text-neutral-600 truncate">' + esc(j.assigned_to) + '</div>' : '');
      col.appendChild(mini);
    });

    grid.appendChild(col);
  }

  updateScheduleTotals(jobs);
}

// Drag-and-drop reschedule handler
async function dragDropReschedule(jobId, newDate) {
  var job = schedState.jobs.find(function(j) { return j.id === jobId; });
  if (!job || job.scheduled_date === newDate) return;

  try {
    var res = await apiRequest('/admin/jobs/' + jobId, { method: 'PATCH', body: { scheduled_date: newDate } });
    if (res.success) {
      var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      var d = new Date(newDate + 'T00:00:00');
      showToast('Moved ' + job.customer_name + ' to ' + dayNames[d.getDay()] + ' ' + d.getDate(), 'success');
      loadSchedule();
    }
  } catch (e) {
    showToast('Failed to reschedule', 'error');
  }
}

function updateScheduleTotals(jobs) {
  var totalValue = 0, paid = 0, outstanding = 0;
  jobs.forEach(function(j) {
    totalValue += Number(j.job_value || 0);
    if (j.payment_status === 'paid') paid++;
    if (j.payment_status === 'outstanding') outstanding++;
  });
  document.getElementById('schedTotalJobs').textContent = jobs.length;
  document.getElementById('schedTotalRevenue').textContent = '\u00A3' + totalValue.toFixed(0);
  document.getElementById('schedTotalPaid').textContent = paid;
  document.getElementById('schedTotalOutstanding').textContent = outstanding;
}

// ============================
// JOB DETAIL MODAL
// ============================
var jdDatePicker = null;
var jdOriginalDate = '';
var jdOriginalTime = '';

async function openJobDetail(id) {
  var job = schedState.jobs.find(function(j) { return j.id === id; });
  if (!job) {
    try {
      var res = await apiRequest('/admin/jobs?date=' + job.scheduled_date);
      job = res.data.find(function(j) { return j.id === id; });
    } catch (e) { return; }
  }
  if (!job) return;

  schedState.currentJob = job;
  jdOriginalDate = job.scheduled_date || '';
  jdOriginalTime = job.time_slot || '';
  document.getElementById('jobDetailModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  // Header
  document.getElementById('jd-title').textContent = job.customer_name + ' - ' + job.service;

  // Customer info (read-only)
  document.getElementById('jd-name').textContent = job.customer_name;
  var phoneEl = document.getElementById('jd-phone');
  phoneEl.textContent = job.customer_phone || '-';
  phoneEl.href = job.customer_phone ? 'tel:' + job.customer_phone : '#';
  document.getElementById('jd-address').textContent = (job.address || '') + ' ' + (job.postcode || '');
  document.getElementById('jd-service').textContent = job.service;

  // Scheduling fields (editable)
  // Date picker
  if (jdDatePicker) jdDatePicker.destroy();
  jdDatePicker = flatpickr('#jd-date', {
    dateFormat: 'Y-m-d',
    altInput: true,
    altFormat: 'D j M Y',
    defaultDate: job.scheduled_date || null,
    theme: 'dark',
    onChange: function(selectedDates, dateStr) {
      patchJob('scheduled_date', dateStr);
    }
  });

  // Time dropdown
  document.getElementById('jd-time').value = job.time_slot || '09:00';

  // Assigned dropdown - populate with team members
  var assignedSelect = document.getElementById('jd-assigned');
  assignedSelect.innerHTML = '<option value="">Unassigned</option>';
  (schedState.team || []).forEach(function(t) {
    if (!t.is_active) return;
    var opt = document.createElement('option');
    opt.value = t.name;
    opt.textContent = t.name;
    if (t.name === job.assigned_to) opt.selected = true;
    assignedSelect.appendChild(opt);
  });

  // Duration dropdown
  document.getElementById('jd-duration').value = job.estimated_duration || '';

  // Value input
  document.getElementById('jd-value').value = job.job_value || '';

  // Notes
  document.getElementById('jd-notes').value = job.notes || '';

  // Notify section - hidden by default, shown after reschedule
  document.getElementById('jd-notifySection').classList.add('hidden');
  document.getElementById('jd-notifyBtn').disabled = false;
  document.getElementById('jd-notifyBtn').innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg> Notify Customer of Schedule Change';

  renderJobStatusButtons(job.status);
  renderPaymentSection(job);
  renderInvoiceSection(job);
}

function closeJobDetail() {
  document.getElementById('jobDetailModal').classList.add('hidden');
  document.body.style.overflow = '';
  if (jdDatePicker) { jdDatePicker.destroy(); jdDatePicker = null; }
  schedState.currentJob = null;
}

// Generic patch helper for inline edits
async function patchJob(field, value) {
  if (!schedState.currentJob) return;
  var body = {};
  body[field] = value;
  try {
    var res = await apiRequest('/admin/jobs/' + schedState.currentJob.id, { method: 'PATCH', body: body });
    if (res.success) {
      schedState.currentJob = res.data;
      loadSchedule();

      // Show notify button if date or time changed
      if (field === 'scheduled_date' || field === 'time_slot') {
        var dateChanged = schedState.currentJob.scheduled_date !== jdOriginalDate;
        var timeChanged = schedState.currentJob.time_slot !== jdOriginalTime;
        if (dateChanged || timeChanged) {
          document.getElementById('jd-notifySection').classList.remove('hidden');
          document.getElementById('jd-notifyBtn').disabled = false;
          document.getElementById('jd-notifyBtn').innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg> Notify Customer of Schedule Change';
        }
      }

      var labels = {
        scheduled_date: 'Date updated',
        time_slot: 'Time updated',
        assigned_to: value ? 'Reassigned to ' + value : 'Unassigned',
        estimated_duration: 'Duration updated',
        job_value: 'Value updated'
      };
      showToast(labels[field] || 'Updated', 'success');
    }
  } catch (e) {
    showToast('Failed to update', 'error');
  }
}

// Notify customer of reschedule (opt-in only)
async function notifyCustomerReschedule() {
  if (!schedState.currentJob) return;
  var job = schedState.currentJob;
  var btn = document.getElementById('jd-notifyBtn');
  btn.disabled = true;
  btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Sending...';

  try {
    var res = await apiRequest('/admin/jobs/' + job.id + '/notify-reschedule', {
      method: 'POST',
      body: { scheduled_date: job.scheduled_date, time_slot: job.time_slot }
    });
    if (res.success) {
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Customer Notified';
      btn.className = 'w-full flex items-center justify-center gap-2 bg-green-900/60 text-green-300 border border-green-800 py-2.5 rounded-lg text-xs font-medium cursor-default';
      var statusEl = document.getElementById('jd-notifyStatus');
      statusEl.classList.remove('hidden');
      statusEl.textContent = 'WhatsApp + Email sent to ' + (job.customer_name || 'customer');
      showToast('Customer notified', 'success');
    } else {
      throw new Error(res.error || 'Failed');
    }
  } catch (e) {
    btn.disabled = false;
    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg> Notify Customer of Schedule Change';
    showToast('Failed to notify customer: ' + e.message, 'error');
  }
}

function renderJobStatusButtons(currentStatus) {
  var statuses = ['scheduled', 'in_progress', 'completed', 'cancelled', 'not_available'];
  var colors = {
    scheduled: 'bg-blue-900 hover:bg-blue-800',
    in_progress: 'bg-yellow-900 hover:bg-yellow-800',
    completed: 'bg-green-900 hover:bg-green-800',
    cancelled: 'bg-red-900 hover:bg-red-800',
    not_available: 'bg-orange-900 hover:bg-orange-800'
  };
  var activeColors = {
    scheduled: 'bg-blue-700 ring-2 ring-blue-400',
    in_progress: 'bg-yellow-700 ring-2 ring-yellow-400',
    completed: 'bg-green-700 ring-2 ring-green-400',
    cancelled: 'bg-red-700 ring-2 ring-red-400',
    not_available: 'bg-orange-700 ring-2 ring-orange-400'
  };
  var labels = { scheduled: 'Scheduled', in_progress: 'In Progress', completed: 'Completed', cancelled: 'Cancelled', not_available: 'Not Available' };

  var container = document.getElementById('jd-statusButtons');
  container.innerHTML = '';

  statuses.forEach(function(s) {
    var isActive = s === currentStatus;
    var btn = document.createElement('button');
    btn.className = 'px-3 py-1.5 rounded-lg text-xs text-white font-medium transition-all ' + (isActive ? activeColors[s] : colors[s]);
    btn.textContent = labels[s];
    if (!isActive) {
      btn.onclick = function() { updateJobStatus(s); };
    }
    container.appendChild(btn);
  });
}

async function updateJobStatus(newStatus) {
  if (!schedState.currentJob) return;
  try {
    var res = await apiRequest('/admin/jobs/' + schedState.currentJob.id, {
      method: 'PATCH',
      body: { status: newStatus }
    });
    if (res.success) {
      schedState.currentJob = res.data;
      renderJobStatusButtons(newStatus);
      renderPaymentSection(res.data);
      renderInvoiceSection(res.data);
      loadSchedule();
      showToast('Job status updated to ' + capitalize(newStatus), 'success');
    }
  } catch (e) {
    showToast('Failed to update job status', 'error');
  }
}

// ============================
// PAYMENT TRACKING
// ============================
var selectedPaymentStatus = '';
var selectedPaymentMethod = '';

function renderPaymentSection(job) {
  var section = document.getElementById('jd-paymentSection');
  if (job.status !== 'completed') {
    section.classList.add('hidden');
    return;
  }
  section.classList.remove('hidden');
  selectedPaymentStatus = job.payment_status || 'pending';
  selectedPaymentMethod = job.payment_method || '';

  renderPaymentButtons();
}

function renderPaymentButtons() {
  var payStatuses = ['paid', 'outstanding', 'partial'];
  var payColors = { paid: 'bg-green-900', outstanding: 'bg-red-900', partial: 'bg-orange-900' };
  var payActive = { paid: 'bg-green-700 ring-2 ring-green-400', outstanding: 'bg-red-700 ring-2 ring-red-400', partial: 'bg-orange-700 ring-2 ring-orange-400' };

  var container = document.getElementById('jd-paymentButtons');
  container.innerHTML = '';
  payStatuses.forEach(function(s) {
    var isActive = s === selectedPaymentStatus;
    var btn = document.createElement('button');
    btn.className = 'px-3 py-1.5 rounded-lg text-xs text-white font-medium transition-all ' + (isActive ? payActive[s] : payColors[s] + ' hover:opacity-80');
    btn.textContent = capitalize(s);
    btn.onclick = function() {
      selectedPaymentStatus = s;
      renderPaymentButtons();
    };
    container.appendChild(btn);
  });

  // Show method section when a payment status is selected (not pending)
  var methodSection = document.getElementById('jd-methodSection');
  if (selectedPaymentStatus && selectedPaymentStatus !== 'pending') {
    methodSection.classList.remove('hidden');
    renderMethodButtons();
  } else {
    methodSection.classList.add('hidden');
  }
}

function renderMethodButtons() {
  var methods = ['cash', 'transfer', 'card'];
  var container = document.getElementById('jd-methodButtons');
  container.innerHTML = '';
  methods.forEach(function(m) {
    var isActive = m === selectedPaymentMethod;
    var btn = document.createElement('button');
    btn.className = 'px-3 py-1.5 rounded-lg text-xs font-medium transition-all ' + (isActive ? 'bg-lime-400 text-black ring-2 ring-lime-300' : 'bg-neutral-800 text-neutral-300 hover:bg-neutral-700');
    btn.textContent = capitalize(m);
    btn.onclick = function() { selectedPaymentMethod = m; renderMethodButtons(); };
    container.appendChild(btn);
  });

  // Show amount field for partial payments
  var amountSection = document.getElementById('jd-amountSection');
  if (selectedPaymentStatus === 'partial') {
    amountSection.classList.remove('hidden');
    if (schedState.currentJob) document.getElementById('jd-amountPaid').value = schedState.currentJob.amount_paid || '';
  } else {
    amountSection.classList.add('hidden');
  }
}

async function savePayment() {
  if (!schedState.currentJob) return;
  var body = {
    payment_status: selectedPaymentStatus,
    payment_method: selectedPaymentMethod || null
  };
  if (selectedPaymentStatus === 'partial') {
    body.amount_paid = parseFloat(document.getElementById('jd-amountPaid').value) || 0;
  } else if (selectedPaymentStatus === 'paid') {
    body.amount_paid = schedState.currentJob.job_value;
  }

  try {
    var res = await apiRequest('/admin/jobs/' + schedState.currentJob.id, { method: 'PATCH', body: body });
    if (res.success) {
      schedState.currentJob = res.data;
      loadSchedule();
      showToast('Payment saved', 'success');
    }
  } catch (e) {
    showToast('Failed to save payment', 'error');
  }
}

async function saveJobNotes() {
  if (!schedState.currentJob) return;
  var notes = document.getElementById('jd-notes').value;
  try {
    var res = await apiRequest('/admin/jobs/' + schedState.currentJob.id, { method: 'PATCH', body: { notes: notes } });
    if (res.success) showToast('Notes saved', 'success');
  } catch (e) {
    showToast('Failed to save notes', 'error');
  }
}

async function deleteCurrentJob() {
  if (!schedState.currentJob) return;
  if (!confirm('Delete this job? This cannot be undone.')) return;
  try {
    var res = await apiRequest('/admin/jobs/' + schedState.currentJob.id, { method: 'DELETE' });
    if (res.success) {
      closeJobDetail();
      loadSchedule();
      showToast('Job deleted', 'success');
    }
  } catch (e) {
    showToast('Failed to delete job', 'error');
  }
}

// ============================
// ADD JOB MODAL
// ============================
function initFlatpickr() {
  var fpConfig = {
    dateFormat: 'Y-m-d',
    altInput: true,
    altFormat: 'D j M Y',
    disableMobile: true,
    theme: 'dark'
  };

  if (window._fpJobDate) window._fpJobDate.destroy();
  if (window._fpQpDate) window._fpQpDate.destroy();
  if (window._fpEndDate) window._fpEndDate.destroy();

  window._fpJobDate = flatpickr('#job-date', Object.assign({}, fpConfig));
  window._fpQpDate = flatpickr('#qp-date', Object.assign({}, fpConfig));
  window._fpEndDate = flatpickr('#job-enddate', Object.assign({}, fpConfig, { altFormat: 'D j M Y', allowInput: false }));
}

function openAddJobModal(recurring) {
  document.getElementById('jobModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  document.getElementById('jobModalTitle').textContent = recurring ? 'Add Recurring Job' : 'Add Job';

  // Init flatpickr calendars
  initFlatpickr();

  // Set default date to current schedule date
  var dateStr = toDateStr(schedState.currentDate);
  if (window._fpJobDate) window._fpJobDate.setDate(dateStr, true);

  // Pre-check recurring toggle if opened as recurring
  if (recurring) {
    document.getElementById('job-recurring-toggle').checked = true;
    toggleRecurringFields();
  }

  // Hide recurring toggle if opened as recurring
  document.getElementById('recurringToggleWrap').style.display = recurring ? 'none' : '';

  loadTeamForDropdowns();
  switchJobTab('manual');
}

function closeJobModal() {
  document.getElementById('jobModal').classList.add('hidden');
  document.body.style.overflow = '';
  // Reset form
  ['job-name','job-phone','job-email','job-address','job-postcode','job-value','job-notes','job-cust-search'].forEach(function(id) {
    document.getElementById(id).value = '';
  });
  document.getElementById('job-customer-id').value = '';
  document.getElementById('job-cust-results').classList.add('hidden');
  document.getElementById('job-service').value = '';
  document.getElementById('job-recurring-toggle').checked = false;
  document.getElementById('recurringFields').classList.add('hidden');
  schedState.selectedQuote = null;
}

function switchJobTab(tab) {
  document.getElementById('jobContent-manual').classList.toggle('hidden', tab !== 'manual');
  document.getElementById('jobContent-fromQuote').classList.toggle('hidden', tab !== 'fromQuote');
  document.getElementById('jobTab-manual').className = 'flex-1 px-4 py-3 text-xs font-semibold border-b-2 ' + (tab === 'manual' ? 'text-lime-400 border-lime-400' : 'text-neutral-500 border-transparent hover:text-neutral-300');
  document.getElementById('jobTab-fromQuote').className = 'flex-1 px-4 py-3 text-xs font-semibold border-b-2 ' + (tab === 'fromQuote' ? 'text-lime-400 border-lime-400' : 'text-neutral-500 border-transparent hover:text-neutral-300');

  if (tab === 'fromQuote') loadQuotesForPicker();
}

function toggleRecurringFields() {
  var checked = document.getElementById('job-recurring-toggle').checked;
  document.getElementById('recurringFields').classList.toggle('hidden', !checked);
}

async function submitJob() {
  var name = document.getElementById('job-name').value.trim();
  var address = document.getElementById('job-address').value.trim();
  var postcode = document.getElementById('job-postcode').value.trim();
  var service = document.getElementById('job-service').value;
  var date = document.getElementById('job-date').value;

  if (!name || !address || !postcode || !service || !date) {
    showToast('Please fill in all required fields', 'error');
    return;
  }

  var isRecurring = document.getElementById('job-recurring-toggle').checked;

  var body = {
    customer_id: document.getElementById('job-customer-id').value || null,
    customer_name: name,
    customer_phone: document.getElementById('job-phone').value.trim() || null,
    customer_email: document.getElementById('job-email').value.trim() || null,
    address: address,
    postcode: postcode,
    service: service,
    scheduled_date: date,
    time_slot: document.getElementById('job-timeslot').value,
    assigned_to: document.getElementById('job-assigned').value || null,
    estimated_duration: document.getElementById('job-duration').value || null,
    job_value: parseFloat(document.getElementById('job-value').value) || null,
    notes: document.getElementById('job-notes').value.trim() || null
  };

  try {
    if (isRecurring) {
      // Create recurring pattern first
      var recurBody = Object.assign({}, body);
      delete recurBody.scheduled_date;
      recurBody.start_date = date;
      recurBody.repeat_interval = document.getElementById('job-repeat').value;
      recurBody.end_date = document.getElementById('job-enddate').value || null;

      var rRes = await apiRequest('/admin/recurring', { method: 'POST', body: recurBody });
      if (rRes.success) {
        // Generate jobs for next 4 weeks
        await apiRequest('/admin/recurring/' + rRes.data.id + '/generate', { method: 'POST', body: { weeks: 4 } });
        showToast('Recurring job created', 'success');
      }
    } else {
      var res = await apiRequest('/admin/jobs', { method: 'POST', body: body });
      if (res.success) {
        showToast('Job created', 'success');
      }
    }

    closeJobModal();
    loadSchedule();
    loadRecurring();
  } catch (e) {
    showToast('Failed to create job', 'error');
  }
}

// ============================
// FROM QUOTE TAB
// ============================
async function loadQuotesForPicker() {
  var loading = document.getElementById('quotePickerLoading');
  var list = document.getElementById('quotePickerList');
  var empty = document.getElementById('quotePickerEmpty');
  var selected = document.getElementById('quotePickerSelected');

  loading.classList.remove('hidden');
  list.innerHTML = '';
  empty.classList.add('hidden');
  selected.classList.add('hidden');

  try {
    var res = await apiRequest('/admin/quotes?limit=100&sort=created_at&order=desc');
    loading.classList.add('hidden');

    if (!res.success || res.data.length === 0) {
      empty.classList.remove('hidden');
      return;
    }

    // Filter to accepted/booked quotes
    var eligible = res.data.filter(function(q) {
      return q.customer_accepted_estimate || q.status === 'booked' || q.status === 'quoted';
    });

    if (eligible.length === 0) {
      empty.classList.remove('hidden');
      return;
    }

    eligible.forEach(function(q) {
      var item = document.createElement('div');
      item.className = 'bg-black border border-neutral-700 rounded-lg p-3 cursor-pointer hover:border-lime-400 transition-colors';
      item.onclick = function() { selectQuoteForJob(q); };
      var services = Array.isArray(q.services) ? q.services.map(capitalize).join(', ') : '';
      item.innerHTML =
        '<div class="flex items-center justify-between">' +
          '<span class="text-sm text-white font-medium">' + esc(q.name) + '</span>' +
          '<span class="text-xs text-lime-400">' + formatEstimate(q.estimated_value_min, q.estimated_value_max) + '</span>' +
        '</div>' +
        '<div class="text-xs text-neutral-500 mt-1">' + esc(services) + ' | ' + esc(q.postcode) + '</div>';
      list.appendChild(item);
    });
  } catch (e) {
    loading.classList.add('hidden');
    empty.classList.remove('hidden');
  }
}

function selectQuoteForJob(q) {
  schedState.selectedQuote = q;
  document.getElementById('quotePickerList').innerHTML = '';
  document.getElementById('quotePickerSelected').classList.remove('hidden');
  document.getElementById('qp-name').textContent = q.name;
  var services = Array.isArray(q.services) ? q.services.map(capitalize).join(', ') : '';
  document.getElementById('qp-details').textContent = services + ' | ' + (q.address_line1 || '') + ' ' + (q.postcode || '') + ' | ' + formatEstimate(q.estimated_value_min, q.estimated_value_max);
  if (window._fpQpDate) window._fpQpDate.setDate(toDateStr(schedState.currentDate), true);

  loadTeamForDropdowns();
}

async function submitJobFromQuote() {
  var q = schedState.selectedQuote;
  if (!q) return;

  var date = document.getElementById('qp-date').value;
  if (!date) { showToast('Please select a date', 'error'); return; }

  var services = Array.isArray(q.services) ? q.services.map(capitalize).join(', ') : 'Service';

  var body = {
    quote_id: q.id,
    customer_name: q.name,
    customer_phone: q.phone || null,
    customer_email: q.email || null,
    address: q.address_line1 || '',
    postcode: q.postcode || '',
    service: services,
    scheduled_date: date,
    time_slot: document.getElementById('qp-timeslot').value,
    assigned_to: document.getElementById('qp-assigned').value || null,
    estimated_duration: document.getElementById('qp-duration').value || null,
    job_value: q.final_value || q.estimated_value_max || q.estimated_value_min || null
  };

  try {
    var res = await apiRequest('/admin/jobs', { method: 'POST', body: body });
    if (res.success) {
      closeJobModal();
      loadSchedule();
      showToast('Job created from quote', 'success');
    }
  } catch (e) {
    showToast('Failed to create job', 'error');
  }
}

// ============================
// RECURRING JOBS
// ============================
async function loadRecurring() {
  try {
    var res = await apiRequest('/admin/recurring');
    if (!res.success) return;

    var list = document.getElementById('recurringList');
    var empty = document.getElementById('recurringEmpty');
    list.innerHTML = '';

    if (res.data.length === 0) {
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    res.data.forEach(function(r) {
      var card = document.createElement('div');
      card.className = 'bg-neutral-900 border border-neutral-800 rounded-xl p-4 flex flex-wrap items-center justify-between gap-3';

      var intervalLabel = {
        weekly: 'Weekly', fortnightly: 'Fortnightly', '3_weeks': 'Every 3 weeks',
        '4_weeks': 'Every 4 weeks', '6_weeks': 'Every 6 weeks', '8_weeks': 'Every 8 weeks', monthly: 'Monthly'
      };

      card.innerHTML =
        '<div>' +
          '<div class="text-sm text-white font-medium">' + esc(r.customer_name) + ' - ' + esc(r.service) + '</div>' +
          '<div class="text-xs text-neutral-500 mt-1">' +
            esc(intervalLabel[r.repeat_interval] || r.repeat_interval) +
            ' | ' + esc(r.address) + ' ' + esc(r.postcode) +
            (r.assigned_to ? ' | ' + esc(r.assigned_to) : '') +
            (r.job_value ? ' | \u00A3' + Number(r.job_value).toFixed(0) : '') +
          '</div>' +
        '</div>' +
        '<div class="flex items-center gap-2">' +
          '<button onclick="generateRecurring(\'' + r.id + '\')" class="bg-neutral-800 hover:bg-neutral-700 text-neutral-300 px-3 py-1.5 rounded-lg text-xs transition-colors">Generate 4 Weeks</button>' +
          '<button onclick="toggleRecurringActive(\'' + r.id + '\', ' + !r.is_active + ')" class="px-3 py-1.5 rounded-lg text-xs transition-colors ' + (r.is_active ? 'bg-green-900/60 text-green-300 hover:bg-red-900/60 hover:text-red-300' : 'bg-red-900/60 text-red-300 hover:bg-green-900/60 hover:text-green-300') + '">' + (r.is_active ? 'Active' : 'Paused') + '</button>' +
        '</div>';

      list.appendChild(card);
    });
  } catch (e) {
    console.error('Failed to load recurring:', e);
  }
}

async function generateRecurring(id) {
  try {
    var res = await apiRequest('/admin/recurring/' + id + '/generate', { method: 'POST', body: { weeks: 4 } });
    if (res.success) {
      showToast('Generated ' + res.created + ' jobs', 'success');
      loadSchedule();
    }
  } catch (e) {
    showToast('Failed to generate jobs', 'error');
  }
}

async function toggleRecurringActive(id, active) {
  try {
    var res = await apiRequest('/admin/recurring/' + id, { method: 'PATCH', body: { is_active: active } });
    if (res.success) {
      showToast(active ? 'Recurring job resumed' : 'Recurring job paused', 'success');
      loadRecurring();
    }
  } catch (e) {
    showToast('Failed to update recurring job', 'error');
  }
}

// ============================
// TEAM MANAGEMENT
// ============================
async function loadTeam() {
  try {
    var res = await apiRequest('/admin/team');
    if (!res.success) return;

    schedState.team = res.data;
    var list = document.getElementById('teamList');
    var empty = document.getElementById('teamEmpty');
    list.innerHTML = '';

    if (res.data.length === 0) {
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    res.data.forEach(function(m) {
      var card = document.createElement('div');
      card.className = 'bg-neutral-900 border border-neutral-800 rounded-xl p-5 flex items-center justify-between';
      var schedLink = window.location.origin + '/my-schedule.html?id=' + m.id;
      card.innerHTML =
        '<div class="flex items-center gap-3">' +
          '<div class="w-10 h-10 rounded-full flex items-center justify-center text-black font-bold text-lg" style="background:' + esc(m.color) + '">' + esc(m.name.charAt(0).toUpperCase()) + '</div>' +
          '<div>' +
            '<div class="text-white font-medium">' + esc(m.name) + '</div>' +
            '<div class="text-xs ' + (m.is_active ? 'text-green-400' : 'text-red-400') + '">' + (m.is_active ? 'Active' : 'Inactive') + '</div>' +
          '</div>' +
        '</div>' +
        '<div class="flex items-center gap-2">' +
          '<button onclick="copyScheduleLink(\'' + m.id + '\', \'' + esc(m.name) + '\')" class="text-xs px-3 py-1.5 rounded-lg transition-colors bg-lime-900/60 text-lime-300 hover:bg-lime-800" title="Copy schedule link">Copy Link</button>' +
          '<a href="' + schedLink + '" target="_blank" class="text-xs px-3 py-1.5 rounded-lg transition-colors bg-neutral-800 text-neutral-300 hover:bg-neutral-700">View</a>' +
          '<button onclick="toggleTeamActive(\'' + m.id + '\', ' + !m.is_active + ')" class="text-xs px-3 py-1.5 rounded-lg transition-colors ' + (m.is_active ? 'bg-red-900/60 text-red-300 hover:bg-red-800' : 'bg-green-900/60 text-green-300 hover:bg-green-800') + '">' + (m.is_active ? 'Deactivate' : 'Activate') + '</button>' +
        '</div>';
      list.appendChild(card);
    });
  } catch (e) {
    console.error('Failed to load team:', e);
  }
}

async function loadTeamForDropdowns() {
  try {
    var res = await apiRequest('/admin/team');
    if (!res.success) return;
    schedState.team = res.data;

    var dropdowns = ['job-assigned', 'qp-assigned', 'sched-filter-team'];
    dropdowns.forEach(function(id) {
      var el = document.getElementById(id);
      if (!el) return;
      var val = el.value;
      el.innerHTML = id === 'sched-filter-team' ? '<option value="">All Team</option>' : '<option value="">Unassigned</option>';
      res.data.filter(function(m) { return m.is_active; }).forEach(function(m) {
        var opt = document.createElement('option');
        opt.value = m.name;
        opt.textContent = m.name;
        el.appendChild(opt);
      });
      el.value = val;
    });
  } catch (e) {
    console.error('Failed to load team for dropdowns:', e);
  }
}

function openAddTeamModal() {
  document.getElementById('teamModal').classList.remove('hidden');
  document.getElementById('team-name').value = '';
  schedState.selectedTeamColor = '#a3e635';
  document.querySelectorAll('.team-color-btn').forEach(function(btn) {
    btn.style.borderColor = btn.getAttribute('data-color') === '#a3e635' ? 'white' : 'transparent';
  });
}

function closeTeamModal() {
  document.getElementById('teamModal').classList.add('hidden');
}

function pickTeamColor(color) {
  schedState.selectedTeamColor = color;
  document.querySelectorAll('.team-color-btn').forEach(function(btn) {
    btn.style.borderColor = btn.getAttribute('data-color') === color ? 'white' : 'transparent';
  });
}

async function submitTeamMember() {
  var name = document.getElementById('team-name').value.trim();
  if (!name) { showToast('Please enter a name', 'error'); return; }

  try {
    var res = await apiRequest('/admin/team', { method: 'POST', body: { name: name, color: schedState.selectedTeamColor } });
    if (res.success) {
      closeTeamModal();
      loadTeam();
      showToast('Team member added', 'success');
    }
  } catch (e) {
    showToast('Failed to add team member', 'error');
  }
}

function copyScheduleLink(id, name) {
  var link = window.location.origin + '/my-schedule.html?id=' + id;
  navigator.clipboard.writeText(link).then(function() {
    showToast('Schedule link for ' + name + ' copied!', 'success');
  }).catch(function() {
    // Fallback for older browsers
    var ta = document.createElement('textarea');
    ta.value = link;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('Schedule link for ' + name + ' copied!', 'success');
  });
}

async function toggleTeamActive(id, active) {
  try {
    var res = await apiRequest('/admin/team/' + id, { method: 'PATCH', body: { is_active: active } });
    if (res.success) {
      loadTeam();
      showToast(active ? 'Member activated' : 'Member deactivated', 'success');
    }
  } catch (e) {
    showToast('Failed to update member', 'error');
  }
}

// ============================
// CUSTOMERS
// ============================
var custState = {
  customers: [],
  total: 0,
  offset: 0,
  limit: 30,
  currentCustomer: null,
  bulkCustomerIds: []
};

var _custSearchTimer = null;
function debouncedCustSearch() {
  clearTimeout(_custSearchTimer);
  _custSearchTimer = setTimeout(function() { custState.offset = 0; loadCustomers(); }, 300);
}

async function loadCustStats() {
  try {
    var res = await apiRequest('/admin/customers/stats');
    if (res.success) {
      document.getElementById('cust-stat-total').textContent = res.stats.total_customers;
      document.getElementById('cust-stat-active').textContent = res.stats.active_customers;
      document.getElementById('cust-stat-revenue').textContent = '\u00A3' + Math.round(res.stats.total_revenue).toLocaleString();
      document.getElementById('cust-stat-avg').textContent = '\u00A3' + Math.round(res.stats.avg_spend);
    }
  } catch (e) { console.error('Stats error:', e); }
}

async function loadAnalytics() {
  try {
    var res = await apiRequest('/admin/customers/analytics');
    if (!res.success) return;
    var a = res.analytics;

    // === PIPELINE SNAPSHOT ===
    document.getElementById('analytics-pipeline-new').textContent = a.pipeline.awaiting_action;
    document.getElementById('analytics-pipeline-hot').textContent = a.pipeline.hot_leads_uncontacted;
    document.getElementById('analytics-pipeline-accepted').textContent = a.pipeline.accepted_not_booked;
    document.getElementById('analytics-pipeline-week').textContent = a.pipeline.jobs_this_week;
    document.getElementById('analytics-pipeline-month').textContent = a.pipeline.jobs_this_month;
    document.getElementById('analytics-pipeline-value').textContent = '\u00A3' + Math.round(a.pipeline.total_pipeline_value).toLocaleString();

    // === CONVERSION FUNNEL ===
    var funnel = a.funnel;
    var funnelEl = document.getElementById('analytics-funnel');
    funnelEl.innerHTML = '';
    var funnelSteps = [
      { label: 'Quotes Received', value: funnel.total_quotes, color: 'bg-neutral-500' },
      { label: 'Estimated', value: funnel.estimated, color: 'bg-blue-500' },
      { label: 'Sent to Customer', value: funnel.sent_to_customer, color: 'bg-indigo-500' },
      { label: 'Accepted', value: funnel.accepted, color: 'bg-lime-500' },
      { label: 'Booked', value: funnel.booked, color: 'bg-emerald-500' },
      { label: 'Completed', value: funnel.completed, color: 'bg-green-500' },
      { label: 'Paid', value: funnel.paid, color: 'bg-lime-400' }
    ];
    var funnelMax = funnelSteps[0].value || 1;
    funnelSteps.forEach(function(step, i) {
      var pct = Math.round((step.value / funnelMax) * 100);
      var dropoff = i > 0 && funnelSteps[i - 1].value > 0
        ? Math.round(((funnelSteps[i - 1].value - step.value) / funnelSteps[i - 1].value) * 100)
        : 0;
      var row = document.createElement('div');
      row.className = 'flex items-center gap-3';
      row.innerHTML =
        '<div class="w-32 text-xs text-neutral-400 text-right truncate">' + step.label + '</div>' +
        '<div class="flex-1 bg-neutral-800 rounded-full h-5 overflow-hidden">' +
          '<div class="' + step.color + ' h-full rounded-full transition-all" style="width:' + pct + '%"></div>' +
        '</div>' +
        '<div class="w-12 text-xs text-white font-medium text-right">' + step.value + '</div>' +
        (i > 0 ? '<div class="w-14 text-[10px] text-neutral-600 text-right">-' + dropoff + '%</div>' : '<div class="w-14"></div>');
      funnelEl.appendChild(row);
    });

    // === CONVERSION RATES ===
    document.getElementById('analytics-q2a-rate').textContent = a.quote_to_acceptance_rate + '%';
    document.getElementById('analytics-q2a-detail').textContent = a.quotes_accepted + ' of ' + a.quotes_with_estimate + ' quoted';
    document.getElementById('analytics-a2j-rate').textContent = a.acceptance_to_job_rate + '%';
    document.getElementById('analytics-a2j-detail').textContent = a.accepted_then_booked + ' of ' + a.accepted_customers + ' accepted';

    var hours = a.avg_time_to_accept_hours;
    if (hours === 0) {
      document.getElementById('analytics-avg-time').textContent = '-';
    } else if (hours >= 24) {
      document.getElementById('analytics-avg-time').textContent = Math.round(hours / 24 * 10) / 10 + ' days';
    } else {
      document.getElementById('analytics-avg-time').textContent = hours + ' hrs';
    }

    document.getElementById('analytics-followup-rate').textContent = a.followup_effectiveness + '%';
    document.getElementById('analytics-followup-detail').textContent = a.followed_up_then_booked + ' of ' + a.followed_up_count + ' followed up';

    // === RESPONSE SPEED ===
    var rm = a.response_metrics;
    var firstContactEl = document.getElementById('analytics-response-first-contact');
    if (rm.avg_time_to_first_action_hours === 0) {
      firstContactEl.textContent = '-';
    } else if (rm.avg_time_to_first_action_hours >= 24) {
      firstContactEl.textContent = Math.round(rm.avg_time_to_first_action_hours / 24 * 10) / 10 + ' days';
    } else {
      firstContactEl.textContent = rm.avg_time_to_first_action_hours + ' hrs';
    }

    var estimateEl = document.getElementById('analytics-response-estimate');
    if (rm.avg_time_to_estimate_hours < 0.1) {
      estimateEl.textContent = '< 1 min';
    } else {
      estimateEl.textContent = rm.avg_time_to_estimate_hours + ' hrs';
    }

    // === SERVICE REQUEST BARS ===
    var requestBars = document.getElementById('analytics-service-request-bars');
    requestBars.innerHTML = '';
    var svcData = a.service_insights.most_requested;
    var maxRequests = svcData.length > 0 ? svcData[0].quote_count : 1;
    svcData.forEach(function(svc) {
      var pct = Math.round((svc.quote_count / maxRequests) * 100);
      var row = document.createElement('div');
      row.className = 'flex items-center gap-3';
      row.innerHTML =
        '<div class="w-24 text-xs text-neutral-400 text-right truncate capitalize">' + esc(svc.service) + '</div>' +
        '<div class="flex-1 bg-neutral-800 rounded-full h-4 overflow-hidden">' +
          '<div class="bg-blue-500 h-full rounded-full transition-all" style="width:' + pct + '%"></div>' +
        '</div>' +
        '<div class="w-8 text-xs text-white font-medium">' + svc.quote_count + '</div>';
      requestBars.appendChild(row);
    });
    if (svcData.length === 0) {
      requestBars.innerHTML = '<div class="text-neutral-600 text-xs">No data yet</div>';
    }

    // === REVENUE BARS ===
    var bars = document.getElementById('analytics-revenue-bars');
    bars.innerHTML = '';
    var services = Object.entries(a.revenue_by_service).sort(function(x, y) { return y[1] - x[1]; });
    var maxVal = services.length > 0 ? services[0][1] : 1;
    services.forEach(function(entry) {
      var name = entry[0];
      var val = entry[1];
      var pct = Math.round((val / maxVal) * 100);
      var row = document.createElement('div');
      row.className = 'flex items-center gap-3';
      row.innerHTML =
        '<div class="w-24 text-xs text-neutral-400 text-right truncate capitalize">' + esc(name) + '</div>' +
        '<div class="flex-1 bg-neutral-800 rounded-full h-4 overflow-hidden">' +
          '<div class="bg-lime-400 h-full rounded-full transition-all" style="width:' + pct + '%"></div>' +
        '</div>' +
        '<div class="w-20 text-xs text-lime-400 font-medium">\u00A3' + Math.round(val).toLocaleString() + '</div>';
      bars.appendChild(row);
    });
    if (services.length === 0) {
      bars.innerHTML = '<div class="text-neutral-600 text-xs">No revenue data yet</div>';
    }

    // === SERVICE CONVERSION TABLE ===
    var convEl = document.getElementById('analytics-service-conversion');
    if (svcData.length === 0) {
      convEl.innerHTML = '<div class="text-neutral-600 text-xs">No data yet</div>';
    } else {
      var table = '<table class="w-full text-xs">' +
        '<thead><tr class="text-neutral-500 text-left">' +
        '<th class="pb-2">Service</th><th class="pb-2 text-right">Quotes</th>' +
        '<th class="pb-2 text-right">Conv Rate</th><th class="pb-2 text-right">Avg Value</th></tr></thead><tbody>';
      svcData.forEach(function(svc) {
        var rateColor = svc.conversion_rate >= 50 ? 'text-lime-400' : svc.conversion_rate >= 25 ? 'text-amber-400' : 'text-neutral-400';
        table += '<tr class="border-t border-neutral-800">' +
          '<td class="py-2 capitalize text-white">' + esc(svc.service) + '</td>' +
          '<td class="py-2 text-right text-neutral-400">' + svc.quote_count + '</td>' +
          '<td class="py-2 text-right font-medium ' + rateColor + '">' + svc.conversion_rate + '%</td>' +
          '<td class="py-2 text-right text-neutral-400">' + (svc.avg_value > 0 ? '\u00A3' + svc.avg_value : '-') + '</td></tr>';
      });
      table += '</tbody></table>';
      convEl.innerHTML = table;
    }

    // === CONTACT BREAKDOWN ===
    var contactEl = document.getElementById('analytics-contact-breakdown');
    contactEl.innerHTML = '';
    var contacts = Object.entries(a.customer_behaviour.preferred_contact_breakdown)
      .sort(function(x, y) { return y[1] - x[1]; });
    var maxContact = contacts.length > 0 ? contacts[0][1] : 1;
    contacts.forEach(function(entry) {
      var method = entry[0];
      var count = entry[1];
      var pct = Math.round((count / maxContact) * 100);
      var row = document.createElement('div');
      row.className = 'flex items-center gap-2';
      row.innerHTML =
        '<div class="w-24 text-xs text-neutral-400 text-right truncate capitalize">' + esc(method) + '</div>' +
        '<div class="flex-1 bg-neutral-800 rounded-full h-3 overflow-hidden">' +
          '<div class="bg-indigo-400 h-full rounded-full" style="width:' + pct + '%"></div>' +
        '</div>' +
        '<div class="w-8 text-xs text-neutral-500">' + count + '</div>';
      contactEl.appendChild(row);
    });

    // === PEAK TIMES ===
    var peakEl = document.getElementById('analytics-peak-times');
    peakEl.innerHTML = '';
    var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    var peakDayIdx = a.customer_behaviour.peak_submission_days.indexOf(
      Math.max.apply(null, a.customer_behaviour.peak_submission_days)
    );
    var peakHourIdx = a.customer_behaviour.peak_submission_hours.indexOf(
      Math.max.apply(null, a.customer_behaviour.peak_submission_hours)
    );
    peakEl.innerHTML =
      '<div class="text-white text-sm font-medium">Busiest Day: ' + dayNames[peakDayIdx] + '</div>' +
      '<div class="text-neutral-400 text-xs mt-1">Busiest Hour: ' + (peakHourIdx < 10 ? '0' : '') + peakHourIdx + ':00</div>' +
      '<div class="flex gap-0.5 mt-3">' +
      a.customer_behaviour.peak_submission_days.map(function(count, i) {
        var maxDay = Math.max.apply(null, a.customer_behaviour.peak_submission_days) || 1;
        var h = Math.max(Math.round((count / maxDay) * 40), 2);
        return '<div class="flex flex-col items-center flex-1">' +
          '<div class="bg-lime-400/30 rounded-sm w-full" style="height:' + h + 'px"></div>' +
          '<div class="text-[9px] text-neutral-600 mt-1">' + dayNames[i].charAt(0) + '</div>' +
        '</div>';
      }).join('') +
      '</div>';

    // === TOP POSTCODES ===
    var postcodeEl = document.getElementById('analytics-postcodes');
    postcodeEl.innerHTML = '';
    var postcodes = a.customer_behaviour.top_postcodes;
    var maxPc = postcodes.length > 0 ? postcodes[0].count : 1;
    postcodes.slice(0, 6).forEach(function(pc) {
      var pct = Math.round((pc.count / maxPc) * 100);
      var row = document.createElement('div');
      row.className = 'flex items-center gap-2';
      row.innerHTML =
        '<div class="w-10 text-xs text-white font-mono">' + esc(pc.postcode_area) + '</div>' +
        '<div class="flex-1 bg-neutral-800 rounded-full h-3 overflow-hidden">' +
          '<div class="bg-emerald-500 h-full rounded-full" style="width:' + pct + '%"></div>' +
        '</div>' +
        '<div class="w-6 text-xs text-neutral-500">' + pc.count + '</div>';
      postcodeEl.appendChild(row);
    });

    // === REPEAT RATE ===
    document.getElementById('analytics-repeat-rate').textContent = a.customer_behaviour.repeat_customer_rate + '%';

  } catch (e) { console.error('Analytics error:', e); }
}

async function loadCustomers() {
  try {
    var search = document.getElementById('custSearch').value.trim();
    var sort = document.getElementById('custSort').value;
    var order = (sort === 'name') ? 'asc' : 'desc';

    var params = '?limit=' + custState.limit + '&offset=' + custState.offset + '&sort=' + sort + '&order=' + order;
    if (search) params += '&search=' + encodeURIComponent(search);

    var res = await apiRequest('/admin/customers' + params);
    if (!res.success) return;

    custState.customers = res.data;
    custState.total = res.total;

    var list = document.getElementById('custList');
    var empty = document.getElementById('custEmpty');
    list.innerHTML = '';

    if (res.data.length === 0) {
      empty.classList.remove('hidden');
      document.getElementById('custPagination').classList.add('hidden');
      return;
    }
    empty.classList.add('hidden');

    res.data.forEach(function(c) {
      var card = document.createElement('div');
      card.className = 'bg-neutral-900 border border-neutral-800 rounded-xl p-4 fade-in';

      var tags = (c.tags || []).map(function(t) {
        return '<span class="px-2 py-0.5 rounded text-[10px] font-medium bg-lime-400/10 text-lime-400">' + esc(t) + '</span>';
      }).join('');

      var lastJob = c.last_job_date ? formatDateNice(c.last_job_date) : 'None';

      card.innerHTML =
        '<div class="flex items-start justify-between mb-2">' +
          '<div class="text-white font-semibold text-sm">' + esc(c.name) + '</div>' +
          '<div class="text-lime-400 font-bold text-sm">\u00A3' + Number(c.total_spent || 0).toFixed(0) + '</div>' +
        '</div>' +
        '<div class="text-xs text-neutral-500 mb-1">' +
          (c.phone ? esc(c.phone) : '') +
          (c.phone && c.email ? ' | ' : '') +
          (c.email ? esc(c.email) : '') +
        '</div>' +
        '<div class="text-xs text-neutral-600 mb-2">' + esc(c.address || '') + ' ' + esc(c.postcode || '') + '</div>' +
        '<div class="flex items-center justify-between">' +
          '<div class="flex items-center gap-2">' +
            '<span class="text-[10px] text-neutral-500">' + (c.total_jobs || 0) + ' jobs | Last: ' + lastJob + '</span>' +
            (tags ? '<div class="flex gap-1 ml-2">' + tags + '</div>' : '') +
          '</div>' +
          '<div class="flex gap-2">' +
            '<button onclick="openCustProfile(\'' + c.id + '\')" class="bg-neutral-800 hover:bg-neutral-700 text-neutral-300 px-3 py-1.5 rounded-lg text-xs transition-colors">View Profile</button>' +
            '<button onclick="quickAddJobFromCust(\'' + c.id + '\')" class="bg-lime-400/10 hover:bg-lime-400/20 text-lime-400 px-3 py-1.5 rounded-lg text-xs transition-colors">+ Job</button>' +
          '</div>' +
        '</div>';

      list.appendChild(card);
    });

    // Pagination
    var pag = document.getElementById('custPagination');
    if (custState.total > custState.limit) {
      pag.classList.remove('hidden');
      var from = custState.offset + 1;
      var to = Math.min(custState.offset + custState.limit, custState.total);
      document.getElementById('custPaginationInfo').textContent = from + '-' + to + ' of ' + custState.total;
      document.getElementById('custPrevBtn').disabled = custState.offset === 0;
      document.getElementById('custNextBtn').disabled = (custState.offset + custState.limit) >= custState.total;
    } else {
      pag.classList.add('hidden');
    }
  } catch (e) {
    console.error('Load customers error:', e);
  }
}

function custPrevPage() { custState.offset = Math.max(0, custState.offset - custState.limit); loadCustomers(); }
function custNextPage() { custState.offset += custState.limit; loadCustomers(); }

function formatDateNice(dateStr) {
  if (!dateStr) return '-';
  var d = new Date(dateStr + 'T00:00:00');
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
}

// ============================
// CUSTOMER PROFILE
// ============================
async function openCustProfile(id) {
  try {
    var res = await apiRequest('/admin/customers/' + id);
    if (!res.success) return;

    custState.currentCustomer = res.data;
    var c = res.data;

    document.getElementById('custProfileModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    document.getElementById('cp-avatar').textContent = (c.name || '?').charAt(0).toUpperCase();
    document.getElementById('cp-name').textContent = c.name;
    document.getElementById('cp-since').textContent = 'Customer since ' + formatDateNice(c.created_at ? c.created_at.split('T')[0] : null);
    document.getElementById('cp-total-spent').textContent = '\u00A3' + Number(c.total_spent || 0).toFixed(0);

    document.getElementById('cp-email').textContent = c.email || '-';
    document.getElementById('cp-email').href = c.email ? 'mailto:' + c.email : '#';
    document.getElementById('cp-phone').textContent = c.phone || '-';
    document.getElementById('cp-phone').href = c.phone ? 'tel:' + c.phone : '#';
    document.getElementById('cp-address').textContent = c.address || '-';
    document.getElementById('cp-postcode').textContent = c.postcode || '-';
    document.getElementById('cp-total-jobs').textContent = c.total_jobs || 0;
    document.getElementById('cp-last-job').textContent = formatDateNice(c.last_job_date);
    document.getElementById('cp-last-followup').textContent = c.last_followup_sent_at ? formatDateNice(c.last_followup_sent_at.split('T')[0]) : 'Never';

    // Tags
    renderCustTags(c.tags || []);

    // Job history
    var jobsEl = document.getElementById('cp-jobs');
    var noJobs = document.getElementById('cp-no-jobs');
    jobsEl.innerHTML = '';
    if (c.jobs && c.jobs.length > 0) {
      noJobs.classList.add('hidden');
      c.jobs.forEach(function(j) {
        var payBadge = '';
        if (j.status === 'completed') {
          if (j.payment_status === 'paid') payBadge = '<span class="text-green-400 text-[10px]">Paid</span>';
          else if (j.payment_status === 'outstanding') payBadge = '<span class="text-red-400 text-[10px]">Owed</span>';
          else if (j.payment_status === 'partial') payBadge = '<span class="text-orange-400 text-[10px]">Partial</span>';
        }
        var row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-black/30 rounded-lg px-3 py-2';
        row.innerHTML =
          '<div class="flex items-center gap-3 text-xs">' +
            '<span class="text-neutral-500">' + formatDateNice(j.scheduled_date) + '</span>' +
            '<span class="text-white">' + esc(j.service) + '</span>' +
          '</div>' +
          '<div class="flex items-center gap-3 text-xs">' +
            '<span class="text-lime-400 font-medium">' + (j.job_value ? '\u00A3' + Number(j.job_value).toFixed(0) : '') + '</span>' +
            '<span class="px-2 py-0.5 rounded text-[10px] ' + getJobStatusColor(j.status) + '">' + (j.status || 'scheduled') + '</span>' +
            payBadge +
          '</div>';
        jobsEl.appendChild(row);
      });
    } else {
      noJobs.classList.remove('hidden');
    }

    // Quote history
    var quotesEl = document.getElementById('cp-quotes');
    var noQuotes = document.getElementById('cp-no-quotes');
    quotesEl.innerHTML = '';
    if (c.quotes && c.quotes.length > 0) {
      noQuotes.classList.add('hidden');
      c.quotes.forEach(function(q) {
        var row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-black/30 rounded-lg px-3 py-2';
        row.innerHTML =
          '<div class="flex items-center gap-3 text-xs">' +
            '<span class="text-neutral-500">' + formatDateNice(q.created_at ? q.created_at.split('T')[0] : null) + '</span>' +
            '<span class="text-white">' + (q.services || []).join(', ') + '</span>' +
          '</div>' +
          '<div class="text-xs">' +
            (q.customer_accepted_estimate ? '<span class="text-green-400">Accepted</span>' : '<span class="text-neutral-500">' + (q.status || 'new') + '</span>') +
          '</div>';
        quotesEl.appendChild(row);
      });
    } else {
      noQuotes.classList.remove('hidden');
    }

    // Invoices
    loadCustInvoices(c.id);

    // Notes
    document.getElementById('cp-notes').value = c.admin_notes || '';

    // Hide edit section
    document.getElementById('cp-edit-section').classList.add('hidden');

  } catch (e) {
    showToast('Failed to load customer', 'error');
  }
}

function closeCustProfile() {
  document.getElementById('custProfileModal').classList.add('hidden');
  document.body.style.overflow = '';
  custState.currentCustomer = null;
}

function renderCustTags(tags) {
  var container = document.getElementById('cp-tags');
  container.innerHTML = '';
  tags.forEach(function(t) {
    var span = document.createElement('span');
    span.className = 'inline-flex items-center gap-1 px-2.5 py-1 rounded-lg text-xs font-medium bg-lime-400/10 text-lime-400';
    span.innerHTML = esc(t) + ' <button onclick="removeCustTag(\'' + esc(t) + '\')" class="text-lime-400/60 hover:text-red-400 ml-0.5">&times;</button>';
    container.appendChild(span);
  });
}

async function addCustTag() {
  if (!custState.currentCustomer) return;
  var input = document.getElementById('cp-new-tag');
  var tag = input.value.trim().toLowerCase();
  if (!tag) return;

  var tags = (custState.currentCustomer.tags || []).slice();
  if (tags.indexOf(tag) >= 0) { input.value = ''; return; }
  tags.push(tag);

  var res = await apiRequest('/admin/customers/' + custState.currentCustomer.id, { method: 'PATCH', body: { tags: tags } });
  if (res.success) {
    custState.currentCustomer.tags = tags;
    renderCustTags(tags);
    input.value = '';
    showToast('Tag added', 'success');
  }
}

async function removeCustTag(tag) {
  if (!custState.currentCustomer) return;
  var tags = (custState.currentCustomer.tags || []).filter(function(t) { return t !== tag; });
  var res = await apiRequest('/admin/customers/' + custState.currentCustomer.id, { method: 'PATCH', body: { tags: tags } });
  if (res.success) {
    custState.currentCustomer.tags = tags;
    renderCustTags(tags);
    showToast('Tag removed', 'success');
  }
}

async function saveCustNotes() {
  if (!custState.currentCustomer) return;
  var notes = document.getElementById('cp-notes').value;
  var res = await apiRequest('/admin/customers/' + custState.currentCustomer.id, { method: 'PATCH', body: { admin_notes: notes } });
  if (res.success) {
    custState.currentCustomer.admin_notes = notes;
    showToast('Notes saved', 'success');
  }
}

function toggleEditCustomer() {
  var section = document.getElementById('cp-edit-section');
  var isHidden = section.classList.contains('hidden');
  section.classList.toggle('hidden');
  if (isHidden && custState.currentCustomer) {
    var c = custState.currentCustomer;
    document.getElementById('cp-edit-name').value = c.name || '';
    document.getElementById('cp-edit-email').value = c.email || '';
    document.getElementById('cp-edit-phone').value = c.phone || '';
    document.getElementById('cp-edit-address').value = c.address || '';
    document.getElementById('cp-edit-postcode').value = c.postcode || '';
  }
}

async function saveEditCustomer() {
  if (!custState.currentCustomer) return;
  var body = {
    name: document.getElementById('cp-edit-name').value.trim(),
    email: document.getElementById('cp-edit-email').value.trim(),
    phone: document.getElementById('cp-edit-phone').value.trim(),
    address: document.getElementById('cp-edit-address').value.trim(),
    postcode: document.getElementById('cp-edit-postcode').value.trim()
  };
  var res = await apiRequest('/admin/customers/' + custState.currentCustomer.id, { method: 'PATCH', body: body });
  if (res.success) {
    showToast('Customer updated', 'success');
    closeCustProfile();
    loadCustomers();
  }
}

function addJobFromCustomer() {
  if (!custState.currentCustomer) return;
  var c = custState.currentCustomer;
  closeCustProfile();
  switchTab('schedule');
  setTimeout(function() {
    openAddJobModal();
    document.getElementById('job-customer-id').value = c.id;
    document.getElementById('job-name').value = c.name || '';
    document.getElementById('job-phone').value = c.phone || '';
    document.getElementById('job-email').value = c.email || '';
    document.getElementById('job-address').value = c.address || '';
    document.getElementById('job-postcode').value = c.postcode || '';
  }, 200);
}

function quickAddJobFromCust(custId) {
  // Find customer in loaded list
  var c = custState.customers.find(function(cu) { return cu.id === custId; });
  if (!c) return;
  switchTab('schedule');
  setTimeout(function() {
    openAddJobModal();
    document.getElementById('job-customer-id').value = c.id;
    document.getElementById('job-name').value = c.name || '';
    document.getElementById('job-phone').value = c.phone || '';
    document.getElementById('job-email').value = c.email || '';
    document.getElementById('job-address').value = c.address || '';
    document.getElementById('job-postcode').value = c.postcode || '';
  }, 200);
}

// ============================
// FOLLOW-UP EMAILS
// ============================
var followUpTemplates = {
  seasonal: {
    subject: 'Time for a property refresh?',
    body: 'Hi {name},\n\nIt\'s been a while since your last clean and we wanted to check in.\n\nYour property could benefit from a seasonal refresh - our team is available and ready to bring back that like-new look.\n\nWould you like us to pop round for a quick assessment? Just reply to this email or give us a call.'
  },
  discount: {
    subject: 'Exclusive 10% off for valued customers',
    body: 'Hi {name},\n\nAs a valued customer, we\'d like to offer you 10% off your next service.\n\nWhether it\'s a roof clean, driveway wash, or gutter clearance - mention code REVIVE10 when you book.\n\nThis offer is valid for the next 30 days. We\'d love to help keep your property looking its best!'
  },
  yearly: {
    subject: 'Your annual property maintenance is due',
    body: 'Hi {name},\n\nIt\'s that time of year again! Regular exterior cleaning keeps your property protected and looking great.\n\nWe recommend an annual clean to prevent build-up of moss, algae, and grime that can cause long-term damage.\n\nWould you like us to schedule your annual service? Just let us know a good time.'
  },
  checkin: {
    subject: 'Just checking in - Revive Exterior Cleaning',
    body: 'Hi {name},\n\nHope you\'re well! We just wanted to check in and see if there\'s anything we can help with.\n\nWhether it\'s a one-off clean or regular maintenance, we\'re here to help keep your property in top shape.\n\nFeel free to get in touch anytime.'
  },
  feedback_experience: {
    subject: 'How was your experience with Revive?',
    body: 'Hi {name},\n\nWe hope you were happy with the work we carried out. Your feedback means the world to us and helps us continually improve.\n\nWould you mind letting us know how we did? Just reply to this email with a quick note - we read every response.\n\nThank you for choosing Revive!'
  },
  feedback_price: {
    subject: 'Was it the price? We\'d love your honest feedback',
    body: 'Hi {name},\n\nWe noticed you received a quote from us but didn\'t go ahead. No worries at all - but we\'d love to understand why.\n\nWas it the price? The timing? Or something else entirely?\n\nYour honest feedback helps us serve our customers better. Just hit reply and let us know - even a one-line response would be appreciated.'
  },
  feedback_general: {
    subject: 'Quick question - what could we have done better?',
    body: 'Hi {name},\n\nWe\'re always looking for ways to improve our service. We noticed you enquired with us recently and we\'d love to know if there\'s anything we could have done differently.\n\nWhether it\'s our response time, pricing, communication, or anything else - your feedback helps us get better.\n\nThanks for your time, and we hope to work with you in the future!'
  },
  reengagement_pricing: {
    subject: 'Great news - we\'ve updated our pricing!',
    body: 'Hi {name},\n\nWe wanted to reach out because we\'ve recently updated our pricing to offer even better value.\n\nIf price was a factor when you last enquired, we\'d love the chance to provide you with a fresh quote.\n\nAs a returning enquiry, we can also offer a special discount. Just reply to this email or give us a call and we\'ll get you sorted.'
  }
};

function openFollowUpModal() {
  if (!custState.currentCustomer) return;
  document.getElementById('followUpModal').classList.remove('hidden');
  document.getElementById('fu-recipient').textContent = custState.currentCustomer.name + ' (' + (custState.currentCustomer.email || 'no email') + ')';
  document.getElementById('fu-template').value = '';
  document.getElementById('fu-subject').value = '';
  document.getElementById('fu-body').value = '';
}

function closeFollowUp() {
  document.getElementById('followUpModal').classList.add('hidden');
}

function applyTemplate() {
  var key = document.getElementById('fu-template').value;
  if (!key || !followUpTemplates[key]) return;
  var tmpl = followUpTemplates[key];
  var name = custState.currentCustomer ? custState.currentCustomer.name : '{name}';
  document.getElementById('fu-subject').value = tmpl.subject;
  document.getElementById('fu-body').value = tmpl.body.replace(/\{name\}/g, name);
}

async function sendFollowUpFromModal() {
  if (!custState.currentCustomer) return;
  var subject = document.getElementById('fu-subject').value.trim();
  var body = document.getElementById('fu-body').value.trim();
  if (!subject || !body) { showToast('Please fill in subject and message', 'error'); return; }

  try {
    var res = await apiRequest('/admin/customers/' + custState.currentCustomer.id + '/followup', {
      method: 'POST',
      body: { subject: subject, body: body }
    });
    if (res.success) {
      showToast('Follow-up email sent!', 'success');
      closeFollowUp();
      // Refresh profile to show updated last_followup
      openCustProfile(custState.currentCustomer.id);
    } else {
      showToast('Failed to send email', 'error');
    }
  } catch (e) {
    showToast('Failed to send email', 'error');
  }
}

// ============================
// BULK FOLLOW-UP
// ============================
function openBulkFollowUpModal() {
  document.getElementById('bulkFollowUpModal').classList.remove('hidden');
  document.getElementById('bulk-template').value = '';
  document.getElementById('bulk-subject').value = '';
  document.getElementById('bulk-body').value = '';
  document.getElementById('bulk-filter').value = 'all';
  previewBulkRecipients();
}

function closeBulkFollowUp() {
  document.getElementById('bulkFollowUpModal').classList.add('hidden');
}

function applyBulkTemplate() {
  var key = document.getElementById('bulk-template').value;
  if (!key || !followUpTemplates[key]) return;
  document.getElementById('bulk-subject').value = followUpTemplates[key].subject;
  document.getElementById('bulk-body').value = followUpTemplates[key].body;
}

async function previewBulkRecipients() {
  try {
    var filter = document.getElementById('bulk-filter').value;
    var res = await apiRequest('/admin/customers/bulk-preview?filter=' + filter);
    if (!res.success) return;
    custState.bulkCustomerIds = res.customer_ids;
    document.getElementById('bulk-count').textContent = res.count;
    document.getElementById('bulk-send-btn').textContent = 'Send to ' + res.count + ' customers';
  } catch (e) {
    document.getElementById('bulk-count').textContent = '0';
  }
}

async function sendBulkFollowUp() {
  if (custState.bulkCustomerIds.length === 0) {
    showToast('No customers match the filter', 'error');
    return;
  }
  var subject = document.getElementById('bulk-subject').value.trim();
  var body = document.getElementById('bulk-body').value.trim();
  if (!subject || !body) { showToast('Please fill in subject and message', 'error'); return; }

  document.getElementById('bulk-send-btn').textContent = 'Sending...';
  document.getElementById('bulk-send-btn').disabled = true;

  try {
    var res = await apiRequest('/admin/customers/bulk-followup', {
      method: 'POST',
      body: {
        customer_ids: custState.bulkCustomerIds,
        subject: subject,
        body: body
      }
    });
    if (res.success) {
      showToast('Sent ' + res.results.sent + ' emails' + (res.results.failed > 0 ? ', ' + res.results.failed + ' failed' : ''), 'success');
      closeBulkFollowUp();
      loadCustomers();
    }
  } catch (e) {
    showToast('Failed to send bulk emails', 'error');
  }
  document.getElementById('bulk-send-btn').textContent = 'Send to All';
  document.getElementById('bulk-send-btn').disabled = false;
}

// ============================
// JOB CUSTOMER SEARCH (in Add Job modal)
// ============================
var _jobCustTimer = null;
function debouncedJobCustSearch() {
  clearTimeout(_jobCustTimer);
  _jobCustTimer = setTimeout(jobCustSearch, 250);
}

async function jobCustSearch() {
  var q = document.getElementById('job-cust-search').value.trim();
  var results = document.getElementById('job-cust-results');

  if (q.length < 2) {
    results.classList.add('hidden');
    return;
  }

  try {
    var res = await apiRequest('/admin/customers/search?q=' + encodeURIComponent(q));
    if (!res.success || res.data.length === 0) {
      results.classList.add('hidden');
      return;
    }

    results.innerHTML = '';
    results.classList.remove('hidden');

    res.data.forEach(function(c) {
      var item = document.createElement('div');
      item.className = 'px-3 py-2 hover:bg-neutral-700 cursor-pointer border-b border-neutral-700/50 last:border-0';
      item.innerHTML =
        '<div class="text-sm text-white">' + esc(c.name) + '</div>' +
        '<div class="text-[10px] text-neutral-500">' +
          (c.phone || '') + (c.phone && c.email ? ' | ' : '') + (c.email || '') +
          ' | ' + (c.address || '') + ' ' + (c.postcode || '') +
        '</div>';
      item.onclick = function() {
        document.getElementById('job-customer-id').value = c.id;
        document.getElementById('job-name').value = c.name || '';
        document.getElementById('job-phone').value = c.phone || '';
        document.getElementById('job-email').value = c.email || '';
        document.getElementById('job-address').value = c.address || '';
        document.getElementById('job-postcode').value = c.postcode || '';
        document.getElementById('job-cust-search').value = c.name;
        results.classList.add('hidden');
      };
      results.appendChild(item);
    });
  } catch (e) {
    results.classList.add('hidden');
  }
}

// Close customer search dropdown when clicking elsewhere
document.addEventListener('click', function(e) {
  var results = document.getElementById('job-cust-results');
  var search = document.getElementById('job-cust-search');
  if (results && search && !results.contains(e.target) && e.target !== search) {
    results.classList.add('hidden');
  }
});

// ============================
// INVOICES
// ============================
var invState = {
  invoices: [],
  currentInvoice: null,
  lineItems: [],
  vatRate: 0
};

async function loadInvoices() {
  try {
    var filter = document.getElementById('inv-filter-status').value;
    var url = '/admin/invoices' + (filter ? '?status=' + filter : '');
    var res = await apiRequest(url);
    if (!res.success) return;

    invState.invoices = res.data || [];
    renderInvoiceStats();
    renderInvoiceList();
  } catch (e) {
    console.error('Failed to load invoices:', e);
  }
}

function renderInvoiceStats() {
  var all = invState.invoices;
  // If filtered, load all for stats
  var draft = 0, sent = 0, paid = 0, overdue = 0, totalInvoiced = 0, outstanding = 0;
  all.forEach(function(inv) {
    if (inv.status === 'draft') draft++;
    else if (inv.status === 'sent') { sent++; outstanding += Number(inv.total || 0); }
    else if (inv.status === 'paid') { paid++; totalInvoiced += Number(inv.total || 0); }
    else if (inv.status === 'overdue') { overdue++; outstanding += Number(inv.total || 0); }
    totalInvoiced += (inv.status !== 'paid') ? 0 : 0; // already counted above
  });
  // Recalculate total invoiced as sum of all
  var allTotal = 0;
  all.forEach(function(inv) { allTotal += Number(inv.total || 0); });

  document.getElementById('inv-stat-total').textContent = all.length;
  document.getElementById('inv-stat-draft').textContent = draft;
  document.getElementById('inv-stat-sent').textContent = sent;
  document.getElementById('inv-stat-paid').textContent = paid;
  document.getElementById('inv-stat-outstanding').textContent = '\u00A3' + outstanding.toFixed(0);
  document.getElementById('inv-stat-invoiced').textContent = '\u00A3' + allTotal.toFixed(0);
}

function getInvoiceStatusBadge(status) {
  var map = {
    draft: 'text-neutral-300 bg-neutral-700',
    sent: 'text-orange-300 bg-orange-900/60',
    paid: 'text-green-300 bg-green-900/60',
    overdue: 'text-red-300 bg-red-900/60'
  };
  var cls = map[status] || map.draft;
  return '<span class="px-2 py-0.5 rounded text-[10px] font-medium ' + cls + '">' + capitalize(status || 'draft') + '</span>';
}

function renderInvoiceList() {
  var list = document.getElementById('invoiceList');
  var empty = document.getElementById('invoiceEmpty');
  list.innerHTML = '';

  if (invState.invoices.length === 0) {
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  invState.invoices.forEach(function(inv) {
    var card = document.createElement('div');
    card.className = 'bg-neutral-900 border border-neutral-800 rounded-xl p-4 cursor-pointer hover:border-neutral-700 transition-colors';
    card.onclick = function() { openInvoiceModal(inv.id); };

    var dateStr = inv.created_at ? new Date(inv.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '';

    card.innerHTML =
      '<div class="flex items-center justify-between">' +
        '<div class="flex items-center gap-3">' +
          '<span class="text-lime-400 font-bold text-xs">' + esc(inv.invoice_number) + '</span>' +
          '<span class="text-white text-sm font-medium">' + esc(inv.customer_name) + '</span>' +
          '<span class="text-neutral-500 text-xs hidden sm:inline">' + esc(inv.service || '') + '</span>' +
        '</div>' +
        '<div class="flex items-center gap-3">' +
          '<span class="text-neutral-500 text-xs">' + dateStr + '</span>' +
          '<span class="text-lime-400 font-semibold text-sm">\u00A3' + Number(inv.total || 0).toFixed(2) + '</span>' +
          getInvoiceStatusBadge(inv.status) +
        '</div>' +
      '</div>';

    list.appendChild(card);
  });
}

// Invoice section in job detail modal
async function renderInvoiceSection(job) {
  var section = document.getElementById('jd-invoiceSection');
  var content = document.getElementById('jd-invoiceContent');

  if (job.status !== 'completed') {
    section.classList.add('hidden');
    return;
  }
  section.classList.remove('hidden');
  content.innerHTML = '<div class="text-neutral-500 text-xs">Checking...</div>';

  try {
    var res = await apiRequest('/admin/jobs/' + job.id + '/invoice');
    if (res.success && res.data) {
      var inv = res.data;
      var badge = getInvoiceStatusBadge(inv.status);
      var btns = '';
      if (inv.status === 'draft') {
        btns = '<button onclick="openInvoiceModal(\'' + inv.id + '\')" class="bg-lime-400 hover:bg-lime-300 text-black text-xs font-semibold px-4 py-2 rounded-lg transition-colors w-full">Edit & Send Invoice</button>';
      } else if (inv.status === 'sent') {
        btns =
          '<div class="flex gap-2">' +
            '<button onclick="openInvoiceModal(\'' + inv.id + '\')" class="flex-1 bg-neutral-800 hover:bg-neutral-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors">View/Resend</button>' +
            '<button onclick="markInvoicePaid(\'' + inv.id + '\')" class="flex-1 bg-green-900 hover:bg-green-800 text-green-300 text-xs font-medium px-3 py-2 rounded-lg transition-colors">Mark Paid</button>' +
          '</div>';
      } else if (inv.status === 'paid') {
        btns = '<button onclick="openInvoiceModal(\'' + inv.id + '\')" class="bg-neutral-800 hover:bg-neutral-700 text-white text-xs font-medium px-4 py-2 rounded-lg transition-colors w-full">View Invoice</button>';
      }
      content.innerHTML =
        '<div class="flex items-center justify-between mb-3">' +
          '<span class="text-lime-400 font-semibold text-xs">' + esc(inv.invoice_number) + '</span>' +
          '<div class="flex items-center gap-2">' +
            '<span class="text-white text-sm font-bold">\u00A3' + Number(inv.total).toFixed(2) + '</span>' +
            badge +
          '</div>' +
        '</div>' +
        btns;
    } else {
      content.innerHTML = '<button onclick="generateInvoice()" class="w-full bg-lime-400 hover:bg-lime-300 text-black text-xs font-semibold px-4 py-2.5 rounded-lg transition-colors">Generate Invoice</button>';
    }
  } catch (e) {
    content.innerHTML = '<button onclick="generateInvoice()" class="w-full bg-lime-400 hover:bg-lime-300 text-black text-xs font-semibold px-4 py-2.5 rounded-lg transition-colors">Generate Invoice</button>';
  }
}

async function generateInvoice() {
  if (!schedState.currentJob) return;
  try {
    var res = await apiRequest('/admin/jobs/' + schedState.currentJob.id + '/invoice', { method: 'POST' });
    if (res.success) {
      showToast('Invoice ' + res.data.invoice_number + ' created', 'success');
      renderInvoiceSection(schedState.currentJob);
      openInvoiceModal(res.data.id);
    } else {
      if (res.invoice_id) {
        openInvoiceModal(res.invoice_id);
      } else {
        showToast(res.error || 'Failed to create invoice', 'error');
      }
    }
  } catch (e) {
    showToast('Failed to create invoice', 'error');
  }
}

async function markInvoicePaid(invoiceId) {
  try {
    var res = await apiRequest('/admin/invoices/' + invoiceId, {
      method: 'PATCH',
      body: { status: 'paid', paid_at: new Date().toISOString() }
    });
    if (res.success) {
      showToast('Invoice marked as paid', 'success');
      if (schedState.currentJob) renderInvoiceSection(schedState.currentJob);
      if (currentTab === 'invoices') loadInvoices();
    }
  } catch (e) {
    showToast('Failed to update invoice', 'error');
  }
}

// Invoice modal
async function openInvoiceModal(invoiceId) {
  try {
    var res = await apiRequest('/admin/invoices/' + invoiceId);
    if (!res.success) { showToast('Failed to load invoice', 'error'); return; }

    invState.currentInvoice = res.data;
    var inv = res.data;
    invState.lineItems = Array.isArray(inv.line_items) ? inv.line_items.map(function(li) { return Object.assign({}, li); }) : [];
    invState.vatRate = parseFloat(inv.vat_rate) || 0;

    document.getElementById('invoiceModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    document.getElementById('inv-modal-title').textContent = inv.invoice_number;
    document.getElementById('inv-modal-date').textContent = inv.created_at ? new Date(inv.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : '';
    document.getElementById('inv-modal-customer').textContent = inv.customer_name;
    document.getElementById('inv-modal-address').textContent = (inv.address || '') + (inv.postcode ? ' ' + inv.postcode : '');
    document.getElementById('inv-modal-service').textContent = inv.service || '';
    document.getElementById('inv-modal-terms').value = inv.payment_terms || 'Due on receipt';
    document.getElementById('inv-modal-notes').value = inv.notes || '';

    // Show view button if sent or paid
    var viewBtn = document.getElementById('inv-modal-view-btn');
    if (inv.view_token) {
      viewBtn.classList.remove('hidden');
    } else {
      viewBtn.classList.add('hidden');
    }

    renderInvoiceLineItems();
    setInvoiceVat(invState.vatRate);
  } catch (e) {
    showToast('Failed to load invoice', 'error');
  }
}

function closeInvoiceModal() {
  document.getElementById('invoiceModal').classList.add('hidden');
  document.body.style.overflow = '';
  invState.currentInvoice = null;
}

function renderInvoiceLineItems() {
  var container = document.getElementById('inv-modal-items');
  container.innerHTML = '';

  invState.lineItems.forEach(function(item, idx) {
    var row = document.createElement('div');
    row.className = 'grid grid-cols-12 gap-2 items-center';
    row.innerHTML =
      '<div class="col-span-5"><input type="text" value="' + esc(item.description || '') + '" onchange="updateLineItem(' + idx + ', \'description\', this.value)" class="w-full bg-black border border-neutral-700 text-white text-xs px-2 py-1.5 rounded-lg focus:border-lime-400 focus:outline-none" placeholder="Description"></div>' +
      '<div class="col-span-2"><input type="number" value="' + (item.quantity || 1) + '" min="1" onchange="updateLineItem(' + idx + ', \'quantity\', this.value)" class="w-full bg-black border border-neutral-700 text-white text-xs px-2 py-1.5 rounded-lg focus:border-lime-400 focus:outline-none text-center" placeholder="Qty"></div>' +
      '<div class="col-span-3"><input type="number" value="' + Number(item.unit_price || 0).toFixed(2) + '" step="0.01" min="0" onchange="updateLineItem(' + idx + ', \'unit_price\', this.value)" class="w-full bg-black border border-neutral-700 text-white text-xs px-2 py-1.5 rounded-lg focus:border-lime-400 focus:outline-none text-right" placeholder="Price"></div>' +
      '<div class="col-span-1 text-right text-xs text-lime-400 font-medium">\u00A3' + Number(item.total || 0).toFixed(2) + '</div>' +
      '<div class="col-span-1 text-right"><button onclick="removeLineItem(' + idx + ')" class="text-red-400 hover:text-red-300 text-xs">&times;</button></div>';
    container.appendChild(row);
  });

  recalcInvoiceTotals();
}

function updateLineItem(idx, field, value) {
  if (!invState.lineItems[idx]) return;
  if (field === 'quantity') value = parseInt(value) || 1;
  if (field === 'unit_price') value = parseFloat(value) || 0;
  invState.lineItems[idx][field] = value;
  if (field === 'quantity' || field === 'unit_price') {
    invState.lineItems[idx].total = (invState.lineItems[idx].quantity || 1) * (invState.lineItems[idx].unit_price || 0);
  }
  renderInvoiceLineItems();
}

function removeLineItem(idx) {
  invState.lineItems.splice(idx, 1);
  renderInvoiceLineItems();
}

function addInvoiceLineItem() {
  invState.lineItems.push({ description: '', quantity: 1, unit_price: 0, total: 0 });
  renderInvoiceLineItems();
}

function setInvoiceVat(rate) {
  invState.vatRate = rate;
  document.querySelectorAll('.inv-vat-btn').forEach(function(btn) {
    if (parseInt(btn.getAttribute('data-rate')) === rate) {
      btn.className = 'inv-vat-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-lime-400 text-black ring-2 ring-lime-300';
    } else {
      btn.className = 'inv-vat-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-neutral-800 text-neutral-300 hover:bg-neutral-700';
    }
  });
  recalcInvoiceTotals();
}

function recalcInvoiceTotals() {
  var subtotal = 0;
  invState.lineItems.forEach(function(li) { subtotal += Number(li.total || 0); });
  var vatAmount = subtotal * (invState.vatRate / 100);
  var total = subtotal + vatAmount;

  document.getElementById('inv-modal-subtotal').textContent = '\u00A3' + subtotal.toFixed(2);
  var vatRow = document.getElementById('inv-modal-vat-row');
  if (invState.vatRate > 0) {
    vatRow.classList.remove('hidden');
    document.getElementById('inv-modal-vat-label').textContent = 'VAT (' + invState.vatRate + '%)';
    document.getElementById('inv-modal-vat-amount').textContent = '\u00A3' + vatAmount.toFixed(2);
  } else {
    vatRow.classList.add('hidden');
  }
  document.getElementById('inv-modal-total').textContent = '\u00A3' + total.toFixed(2);
}

async function saveInvoiceDraft() {
  if (!invState.currentInvoice) return;
  var subtotal = 0;
  invState.lineItems.forEach(function(li) { subtotal += Number(li.total || 0); });
  var vatAmount = subtotal * (invState.vatRate / 100);
  var total = subtotal + vatAmount;

  try {
    var res = await apiRequest('/admin/invoices/' + invState.currentInvoice.id, {
      method: 'PATCH',
      body: {
        line_items: invState.lineItems,
        subtotal: subtotal,
        vat_rate: invState.vatRate,
        vat_amount: vatAmount,
        total: total,
        notes: document.getElementById('inv-modal-notes').value || null,
        payment_terms: document.getElementById('inv-modal-terms').value || 'Due on receipt'
      }
    });
    if (res.success) {
      invState.currentInvoice = res.data;
      showToast('Invoice saved', 'success');
      if (currentTab === 'invoices') loadInvoices();
    }
  } catch (e) {
    showToast('Failed to save invoice', 'error');
  }
}

async function sendInvoiceFromModal() {
  if (!invState.currentInvoice) return;
  // Save first
  await saveInvoiceDraft();

  try {
    var res = await apiRequest('/admin/invoices/' + invState.currentInvoice.id + '/send', { method: 'POST' });
    if (res.success) {
      invState.currentInvoice = res.data;
      showToast('Invoice sent to ' + (invState.currentInvoice.customer_email || 'customer'), 'success');
      closeInvoiceModal();
      if (schedState.currentJob) renderInvoiceSection(schedState.currentJob);
      if (currentTab === 'invoices') loadInvoices();
    } else {
      showToast(res.error || 'Failed to send invoice', 'error');
    }
  } catch (e) {
    showToast('Failed to send invoice', 'error');
  }
}

function viewInvoicePublic() {
  if (!invState.currentInvoice || !invState.currentInvoice.view_token) return;
  window.open(window.location.origin + '/invoice/' + invState.currentInvoice.view_token, '_blank');
}

// Customer profile invoice history
async function loadCustInvoices(customerId) {
  var container = document.getElementById('cp-invoices');
  var empty = document.getElementById('cp-no-invoices');
  container.innerHTML = '';

  try {
    var res = await apiRequest('/admin/invoices?customer_id=' + customerId);
    if (!res.success || !res.data || res.data.length === 0) {
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    res.data.forEach(function(inv) {
      var row = document.createElement('div');
      row.className = 'flex items-center justify-between bg-black/30 rounded-lg px-3 py-2 cursor-pointer hover:bg-black/50 transition-colors';
      row.onclick = function() { openInvoiceModal(inv.id); };
      row.innerHTML =
        '<div class="flex items-center gap-3 text-xs">' +
          '<span class="text-lime-400 font-semibold">' + esc(inv.invoice_number) + '</span>' +
          '<span class="text-neutral-500">' + formatDateNice(inv.created_at ? inv.created_at.split('T')[0] : null) + '</span>' +
          '<span class="text-white">' + esc(inv.service || '') + '</span>' +
        '</div>' +
        '<div class="flex items-center gap-3 text-xs">' +
          '<span class="text-lime-400 font-medium">\u00A3' + Number(inv.total || 0).toFixed(2) + '</span>' +
          getInvoiceStatusBadge(inv.status) +
        '</div>';
      container.appendChild(row);
    });
  } catch (e) {
    empty.classList.remove('hidden');
  }
}

// ============================
// HELPERS
// ============================

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ============================
// CHATS TAB
// ============================

var chatState = { conversations: [] };

async function loadChats() {
  try {
    var filter = document.getElementById('chat-filter').value;
    var url = '/admin/chats?limit=100';
    if (filter === 'leads') url += '&leadOnly=true';

    var res = await apiRequest(url);
    if (!res.success) return;

    chatState.conversations = res.data || [];
    renderChatStats();
    renderChatList();
  } catch (e) {
    console.error('Failed to load chats:', e);
  }
}

function renderChatStats() {
  var all = chatState.conversations;
  var leads = all.filter(function(c) { return c.lead_captured; });
  var today = new Date().toISOString().split('T')[0];
  var todayCount = all.filter(function(c) { return c.created_at && c.created_at.startsWith(today); }).length;
  var conversion = all.length > 0 ? Math.round((leads.length / all.length) * 100) : 0;

  document.getElementById('chat-stat-total').textContent = all.length;
  document.getElementById('chat-stat-leads').textContent = leads.length;
  document.getElementById('chat-stat-today').textContent = todayCount;
  document.getElementById('chat-stat-conversion').textContent = conversion + '%';
  document.getElementById('chatResultCount').textContent = all.length + ' conversation' + (all.length !== 1 ? 's' : '');
}

function renderChatList() {
  var list = document.getElementById('chatList');
  var empty = document.getElementById('chatEmpty');
  list.innerHTML = '';

  if (chatState.conversations.length === 0) {
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  chatState.conversations.forEach(function(conv) {
    var timeAgo = relativeTime(conv.last_message_at);
    var preview = getChatPreview(conv);

    var card = document.createElement('div');
    card.className = 'bg-neutral-900 border border-neutral-800 rounded-xl p-4 cursor-pointer hover:border-neutral-700 transition-colors';
    card.onclick = function() { openChatModal(conv); };

    card.innerHTML =
      '<div class="flex items-center justify-between mb-2">' +
        '<div class="flex items-center gap-2">' +
          (conv.lead_captured
            ? '<span class="w-2 h-2 rounded-full bg-lime-400"></span><span class="text-lime-400 text-xs font-semibold">' + escapeHtml(conv.customer_name || 'Lead') + '</span>'
            : '<span class="w-2 h-2 rounded-full bg-neutral-600"></span><span class="text-neutral-400 text-xs">Anonymous</span>') +
        '</div>' +
        '<span class="text-neutral-600 text-[10px]">' + timeAgo + '</span>' +
      '</div>' +
      '<p class="text-neutral-500 text-xs truncate">' + escapeHtml(preview) + '</p>' +
      '<div class="flex items-center gap-3 mt-2">' +
        '<span class="text-neutral-600 text-[10px]">' + (conv.message_count || 0) + ' messages</span>' +
        (conv.customer_email ? '<span class="text-neutral-600 text-[10px]">' + escapeHtml(conv.customer_email) + '</span>' : '') +
        (conv.customer_postcode ? '<span class="text-neutral-600 text-[10px]">' + escapeHtml(conv.customer_postcode) + '</span>' : '') +
      '</div>';

    list.appendChild(card);
  });
}

function getChatPreview(conv) {
  if (!conv.messages || conv.messages.length === 0) return 'No messages';
  // Find last user message for preview
  for (var i = conv.messages.length - 1; i >= 0; i--) {
    if (conv.messages[i].role === 'user' && typeof conv.messages[i].content === 'string') {
      return conv.messages[i].content.substring(0, 100);
    }
  }
  var last = conv.messages[conv.messages.length - 1];
  return (typeof last.content === 'string' ? last.content : '').substring(0, 100);
}

function openChatModal(conv) {
  document.getElementById('chatModal').classList.remove('hidden');
  document.getElementById('chatModal-title').textContent = conv.customer_name || 'Anonymous Conversation';
  document.getElementById('chatModal-meta').textContent = (conv.message_count || 0) + ' messages \u2022 ' + relativeTime(conv.first_message_at);

  var container = document.getElementById('chatModal-messages');
  container.innerHTML = '';

  (conv.messages || []).forEach(function(msg) {
    var content = typeof msg.content === 'string' ? msg.content : '';
    if (!content) return;
    var div = document.createElement('div');
    var isUser = msg.role === 'user';
    div.className = 'p-3 rounded-lg text-xs leading-relaxed ' + (isUser ? 'bg-lime-400/10 text-lime-300 ml-8' : 'bg-neutral-800 text-neutral-300 mr-8');
    div.textContent = content;
    container.appendChild(div);
  });

  var leadSection = document.getElementById('chatModal-lead');
  if (conv.lead_captured) {
    leadSection.classList.remove('hidden');
    var info = [conv.customer_name, conv.customer_email, conv.customer_phone, conv.customer_postcode].filter(Boolean).join(' \u2022 ');
    document.getElementById('chatModal-leadInfo').textContent = info;
  } else {
    leadSection.classList.add('hidden');
  }
}

function closeChatModal() {
  document.getElementById('chatModal').classList.add('hidden');
}

// ============================
// SETTINGS TAB
// ============================

var settingsState = {
  config: null,
  defaults: null,
  source: 'defaults',
  loaded: false
};

var DEFAULT_SERVICES = ['roof', 'driveway', 'gutter', 'softwash', 'render', 'window', 'solar', 'other'];

var SERVICE_LABELS = {
  roof: 'Roof Cleaning',
  driveway: 'Driveway',
  gutter: 'Gutter Cleaning',
  softwash: 'Soft Wash',
  render: 'Render Cleaning',
  window: 'Window Cleaning',
  solar: 'Solar Panel',
  other: 'Other'
};

function getServiceLabel(key) {
  return SERVICE_LABELS[key] || key.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
}

var MODIFIER_LABELS = {
  firstTimeCleaning: 'First Time Cleaning',
  heavilySoiled: 'Heavily Soiled',
  difficultAccess: 'Difficult Access',
  heightWork: 'Height Work',
  urgent: 'Urgent Request'
};

var SCORING_LABELS = {
  baseScore: 'Base Score',
  highValueThreshold: 'High Value Threshold (£)',
  highValueBonus: 'High Value Bonus',
  veryHighValueThreshold: 'Very High Value (£)',
  veryHighValueBonus: 'Very High Value Bonus',
  multipleServicesBonus: '2 Services Bonus',
  manyServicesBonus: '3+ Services Bonus',
  remindersOptIn: 'Reminders Opt-In',
  phonePreferred: 'Phone Preferred',
  emailPreferred: 'Email Preferred',
  commercialProperty: 'Commercial Property',
  urgentLanguage: 'Urgent Language'
};

async function loadSettings() {
  try {
    var res = await apiRequest('/admin/settings/pricing');
    if (res.success) {
      settingsState.config = res.data;
      settingsState.defaults = res.defaults;
      settingsState.source = res.source;
      settingsState.loaded = true;
      renderSettings();
      loadPricingHistory();
    }
  } catch (e) {
    showToast('Failed to load settings', 'error');
  }
}

function renderSettings() {
  var c = settingsState.config;
  if (!c) return;

  // Source badge
  var badge = document.getElementById('settings-source-badge');
  if (settingsState.source === 'database') {
    badge.textContent = 'Custom';
    badge.className = 'text-[10px] uppercase tracking-wider px-2 py-1 rounded-full border text-lime-400 border-lime-400/30 bg-lime-400/10';
  } else {
    badge.textContent = 'Defaults';
    badge.className = 'text-[10px] uppercase tracking-wider px-2 py-1 rounded-full border text-neutral-500 border-neutral-700';
  }

  renderPricingTable(c.servicePricing);
  renderModifiers(c.modifiers);
  renderMultiDiscount(c.multiServiceDiscount);
  renderLeadScoring(c.leadScoring, c.qualificationThresholds, c.conversionFactors);
}

function renderPricingTable(pricing) {
  var tbody = document.getElementById('pricing-table-body');
  var html = '';

  // Build service list: defaults first, then any custom services from config
  var services = DEFAULT_SERVICES.slice();
  Object.keys(pricing).forEach(function(svc) {
    if (services.indexOf(svc) === -1) services.push(svc);
  });

  services.forEach(function(svc) {
    var isCustom = DEFAULT_SERVICES.indexOf(svc) === -1;
    var p = pricing[svc] || { small: [0, 0], medium: [0, 0], large: [0, 0] };
    html += '<tr class="border-b border-neutral-800/50">';
    html += '<td class="py-2 pr-3 text-neutral-300 font-medium text-xs whitespace-nowrap">';
    html += '<span>' + escapeHtml(getServiceLabel(svc)) + '</span>';
    if (isCustom) {
      html += ' <button onclick="removeCustomService(\'' + svc + '\')" class="text-neutral-600 hover:text-red-400 ml-1 transition-colors" title="Remove service">';
      html += '<svg class="w-3.5 h-3.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
      html += '</button>';
    }
    html += '</td>';

    ['small', 'medium', 'large'].forEach(function(size) {
      var range = p[size] || [0, 0];
      html += '<td class="py-2 px-1"><input type="number" min="0" step="5" value="' + range[0] + '" data-service="' + svc + '" data-size="' + size + '" data-idx="0" class="pricing-input w-full bg-black border border-neutral-700 text-white text-xs px-2 py-1.5 rounded-lg focus:border-lime-400 focus:outline-none text-center" style="max-width:80px"></td>';
      html += '<td class="py-2 px-1"><input type="number" min="0" step="5" value="' + range[1] + '" data-service="' + svc + '" data-size="' + size + '" data-idx="1" class="pricing-input w-full bg-black border border-neutral-700 text-white text-xs px-2 py-1.5 rounded-lg focus:border-lime-400 focus:outline-none text-center" style="max-width:80px"></td>';
    });

    html += '</tr>';
  });

  tbody.innerHTML = html;

  // Also update test estimate service dropdown
  updateTestServiceDropdown(services);
}

function renderModifiers(modifiers) {
  var grid = document.getElementById('modifiers-grid');
  var html = '';

  Object.keys(MODIFIER_LABELS).forEach(function(key) {
    var pct = Math.round((modifiers[key] - 1) * 100);
    if (key === 'multipleServices') pct = Math.round((1 - modifiers[key]) * 100);
    html += '<div>';
    html += '<label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">' + MODIFIER_LABELS[key] + '</label>';
    html += '<div class="flex items-center gap-2 mt-1">';
    html += '<input type="number" min="0" max="100" step="1" value="' + pct + '" id="mod-' + key + '" class="w-full bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">';
    html += '<span class="text-neutral-500 text-xs">%</span>';
    html += '</div>';
    html += '</div>';
  });

  grid.innerHTML = html;
}

function renderMultiDiscount(msd) {
  document.getElementById('settings-msd-threshold').value = msd.threshold;
  document.getElementById('settings-msd-discount').value = Math.round((1 - msd.discount) * 100);
}

function renderLeadScoring(scoring, thresholds, conversion) {
  // Scoring weights
  var grid = document.getElementById('lead-scoring-grid');
  var html = '';
  Object.keys(SCORING_LABELS).forEach(function(key) {
    html += '<div>';
    html += '<label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">' + SCORING_LABELS[key] + '</label>';
    html += '<input type="number" min="0" value="' + (scoring[key] || 0) + '" id="ls-' + key + '" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">';
    html += '</div>';
  });
  grid.innerHTML = html;

  // Qualification thresholds
  var qGrid = document.getElementById('qualification-grid');
  var qHtml = '';
  ['hot', 'warm', 'cold'].forEach(function(level) {
    var colors = { hot: 'text-red-400', warm: 'text-orange-400', cold: 'text-blue-400' };
    qHtml += '<div>';
    qHtml += '<label class="text-[10px] uppercase tracking-wider font-semibold ' + colors[level] + '">' + capitalize(level) + ' Lead</label>';
    qHtml += '<input type="number" min="0" max="100" value="' + (thresholds[level] || 0) + '" id="qt-' + level + '" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">';
    qHtml += '</div>';
  });
  qGrid.innerHTML = qHtml;

  // Conversion factors
  var cGrid = document.getElementById('conversion-grid');
  var cHtml = '';
  var cfLabels = { hotLead: 'Hot', warmLead: 'Warm', coldLead: 'Cold', unqualified: 'Unqualified' };
  Object.keys(cfLabels).forEach(function(key) {
    cHtml += '<div>';
    cHtml += '<label class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold">' + cfLabels[key] + '</label>';
    cHtml += '<input type="number" min="0" max="1" step="0.05" value="' + (conversion[key] || 0) + '" id="cf-' + key + '" class="w-full mt-1 bg-black border border-neutral-700 text-white text-sm px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">';
    cHtml += '</div>';
  });
  cGrid.innerHTML = cHtml;
}

function toggleSettingsSection(section) {
  var el = document.getElementById('section-' + section);
  var chevron = document.getElementById('chevron-' + section);
  if (el.classList.contains('hidden')) {
    el.classList.remove('hidden');
    chevron.classList.remove('rotate-180');
  } else {
    el.classList.add('hidden');
    chevron.classList.add('rotate-180');
  }
}

function collectPricingFromUI() {
  var servicePricing = {};
  var inputs = document.querySelectorAll('.pricing-input');
  inputs.forEach(function(input) {
    var svc = input.dataset.service;
    var size = input.dataset.size;
    var idx = parseInt(input.dataset.idx);
    if (!servicePricing[svc]) servicePricing[svc] = {};
    if (!servicePricing[svc][size]) servicePricing[svc][size] = [0, 0];
    servicePricing[svc][size][idx] = parseFloat(input.value) || 0;
  });

  // Add default = medium for each service
  Object.keys(servicePricing).forEach(function(svc) {
    servicePricing[svc].default = servicePricing[svc].medium;
  });

  return servicePricing;
}

function collectModifiersFromUI() {
  var modifiers = {};
  Object.keys(MODIFIER_LABELS).forEach(function(key) {
    var el = document.getElementById('mod-' + key);
    if (el) {
      var pct = parseFloat(el.value) || 0;
      modifiers[key] = 1 + (pct / 100);
    }
  });
  // Keep multipleServices from existing config (it's handled by multi-service discount)
  modifiers.multipleServices = settingsState.config.modifiers.multipleServices || 0.9;
  return modifiers;
}

function collectMultiDiscountFromUI() {
  var threshold = parseInt(document.getElementById('settings-msd-threshold').value) || 3;
  var discountPct = parseFloat(document.getElementById('settings-msd-discount').value) || 10;
  return {
    threshold: threshold,
    discount: 1 - (discountPct / 100)
  };
}

function collectLeadScoringFromUI() {
  var scoring = {};
  Object.keys(SCORING_LABELS).forEach(function(key) {
    var el = document.getElementById('ls-' + key);
    if (el) scoring[key] = parseFloat(el.value) || 0;
  });
  return scoring;
}

function collectQualificationFromUI() {
  return {
    hot: parseInt(document.getElementById('qt-hot').value) || 75,
    warm: parseInt(document.getElementById('qt-warm').value) || 50,
    cold: parseInt(document.getElementById('qt-cold').value) || 30
  };
}

function collectConversionFromUI() {
  var factors = {};
  ['hotLead', 'warmLead', 'coldLead', 'unqualified'].forEach(function(key) {
    var el = document.getElementById('cf-' + key);
    if (el) factors[key] = parseFloat(el.value) || 0;
  });
  return factors;
}

async function savePricingSettings() {
  try {
    var body = {
      servicePricing: collectPricingFromUI(),
      modifiers: collectModifiersFromUI(),
      multiServiceDiscount: collectMultiDiscountFromUI(),
      leadScoring: collectLeadScoringFromUI(),
      qualificationThresholds: collectQualificationFromUI(),
      conversionFactors: collectConversionFromUI()
    };

    var res = await apiRequest('/admin/settings/pricing', {
      method: 'PUT',
      body: body
    });

    if (res.success) {
      showToast('Pricing settings saved', 'success');
      loadSettings();
    } else {
      showToast(res.error || 'Failed to save', 'error');
    }
  } catch (e) {
    showToast('Failed to save settings', 'error');
  }
}

async function resetPricingSettings() {
  if (!confirm('Reset all pricing settings to file defaults? This cannot be undone.')) return;

  try {
    var res = await apiRequest('/admin/settings/pricing/reset', { method: 'POST', body: {} });
    if (res.success) {
      showToast('Settings reset to defaults', 'success');
      loadSettings();
    }
  } catch (e) {
    showToast('Failed to reset settings', 'error');
  }
}

function addCustomService() {
  var input = document.getElementById('new-service-name');
  var errEl = document.getElementById('add-service-error');
  var name = input.value.trim();
  errEl.classList.add('hidden');

  if (!name) {
    errEl.textContent = 'Enter a service name';
    errEl.classList.remove('hidden');
    return;
  }

  // Generate key from name: lowercase, replace spaces/special chars with underscores
  var key = name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');

  if (!key) {
    errEl.textContent = 'Invalid service name';
    errEl.classList.remove('hidden');
    return;
  }

  // Check if already exists
  var existing = document.querySelector('.pricing-input[data-service="' + key + '"]');
  if (existing) {
    errEl.textContent = 'Service "' + name + '" already exists';
    errEl.classList.remove('hidden');
    return;
  }

  // Add label for this custom service
  SERVICE_LABELS[key] = name;

  // Get current pricing from config and add the new service
  var currentPricing = collectPricingFromUI();
  currentPricing[key] = { small: [0, 0], medium: [0, 0], large: [0, 0], default: [0, 0] };

  // Re-render the table with the new service
  renderPricingTable(currentPricing);

  input.value = '';
  showToast('Service added — set prices and click Save', 'success');
}

function removeCustomService(key) {
  if (DEFAULT_SERVICES.indexOf(key) !== -1) return; // Can't remove defaults

  if (!confirm('Remove "' + getServiceLabel(key) + '" from the pricing table?')) return;

  // Collect current pricing, remove the service, re-render
  var currentPricing = collectPricingFromUI();
  delete currentPricing[key];
  delete SERVICE_LABELS[key];

  renderPricingTable(currentPricing);
  showToast('Service removed — click Save to confirm', 'success');
}

function updateTestServiceDropdown(services) {
  var select = document.getElementById('test-service');
  if (!select) return;
  var currentVal = select.value;

  var html = '';
  services.forEach(function(svc) {
    var sel = svc === currentVal ? ' selected' : '';
    html += '<option value="' + svc + '"' + sel + '>' + escapeHtml(getServiceLabel(svc)) + '</option>';
  });
  select.innerHTML = html;
}

async function runTestEstimate() {
  try {
    var service = document.getElementById('test-service').value;
    var size = document.getElementById('test-size').value;
    var modifiers = {
      firstTimeCleaning: document.getElementById('test-mod-first').checked,
      heavilySoiled: document.getElementById('test-mod-soiled').checked,
      difficultAccess: document.getElementById('test-mod-access').checked,
      heightWork: document.getElementById('test-mod-height').checked,
      urgent: document.getElementById('test-mod-urgent').checked
    };

    var res = await apiRequest('/admin/settings/pricing/test-estimate', {
      method: 'POST',
      body: { services: [service], size: size, modifiers: modifiers }
    });

    if (res.success && res.data) {
      var result = document.getElementById('test-estimate-result');
      var reasons = res.data.modifierReasons.length > 0 ? ' (' + res.data.modifierReasons.join(', ') + ')' : '';
      result.innerHTML = '<span class="text-lime-400 text-lg font-bold">&pound;' + res.data.min + ' &mdash; &pound;' + res.data.max + '</span><span class="text-neutral-500 text-xs ml-2">' + escapeHtml(reasons) + '</span>';
    }
  } catch (e) {
    showToast('Failed to calculate test estimate', 'error');
  }
}

async function loadPricingHistory() {
  try {
    var res = await apiRequest('/admin/settings/pricing/history');
    if (res.success && res.data && res.data.length > 0) {
      var list = document.getElementById('pricing-history-list');
      var html = '';
      res.data.forEach(function(entry) {
        var section = (entry.changed_section || '').replace(/_/g, ' ');
        var time = relativeTime(entry.created_at);
        html += '<div class="bg-black border border-neutral-800 rounded-lg p-3">';
        html += '<div class="flex items-center justify-between">';
        html += '<span class="text-neutral-300 text-xs font-medium">' + capitalize(section) + '</span>';
        html += '<span class="text-neutral-600 text-[10px]">' + time + '</span>';
        html += '</div>';
        html += '<p class="text-neutral-500 text-xs mt-1">' + escapeHtml(entry.description || '') + '</p>';
        html += '</div>';
      });
      list.innerHTML = html;
    }
  } catch (e) {
    // Silently fail
  }
}

// ============================
// ADD CUSTOMER MODAL
// ============================

function openAddCustomerModal() {
  document.getElementById('ac-name').value = '';
  document.getElementById('ac-email').value = '';
  document.getElementById('ac-phone').value = '';
  document.getElementById('ac-address').value = '';
  document.getElementById('ac-postcode').value = '';
  document.getElementById('ac-tags').value = '';
  document.getElementById('ac-notes').value = '';
  document.getElementById('ac-error').classList.add('hidden');
  document.getElementById('ac-save-btn').disabled = false;
  document.getElementById('ac-save-btn').textContent = 'Save';
  document.getElementById('addCustomerModal').classList.remove('hidden');
}

function closeAddCustomerModal() {
  document.getElementById('addCustomerModal').classList.add('hidden');
}

async function saveNewCustomer() {
  var name = document.getElementById('ac-name').value.trim();
  if (!name) {
    document.getElementById('ac-error').textContent = 'Name is required';
    document.getElementById('ac-error').classList.remove('hidden');
    return;
  }

  var tagsRaw = document.getElementById('ac-tags').value.trim();
  var tags = tagsRaw ? tagsRaw.split(',').map(function(t) { return t.trim(); }).filter(Boolean) : [];

  var btn = document.getElementById('ac-save-btn');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  document.getElementById('ac-error').classList.add('hidden');

  try {
    var res = await apiRequest('/admin/customers', {
      method: 'POST',
      body: {
        name: name,
        email: document.getElementById('ac-email').value.trim() || null,
        phone: document.getElementById('ac-phone').value.trim() || null,
        address: document.getElementById('ac-address').value.trim() || null,
        postcode: document.getElementById('ac-postcode').value.trim() || null,
        tags: tags,
        admin_notes: document.getElementById('ac-notes').value.trim() || null
      }
    });

    if (res.success) {
      closeAddCustomerModal();
      showToast('Customer added successfully', 'success');
      loadCustomers();
    } else {
      var errEl = document.getElementById('ac-error');
      errEl.textContent = res.error || 'Failed to create customer';
      if (res.existingId) {
        errEl.innerHTML = res.error + ' <a href="#" onclick="closeAddCustomerModal(); openCustProfile(\'' + res.existingId + '\'); return false;" class="text-lime-400 underline ml-1">View profile</a>';
      }
      errEl.classList.remove('hidden');
      btn.disabled = false;
      btn.textContent = 'Save';
    }
  } catch (e) {
    document.getElementById('ac-error').textContent = 'Failed to create customer';
    document.getElementById('ac-error').classList.remove('hidden');
    btn.disabled = false;
    btn.textContent = 'Save';
  }
}

// ============================
// IMPORT CSV MODAL
// ============================

var csvState = { headers: [], rows: [], mappings: {} };

function openImportCsvModal() {
  resetCsvImport();
  document.getElementById('importCsvModal').classList.remove('hidden');
}

function closeImportCsvModal() {
  document.getElementById('importCsvModal').classList.add('hidden');
}

function resetCsvImport() {
  csvState = { headers: [], rows: [], mappings: {} };
  document.getElementById('csv-file-input').value = '';
  document.getElementById('csv-step-upload').classList.remove('hidden');
  document.getElementById('csv-step-mapping').classList.add('hidden');
  document.getElementById('csv-step-results').classList.add('hidden');
}

function parseCsvText(text) {
  var rows = [];
  var row = [];
  var field = '';
  var inQuotes = false;
  var i = 0;

  while (i < text.length) {
    var ch = text[i];

    if (inQuotes) {
      if (ch === '"') {
        if (text[i + 1] === '"') {
          field += '"';
          i += 2;
        } else {
          inQuotes = false;
          i++;
        }
      } else {
        field += ch;
        i++;
      }
    } else {
      if (ch === '"') {
        inQuotes = true;
        i++;
      } else if (ch === ',') {
        row.push(field.trim());
        field = '';
        i++;
      } else if (ch === '\n' || ch === '\r') {
        row.push(field.trim());
        if (row.some(function(f) { return f.length > 0; })) rows.push(row);
        row = [];
        field = '';
        if (ch === '\r' && text[i + 1] === '\n') i++;
        i++;
      } else {
        field += ch;
        i++;
      }
    }
  }
  // Last field/row
  row.push(field.trim());
  if (row.some(function(f) { return f.length > 0; })) rows.push(row);

  return rows;
}

var FIELD_OPTIONS = [
  { value: '', label: 'Skip' },
  { value: 'name', label: 'Name' },
  { value: 'email', label: 'Email' },
  { value: 'phone', label: 'Phone' },
  { value: 'address', label: 'Address' },
  { value: 'postcode', label: 'Postcode' },
  { value: 'tags', label: 'Tags' },
  { value: 'admin_notes', label: 'Notes' }
];

var HEADER_MAP = {
  'name': 'name', 'full name': 'name', 'fullname': 'name', 'customer name': 'name', 'customer': 'name', 'client': 'name', 'client name': 'name', 'first name': 'name', 'firstname': 'name',
  'email': 'email', 'e-mail': 'email', 'email address': 'email', 'e-mail address': 'email',
  'phone': 'phone', 'telephone': 'phone', 'tel': 'phone', 'mobile': 'phone', 'phone number': 'phone', 'mobile number': 'phone', 'cell': 'phone', 'contact number': 'phone',
  'address': 'address', 'street': 'address', 'street address': 'address', 'address line 1': 'address', 'address1': 'address', 'full address': 'address',
  'postcode': 'postcode', 'post code': 'postcode', 'zip': 'postcode', 'zip code': 'postcode', 'zipcode': 'postcode', 'postal code': 'postcode',
  'tags': 'tags', 'tag': 'tags', 'category': 'tags', 'type': 'tags',
  'notes': 'admin_notes', 'note': 'admin_notes', 'admin notes': 'admin_notes', 'comments': 'admin_notes', 'comment': 'admin_notes'
};

function autoDetectMapping(header) {
  var key = header.toLowerCase().trim();
  return HEADER_MAP[key] || '';
}

function handleCsvFile(input) {
  var file = input.files[0];
  if (!file) return;

  var reader = new FileReader();
  reader.onload = function(e) {
    var text = e.target.result;
    var allRows = parseCsvText(text);

    if (allRows.length < 2) {
      showToast('CSV file must have a header row and at least one data row', 'error');
      return;
    }

    csvState.headers = allRows[0];
    csvState.rows = allRows.slice(1);
    csvState.mappings = {};

    // Auto-detect column mappings
    var usedFields = new Set();
    csvState.headers.forEach(function(h, idx) {
      var detected = autoDetectMapping(h);
      if (detected && !usedFields.has(detected)) {
        csvState.mappings[idx] = detected;
        usedFields.add(detected);
      } else {
        csvState.mappings[idx] = '';
      }
    });

    renderCsvMapping();

    document.getElementById('csv-step-upload').classList.add('hidden');
    document.getElementById('csv-step-mapping').classList.remove('hidden');
  };
  reader.readAsText(file);
}

function renderCsvMapping() {
  var container = document.getElementById('csv-mapping-table');
  document.getElementById('csv-row-count').textContent = csvState.rows.length + ' rows found';

  var html = '';
  csvState.headers.forEach(function(h, idx) {
    html += '<div class="flex items-center gap-3 bg-neutral-800 rounded-lg px-3 py-2">';
    html += '<span class="text-white text-xs flex-1 truncate">' + escapeHtml(h) + '</span>';
    html += '<svg class="w-4 h-4 text-neutral-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>';
    html += '<select onchange="csvState.mappings[' + idx + ']=this.value; updateCsvPreview()" class="bg-neutral-700 border border-neutral-600 text-white text-xs px-2 py-1.5 rounded-lg focus:border-lime-400 focus:outline-none w-28">';
    FIELD_OPTIONS.forEach(function(opt) {
      var sel = csvState.mappings[idx] === opt.value ? ' selected' : '';
      html += '<option value="' + opt.value + '"' + sel + '>' + opt.label + '</option>';
    });
    html += '</select>';
    html += '</div>';
  });
  container.innerHTML = html;

  updateCsvPreview();
}

function updateCsvPreview() {
  // Get mapped field names
  var mappedFields = [];
  csvState.headers.forEach(function(h, idx) {
    var field = csvState.mappings[idx];
    if (field) {
      mappedFields.push({ idx: idx, field: field });
    }
  });

  // Header row
  var headHtml = '<tr>';
  mappedFields.forEach(function(m) {
    var label = FIELD_OPTIONS.find(function(f) { return f.value === m.field; });
    headHtml += '<th class="text-left text-neutral-500 text-[10px] uppercase tracking-wider pb-2 pr-4">' + (label ? label.label : m.field) + '</th>';
  });
  headHtml += '</tr>';
  document.getElementById('csv-preview-head').innerHTML = headHtml;

  // Data rows (first 5)
  var bodyHtml = '';
  var previewRows = csvState.rows.slice(0, 5);
  previewRows.forEach(function(row) {
    bodyHtml += '<tr class="border-t border-neutral-800">';
    mappedFields.forEach(function(m) {
      bodyHtml += '<td class="text-white text-xs py-1.5 pr-4 truncate max-w-[150px]">' + escapeHtml(row[m.idx] || '') + '</td>';
    });
    bodyHtml += '</tr>';
  });
  document.getElementById('csv-preview-body').innerHTML = bodyHtml;
}

async function executeCsvImport() {
  // Build customer objects from mappings
  var mappedFields = [];
  csvState.headers.forEach(function(h, idx) {
    var field = csvState.mappings[idx];
    if (field) mappedFields.push({ idx: idx, field: field });
  });

  // Check that name is mapped
  var hasName = mappedFields.some(function(m) { return m.field === 'name'; });
  if (!hasName) {
    showToast('You must map at least one column to "Name"', 'error');
    return;
  }

  var customers = csvState.rows.map(function(row) {
    var obj = {};
    mappedFields.forEach(function(m) {
      obj[m.field] = row[m.idx] || '';
    });
    return obj;
  });

  var btn = document.getElementById('csv-import-btn');
  btn.disabled = true;
  btn.textContent = 'Importing...';

  try {
    var res = await apiRequest('/admin/customers/import', {
      method: 'POST',
      body: { customers: customers, skipDuplicates: true }
    });

    if (res.success) {
      document.getElementById('csv-step-mapping').classList.add('hidden');
      document.getElementById('csv-step-results').classList.remove('hidden');

      document.getElementById('csv-result-imported').textContent = res.summary.imported;
      document.getElementById('csv-result-skipped').textContent = res.summary.skipped;
      document.getElementById('csv-result-errors').textContent = res.summary.errors;

      // Show details
      var detailsHtml = '';
      if (res.details.skipped && res.details.skipped.length > 0) {
        res.details.skipped.forEach(function(s) {
          detailsHtml += '<div class="text-amber-400 text-xs bg-neutral-800 rounded px-3 py-1.5">Row ' + s.row + ': ' + escapeHtml(s.reason) + '</div>';
        });
      }
      if (res.details.errors && res.details.errors.length > 0) {
        res.details.errors.forEach(function(e) {
          detailsHtml += '<div class="text-red-400 text-xs bg-neutral-800 rounded px-3 py-1.5">Row ' + e.row + ': ' + escapeHtml(e.reason) + '</div>';
        });
      }
      document.getElementById('csv-result-details').innerHTML = detailsHtml || '<div class="text-lime-400 text-xs">All rows imported successfully!</div>';
    } else {
      showToast(res.error || 'Import failed', 'error');
      btn.disabled = false;
      btn.textContent = 'Import Customers';
    }
  } catch (e) {
    showToast('Import failed', 'error');
    btn.disabled = false;
    btn.textContent = 'Import Customers';
  }
}

// ============================
// INIT
// ============================
checkAuth();
</script>

</body>
</html>
