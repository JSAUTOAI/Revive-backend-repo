<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Revive Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Poppins', sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a0a; }
    ::-webkit-scrollbar-thumb { background: #262626; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #404040; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .pulse-dot { animation: pulse-dot 1.5s ease-in-out infinite; }
  </style>
</head>
<body class="bg-black text-neutral-300 min-h-screen">

<!-- ============ LOGIN SCREEN ============ -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-8 max-w-sm w-full fade-in">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 rounded-full bg-lime-400 flex items-center justify-center text-black font-bold text-lg">R</div>
      <div>
        <h1 class="text-white text-lg font-semibold tracking-tight">REVIVE Admin</h1>
        <p class="text-neutral-500 text-xs">Quote Management Dashboard</p>
      </div>
    </div>
    <input type="password" id="tokenInput" placeholder="Enter admin token"
      class="w-full bg-black border border-neutral-700 text-white px-4 py-3 rounded-lg text-sm focus:border-lime-400 focus:outline-none transition-colors"
      onkeydown="if(event.key==='Enter')login()">
    <button onclick="login()"
      class="w-full mt-4 bg-lime-400 hover:bg-lime-300 text-black font-semibold py-3 rounded-lg text-sm transition-colors">
      Access Dashboard
    </button>
    <div id="loginError" class="hidden mt-3 text-red-400 text-xs text-center"></div>
  </div>
</div>

<!-- ============ DASHBOARD ============ -->
<div id="dashboard" class="hidden">

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-black/90 backdrop-blur-xl border-b border-neutral-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-lime-400 flex items-center justify-center text-black font-bold text-sm">R</div>
        <h1 class="text-white text-sm font-semibold tracking-tight">REVIVE <span class="text-neutral-500 font-light">Admin</span></h1>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="exportCSV()" class="hidden sm:flex items-center gap-2 bg-neutral-900 border border-neutral-700 hover:border-lime-400 text-neutral-300 hover:text-white px-4 py-2 rounded-lg text-xs font-medium transition-colors">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          Export CSV
        </button>
        <button onclick="logout()" class="text-neutral-500 hover:text-white text-xs transition-colors">Logout</button>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">

    <!-- Stats Bar -->
    <div id="statsBar" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Total</div>
        <div class="text-xl font-bold text-white mt-1" id="stat-total">-</div>
      </div>
      <div class="bg-neutral-900 border border-red-900/40 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider flex items-center gap-1.5">
          <span class="w-1.5 h-1.5 rounded-full bg-red-400 pulse-dot"></span>Hot
        </div>
        <div class="text-xl font-bold text-red-400 mt-1" id="stat-hot">-</div>
      </div>
      <div class="bg-neutral-900 border border-orange-900/40 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider flex items-center gap-1.5">
          <span class="w-1.5 h-1.5 rounded-full bg-orange-400"></span>Warm
        </div>
        <div class="text-xl font-bold text-orange-400 mt-1" id="stat-warm">-</div>
      </div>
      <div class="bg-neutral-900 border border-blue-900/40 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider flex items-center gap-1.5">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>Cold
        </div>
        <div class="text-xl font-bold text-blue-400 mt-1" id="stat-cold">-</div>
      </div>
      <div class="bg-neutral-900 border border-lime-900/40 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Avg Estimate</div>
        <div class="text-xl font-bold text-lime-400 mt-1" id="stat-avg">-</div>
      </div>
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="text-neutral-500 text-[10px] uppercase tracking-wider">Accepted</div>
        <div class="text-xl font-bold text-white mt-1" id="stat-accepted">-</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap-3 mb-4">
      <select id="filter-status" onchange="applyFilters()" class="bg-neutral-900 border border-neutral-700 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        <option value="">All Leads</option>
        <option value="hot">Hot</option>
        <option value="warm">Warm</option>
        <option value="cold">Cold</option>
        <option value="unqualified">Unqualified</option>
      </select>
      <select id="filter-service" onchange="applyFilters()" class="bg-neutral-900 border border-neutral-700 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        <option value="">All Services</option>
        <option value="roof">Roof</option>
        <option value="driveway">Driveway</option>
        <option value="gutter">Gutter</option>
        <option value="softwash">Softwash</option>
        <option value="render">Render</option>
        <option value="window">Window</option>
        <option value="solar">Solar Panel</option>
      </select>
      <select id="filter-sort" onchange="applyFilters()" class="bg-neutral-900 border border-neutral-700 text-neutral-300 text-xs px-3 py-2 rounded-lg focus:border-lime-400 focus:outline-none">
        <option value="created_at:desc">Newest First</option>
        <option value="created_at:asc">Oldest First</option>
        <option value="lead_score:desc">Highest Score</option>
        <option value="estimated_value_max:desc">Highest Value</option>
      </select>
      <button onclick="exportCSV()" class="sm:hidden flex items-center gap-2 bg-neutral-900 border border-neutral-700 text-neutral-300 px-3 py-2 rounded-lg text-xs">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3"/></svg>
        CSV
      </button>
      <div class="ml-auto text-neutral-500 text-xs" id="resultCount"></div>
    </div>

    <!-- Loading -->
    <div id="tableLoading" class="hidden text-center py-12">
      <div class="inline-flex items-center gap-2 text-neutral-500 text-sm">
        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
        Loading quotes...
      </div>
    </div>

    <!-- Quotes Table (desktop) -->
    <div id="quotesTable" class="hidden sm:block bg-neutral-900 border border-neutral-800 rounded-xl overflow-hidden">
      <table class="w-full">
        <thead>
          <tr class="border-b border-neutral-800 text-left">
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider">Lead</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider">Customer</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider hidden lg:table-cell">Services</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider">Estimate</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider hidden md:table-cell">Score</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider">Status</th>
            <th class="px-4 py-3 text-[10px] font-semibold text-neutral-500 uppercase tracking-wider hidden md:table-cell">Date</th>
          </tr>
        </thead>
        <tbody id="quotesTableBody"></tbody>
      </table>
    </div>

    <!-- Quotes Cards (mobile) -->
    <div id="quotesCards" class="sm:hidden space-y-3"></div>

    <!-- Empty state -->
    <div id="emptyState" class="hidden text-center py-16">
      <div class="text-neutral-600 text-sm">No quotes found</div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="hidden flex items-center justify-between mt-4">
      <button onclick="prevPage()" id="prevBtn" class="flex items-center gap-1 bg-neutral-900 border border-neutral-700 text-neutral-400 hover:text-white px-4 py-2 rounded-lg text-xs transition-colors disabled:opacity-30 disabled:cursor-not-allowed">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        Previous
      </button>
      <span class="text-neutral-500 text-xs" id="pageInfo"></span>
      <button onclick="nextPage()" id="nextBtn" class="flex items-center gap-1 bg-neutral-900 border border-neutral-700 text-neutral-400 hover:text-white px-4 py-2 rounded-lg text-xs transition-colors disabled:opacity-30 disabled:cursor-not-allowed">
        Next
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- ============ QUOTE DETAIL MODAL ============ -->
<div id="quoteModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-8 overflow-y-auto" onclick="if(event.target===this)closeModal()">
  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl max-w-3xl w-full fade-in my-4">

    <!-- Modal Header -->
    <div class="sticky top-0 bg-neutral-900 border-b border-neutral-800 px-6 py-4 rounded-t-2xl flex items-center justify-between z-10">
      <div class="flex items-center gap-3">
        <div id="modal-qual-badge" class="w-3 h-3 rounded-full"></div>
        <h2 class="text-white font-semibold text-sm" id="modal-name"></h2>
      </div>
      <button onclick="closeModal()" class="text-neutral-500 hover:text-white transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>

    <div class="p-6 space-y-6">

      <!-- Customer Info + Preferences -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div>
          <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Customer</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-neutral-500">Name</span><span class="text-white" id="modal-fullname"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Email</span><a class="text-lime-400 hover:underline" id="modal-email"></a></div>
            <div class="flex justify-between"><span class="text-neutral-500">Phone</span><a class="text-lime-400 hover:underline" id="modal-phone"></a></div>
            <div class="flex justify-between"><span class="text-neutral-500">Address</span><span class="text-white" id="modal-address"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Postcode</span><span class="text-white" id="modal-postcode"></span></div>
          </div>
        </div>
        <div>
          <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Preferences</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-neutral-500">Contact via</span><span class="text-white" id="modal-contact"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Best time</span><span class="text-white" id="modal-time"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Reminders</span><span class="text-white" id="modal-reminders"></span></div>
            <div class="flex justify-between"><span class="text-neutral-500">Accepted</span><span id="modal-accepted"></span></div>
          </div>
        </div>
      </div>

      <!-- Estimate Card -->
      <div class="bg-black border border-neutral-800 rounded-xl p-4">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-3">
          <div id="modal-services" class="flex flex-wrap gap-1.5"></div>
          <div class="text-right">
            <div class="text-[10px] text-neutral-500 uppercase">Estimate</div>
            <div class="text-2xl font-bold text-lime-400" id="modal-estimate"></div>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-4 text-xs">
          <div><span class="text-neutral-500">Score </span><span class="text-white font-semibold" id="modal-score"></span></div>
          <div><span class="text-neutral-500">Confidence </span><span class="text-white" id="modal-confidence"></span></div>
          <div><span class="text-neutral-500">Qualification </span><span id="modal-qualification"></span></div>
        </div>
      </div>

      <!-- Status Update -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Status</h3>
        <div class="flex flex-wrap gap-2" id="statusButtons"></div>
      </div>

      <!-- Admin Notes -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Admin Notes</h3>
        <textarea id="modal-notes" rows="3"
          class="w-full bg-black border border-neutral-700 text-white text-sm px-4 py-3 rounded-lg resize-none focus:border-lime-400 focus:outline-none transition-colors"
          placeholder="Add notes..."></textarea>
        <button onclick="saveNotes()" class="mt-2 bg-lime-400 hover:bg-lime-300 text-black text-xs font-semibold px-4 py-2 rounded-lg transition-colors">
          Save Notes
        </button>
      </div>

      <!-- Timeline -->
      <div>
        <h3 class="text-[10px] uppercase tracking-wider text-neutral-500 font-semibold mb-3">Timeline</h3>
        <div class="space-y-2 text-xs" id="modal-timeline"></div>
      </div>

      <!-- Form Answers -->
      <details class="bg-black border border-neutral-800 rounded-xl">
        <summary class="px-4 py-3 text-xs font-semibold text-neutral-400 cursor-pointer hover:text-white transition-colors">View Full Form Data</summary>
        <pre id="modal-answers" class="px-4 pb-4 text-[11px] text-neutral-500 overflow-x-auto whitespace-pre-wrap"></pre>
      </details>
    </div>
  </div>
</div>

<!-- ============ TOAST ============ -->
<div id="toast" class="fixed top-4 right-4 z-[60] hidden fade-in">
  <div class="bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-3 shadow-xl flex items-center gap-3 max-w-sm">
    <div id="toast-icon"></div>
    <div id="toast-msg" class="text-sm text-neutral-300"></div>
  </div>
</div>

<script>
// ============================
// STATE
// ============================
var state = {
  token: null,
  quotes: [],
  currentQuote: null,
  pagination: { total: 0, limit: 50, offset: 0, hasMore: false }
};

var API_BASE = window.location.origin;

// ============================
// AUTH
// ============================
function checkAuth() {
  var saved = localStorage.getItem('revive_admin_token');
  if (saved) {
    state.token = saved;
    validateToken();
  }
}

async function login() {
  var input = document.getElementById('tokenInput');
  var token = input.value.trim();
  if (!token) return;

  try {
    var res = await apiRequest('/admin/quotes?limit=1', { token: token });
    if (res.success) {
      state.token = token;
      localStorage.setItem('revive_admin_token', token);
      showDashboard();
    }
  } catch (e) {
    var err = document.getElementById('loginError');
    err.textContent = 'Invalid token. Please try again.';
    err.classList.remove('hidden');
    input.value = '';
    input.focus();
  }
}

async function validateToken() {
  try {
    var res = await apiRequest('/admin/quotes?limit=1');
    if (res.success) showDashboard();
    else throw new Error();
  } catch (e) {
    localStorage.removeItem('revive_admin_token');
    state.token = null;
  }
}

function logout() {
  localStorage.removeItem('revive_admin_token');
  state.token = null;
  location.reload();
}

function showDashboard() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  loadStats();
  loadQuotes();
}

// ============================
// API
// ============================
async function apiRequest(endpoint, opts) {
  opts = opts || {};
  var token = opts.token || state.token;
  var res = await fetch(API_BASE + endpoint, {
    method: opts.method || 'GET',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json'
    },
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });

  if (res.status === 401) {
    logout();
    throw new Error('Unauthorized');
  }

  if (!res.ok) throw new Error('Request failed');
  return res.json();
}

// ============================
// STATS
// ============================
async function loadStats() {
  try {
    var res = await apiRequest('/admin/quotes?limit=200&sort=created_at&order=desc');
    if (!res.success) return;

    var quotes = res.data;
    var hot = 0, warm = 0, cold = 0, totalEst = 0, estCount = 0, accepted = 0;

    quotes.forEach(function(q) {
      if (q.qualification_status === 'hot') hot++;
      else if (q.qualification_status === 'warm') warm++;
      else if (q.qualification_status === 'cold') cold++;

      if (q.estimated_value_min && q.estimated_value_max) {
        totalEst += (q.estimated_value_min + q.estimated_value_max) / 2;
        estCount++;
      }
      if (q.customer_accepted_estimate) accepted++;
    });

    var total = res.pagination.total;
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-hot').textContent = hot;
    document.getElementById('stat-warm').textContent = warm;
    document.getElementById('stat-cold').textContent = cold;
    document.getElementById('stat-avg').textContent = estCount > 0 ? '\u00A3' + Math.round(totalEst / estCount) : '-';
    document.getElementById('stat-accepted').textContent = accepted;
  } catch (e) {
    console.error('Failed to load stats:', e);
  }
}

// ============================
// QUOTES TABLE
// ============================
async function loadQuotes() {
  var loading = document.getElementById('tableLoading');
  var table = document.getElementById('quotesTable');
  var cards = document.getElementById('quotesCards');
  var empty = document.getElementById('emptyState');
  var pag = document.getElementById('pagination');

  loading.classList.remove('hidden');
  table.classList.add('hidden');
  cards.classList.add('hidden');
  empty.classList.add('hidden');
  pag.classList.add('hidden');

  try {
    var statusFilter = document.getElementById('filter-status').value;
    var serviceFilter = document.getElementById('filter-service').value;
    var sortVal = document.getElementById('filter-sort').value.split(':');

    var params = '?limit=' + state.pagination.limit + '&offset=' + state.pagination.offset;
    params += '&sort=' + sortVal[0] + '&order=' + sortVal[1];
    if (statusFilter) params += '&status=' + statusFilter;
    if (serviceFilter) params += '&service=' + serviceFilter;

    var res = await apiRequest('/admin/quotes' + params);
    loading.classList.add('hidden');

    if (!res.success || res.data.length === 0) {
      empty.classList.remove('hidden');
      document.getElementById('resultCount').textContent = '0 results';
      return;
    }

    state.quotes = res.data;
    state.pagination = res.pagination;

    renderTable(res.data);
    renderCards(res.data);

    table.classList.remove('hidden');
    cards.classList.remove('hidden');

    document.getElementById('resultCount').textContent = res.pagination.total + ' total';

    // Pagination
    if (res.pagination.total > res.pagination.limit) {
      pag.classList.remove('hidden');
      pag.classList.add('flex');
      var page = Math.floor(state.pagination.offset / state.pagination.limit) + 1;
      var totalPages = Math.ceil(res.pagination.total / res.pagination.limit);
      document.getElementById('pageInfo').textContent = 'Page ' + page + ' of ' + totalPages;
      document.getElementById('prevBtn').disabled = state.pagination.offset === 0;
      document.getElementById('nextBtn').disabled = !res.pagination.hasMore;
    }

  } catch (e) {
    loading.classList.add('hidden');
    empty.classList.remove('hidden');
    console.error('Failed to load quotes:', e);
  }
}

function renderTable(quotes) {
  var tbody = document.getElementById('quotesTableBody');
  tbody.innerHTML = '';

  quotes.forEach(function(q) {
    var tr = document.createElement('tr');
    tr.className = 'border-b border-neutral-800/50 hover:bg-neutral-800/30 cursor-pointer transition-colors ' + getRowBorder(q.qualification_status);
    tr.onclick = function() { openModal(q.id); };

    var services = Array.isArray(q.services) ? q.services.map(capitalize).join(', ') : '';
    var estimate = formatEstimate(q.estimated_value_min, q.estimated_value_max);

    tr.innerHTML =
      '<td class="px-4 py-3">' + qualBadge(q.qualification_status) + '</td>' +
      '<td class="px-4 py-3"><div class="text-sm text-white font-medium">' + esc(q.name) + '</div><div class="text-[11px] text-neutral-500">' + esc(q.email) + '</div></td>' +
      '<td class="px-4 py-3 hidden lg:table-cell"><div class="text-xs text-neutral-400">' + esc(services) + '</div></td>' +
      '<td class="px-4 py-3"><div class="text-sm font-semibold text-lime-400">' + estimate + '</div></td>' +
      '<td class="px-4 py-3 hidden md:table-cell">' + scoreBadge(q.lead_score) + '</td>' +
      '<td class="px-4 py-3">' + statusBadge(q.status) + '</td>' +
      '<td class="px-4 py-3 hidden md:table-cell"><div class="text-xs text-neutral-500">' + formatDate(q.created_at) + '</div></td>';

    tbody.appendChild(tr);
  });
}

function renderCards(quotes) {
  var container = document.getElementById('quotesCards');
  container.innerHTML = '';

  quotes.forEach(function(q) {
    var services = Array.isArray(q.services) ? q.services.map(capitalize).join(', ') : '';
    var estimate = formatEstimate(q.estimated_value_min, q.estimated_value_max);

    var div = document.createElement('div');
    div.className = 'bg-neutral-900 border border-neutral-800 rounded-xl p-4 cursor-pointer hover:border-neutral-700 transition-colors ' + getCardBorder(q.qualification_status);
    div.onclick = function() { openModal(q.id); };

    div.innerHTML =
      '<div class="flex items-center justify-between mb-2">' +
        '<div class="flex items-center gap-2">' + qualBadge(q.qualification_status) + '<span class="text-sm text-white font-medium">' + esc(q.name) + '</span></div>' +
        statusBadge(q.status) +
      '</div>' +
      '<div class="text-xs text-neutral-500 mb-2">' + esc(services) + '</div>' +
      '<div class="flex items-center justify-between">' +
        '<span class="text-sm font-semibold text-lime-400">' + estimate + '</span>' +
        '<span class="text-xs text-neutral-500">' + formatDate(q.created_at) + '</span>' +
      '</div>';

    container.appendChild(div);
  });
}

// ============================
// PAGINATION
// ============================
function applyFilters() {
  state.pagination.offset = 0;
  loadQuotes();
}

function prevPage() {
  state.pagination.offset = Math.max(0, state.pagination.offset - state.pagination.limit);
  loadQuotes();
}

function nextPage() {
  state.pagination.offset += state.pagination.limit;
  loadQuotes();
}

// ============================
// QUOTE DETAIL MODAL
// ============================
async function openModal(id) {
  document.getElementById('quoteModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  try {
    var res = await apiRequest('/admin/quotes/' + id);
    if (!res.success) { closeModal(); return; }

    var q = res.data;
    state.currentQuote = q;

    // Header
    document.getElementById('modal-name').textContent = q.name;
    document.getElementById('modal-qual-badge').className = 'w-3 h-3 rounded-full ' + qualColor(q.qualification_status);

    // Customer
    document.getElementById('modal-fullname').textContent = q.name || '-';
    var emailEl = document.getElementById('modal-email');
    emailEl.textContent = q.email || '-';
    emailEl.href = q.email ? 'mailto:' + q.email : '#';
    var phoneEl = document.getElementById('modal-phone');
    phoneEl.textContent = q.phone || '-';
    phoneEl.href = q.phone ? 'tel:' + q.phone : '#';
    document.getElementById('modal-address').textContent = q.address_line1 || '-';
    document.getElementById('modal-postcode').textContent = q.postcode || '-';

    // Preferences
    document.getElementById('modal-contact').textContent = capitalize(q.preferred_contact || '-');
    document.getElementById('modal-time').textContent = capitalize(q.best_time || '-');
    document.getElementById('modal-reminders').textContent = q.reminders_ok ? 'Yes' : 'No';
    var acceptedEl = document.getElementById('modal-accepted');
    if (q.customer_accepted_estimate) {
      acceptedEl.innerHTML = '<span class="text-lime-400 font-semibold">Yes</span>';
    } else {
      acceptedEl.innerHTML = '<span class="text-neutral-500">No</span>';
    }

    // Services
    var servicesDiv = document.getElementById('modal-services');
    servicesDiv.innerHTML = '';
    if (Array.isArray(q.services)) {
      q.services.forEach(function(s) {
        servicesDiv.innerHTML += '<span class="bg-neutral-800 text-neutral-300 px-2 py-0.5 rounded text-[11px]">' + esc(capitalize(s)) + '</span>';
      });
    }

    // Estimate
    document.getElementById('modal-estimate').textContent = formatEstimate(q.estimated_value_min, q.estimated_value_max);
    document.getElementById('modal-score').textContent = q.lead_score || '-';
    document.getElementById('modal-confidence').textContent = capitalize(q.estimation_confidence || '-');

    var qualEl = document.getElementById('modal-qualification');
    qualEl.innerHTML = qualBadge(q.qualification_status);

    // Status buttons
    renderStatusButtons(q.status);

    // Notes
    document.getElementById('modal-notes').value = q.admin_notes || '';

    // Timeline
    renderTimeline(q);

    // Answers
    document.getElementById('modal-answers').textContent = q.answers ? JSON.stringify(q.answers, null, 2) : 'No form data';

  } catch (e) {
    console.error('Failed to load quote:', e);
    closeModal();
    showToast('Failed to load quote details', 'error');
  }
}

function closeModal() {
  document.getElementById('quoteModal').classList.add('hidden');
  document.body.style.overflow = '';
  state.currentQuote = null;
}

function renderStatusButtons(currentStatus) {
  var statuses = ['new', 'contacted', 'quoted', 'booked', 'completed', 'cancelled'];
  var colors = {
    'new': 'bg-neutral-700 hover:bg-neutral-600',
    'contacted': 'bg-blue-900 hover:bg-blue-800',
    'quoted': 'bg-orange-900 hover:bg-orange-800',
    'booked': 'bg-lime-900 hover:bg-lime-800',
    'completed': 'bg-green-900 hover:bg-green-800',
    'cancelled': 'bg-red-900 hover:bg-red-800'
  };
  var activeColors = {
    'new': 'bg-neutral-600 ring-2 ring-neutral-400',
    'contacted': 'bg-blue-700 ring-2 ring-blue-400',
    'quoted': 'bg-orange-700 ring-2 ring-orange-400',
    'booked': 'bg-lime-700 ring-2 ring-lime-400',
    'completed': 'bg-green-700 ring-2 ring-green-400',
    'cancelled': 'bg-red-700 ring-2 ring-red-400'
  };

  var container = document.getElementById('statusButtons');
  container.innerHTML = '';

  statuses.forEach(function(s) {
    var isActive = s === currentStatus;
    var btn = document.createElement('button');
    btn.className = 'px-3 py-1.5 rounded-lg text-xs text-white font-medium transition-all ' + (isActive ? activeColors[s] : colors[s]);
    btn.textContent = capitalize(s);
    if (!isActive) {
      btn.onclick = function() { updateStatus(s); };
    }
    container.appendChild(btn);
  });
}

async function updateStatus(newStatus) {
  if (!state.currentQuote) return;
  try {
    var res = await apiRequest('/admin/quotes/' + state.currentQuote.id + '/status', {
      method: 'PATCH',
      body: { status: newStatus }
    });
    if (res.success) {
      state.currentQuote.status = newStatus;
      renderStatusButtons(newStatus);
      loadQuotes();
      showToast('Status updated to ' + capitalize(newStatus), 'success');
    }
  } catch (e) {
    showToast('Failed to update status', 'error');
  }
}

async function saveNotes() {
  if (!state.currentQuote) return;
  var notes = document.getElementById('modal-notes').value;
  try {
    var res = await apiRequest('/admin/quotes/' + state.currentQuote.id + '/notes', {
      method: 'PATCH',
      body: { notes: notes }
    });
    if (res.success) {
      showToast('Notes saved', 'success');
    }
  } catch (e) {
    showToast('Failed to save notes', 'error');
  }
}

function renderTimeline(q) {
  var container = document.getElementById('modal-timeline');
  var events = [];

  if (q.created_at) events.push({ label: 'Quote submitted', time: q.created_at, color: 'bg-neutral-600' });
  if (q.confirmation_email_sent_at) events.push({ label: 'Confirmation email sent', time: q.confirmation_email_sent_at, color: 'bg-blue-500' });
  if (q.estimated_at) events.push({ label: 'Estimate calculated', time: q.estimated_at, color: 'bg-lime-500' });
  if (q.estimate_email_sent_at) events.push({ label: 'Estimate email sent', time: q.estimate_email_sent_at, color: 'bg-blue-500' });
  if (q.customer_accepted_at) events.push({ label: 'Customer accepted estimate', time: q.customer_accepted_at, color: 'bg-green-500' });
  if (q.last_contact_at) events.push({ label: 'Last contact', time: q.last_contact_at, color: 'bg-orange-500' });

  events.sort(function(a, b) { return new Date(a.time) - new Date(b.time); });

  container.innerHTML = '';
  if (events.length === 0) {
    container.innerHTML = '<div class="text-neutral-600">No timeline events</div>';
    return;
  }

  events.forEach(function(ev) {
    container.innerHTML +=
      '<div class="flex items-center gap-3">' +
        '<div class="w-2 h-2 rounded-full ' + ev.color + ' flex-shrink-0"></div>' +
        '<span class="text-neutral-400">' + esc(ev.label) + '</span>' +
        '<span class="text-neutral-600 ml-auto">' + formatDateTime(ev.time) + '</span>' +
      '</div>';
  });
}

// ============================
// EXPORT
// ============================
async function exportCSV() {
  try {
    var params = '';
    var statusFilter = document.getElementById('filter-status').value;
    var serviceFilter = document.getElementById('filter-service').value;
    if (statusFilter) params += (params ? '&' : '?') + 'status=' + statusFilter;
    if (serviceFilter) params += (params ? '&' : '?') + 'service=' + serviceFilter;

    var res = await fetch(API_BASE + '/admin/export' + params, {
      headers: { 'Authorization': 'Bearer ' + state.token }
    });

    if (!res.ok) {
      var errData = await res.json().catch(function() { return {}; });
      showToast(errData.error || 'Export failed', 'error');
      return;
    }

    var blob = await res.blob();
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'revive-quotes-' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    showToast('CSV exported', 'success');
  } catch (e) {
    showToast('Export failed', 'error');
  }
}

// ============================
// TOAST
// ============================
function showToast(msg, type) {
  var toast = document.getElementById('toast');
  var icon = document.getElementById('toast-icon');
  var msgEl = document.getElementById('toast-msg');

  if (type === 'success') {
    icon.innerHTML = '<svg class="w-4 h-4 text-lime-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
  } else {
    icon.innerHTML = '<svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
  }

  msgEl.textContent = msg;
  toast.classList.remove('hidden');

  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(function() {
    toast.classList.add('hidden');
  }, 3000);
}

// ============================
// HELPERS
// ============================
function esc(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function capitalize(str) {
  if (!str) return '';
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function formatEstimate(min, max) {
  if (!min && !max) return '-';
  return '\u00A3' + Math.round(min || 0) + '-\u00A3' + Math.round(max || 0);
}

function formatDate(ts) {
  if (!ts) return '-';
  var d = new Date(ts);
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

function formatDateTime(ts) {
  if (!ts) return '-';
  var d = new Date(ts);
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + ' ' + d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
}

function qualColor(status) {
  var map = { hot: 'bg-red-400', warm: 'bg-orange-400', cold: 'bg-blue-400', unqualified: 'bg-neutral-600' };
  return map[status] || 'bg-neutral-600';
}

function qualBadge(status) {
  var colors = { hot: 'text-red-400 bg-red-400/10', warm: 'text-orange-400 bg-orange-400/10', cold: 'text-blue-400 bg-blue-400/10', unqualified: 'text-neutral-400 bg-neutral-400/10' };
  var c = colors[status] || colors.unqualified;
  var label = capitalize(status || 'unqualified');
  return '<span class="px-2 py-0.5 rounded text-[10px] font-semibold ' + c + '">' + label + '</span>';
}

function statusBadge(status) {
  var colors = {
    'new': 'text-neutral-300 bg-neutral-700',
    'contacted': 'text-blue-300 bg-blue-900/60',
    'quoted': 'text-orange-300 bg-orange-900/60',
    'booked': 'text-lime-300 bg-lime-900/60',
    'completed': 'text-green-300 bg-green-900/60',
    'cancelled': 'text-red-300 bg-red-900/60'
  };
  var c = colors[status] || colors['new'];
  return '<span class="px-2 py-0.5 rounded text-[10px] font-medium ' + c + '">' + capitalize(status || 'new') + '</span>';
}

function scoreBadge(score) {
  if (!score && score !== 0) return '<span class="text-xs text-neutral-600">-</span>';
  var color = 'text-neutral-400';
  if (score >= 75) color = 'text-red-400';
  else if (score >= 50) color = 'text-orange-400';
  else if (score >= 30) color = 'text-blue-400';
  return '<span class="text-sm font-bold ' + color + '">' + score + '</span>';
}

function getRowBorder(status) {
  var map = { hot: 'border-l-2 border-l-red-500', warm: 'border-l-2 border-l-orange-500', cold: 'border-l-2 border-l-blue-500' };
  return map[status] || '';
}

function getCardBorder(status) {
  var map = { hot: 'border-l-2 border-l-red-500', warm: 'border-l-2 border-l-orange-500', cold: 'border-l-2 border-l-blue-500' };
  return map[status] || '';
}

// ============================
// INIT
// ============================
checkAuth();
</script>

</body>
</html>
